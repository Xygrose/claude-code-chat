<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>The Control Room</title>

	<!-- Premium Typography -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@500;600;700&display=swap"
		rel="stylesheet">

	<style>
		/* ========================================
       CSS Variables - Control Room Theme
       ======================================== */
		:root {
			/* ====== PREMIUM DARK PALETTE ====== */
			/* Base colors - deeper, richer darks */
			--cr-bg-base: #0f0f12;
			/* Deep charcoal */
			--cr-bg-surface: #1a1a1f;
			/* Rich dark surface */
			--cr-bg-surface-dark: #0a0a0c;
			/* Near black for code */
			--cr-bg-elevated: #222228;
			/* Elevated elements */
			--cr-bg-glass: rgba(26, 26, 31, 0.7);
			/* Glassmorphism base */
			--cr-bg-hover: rgba(255, 255, 255, 0.05);

			/* Text colors */
			--cr-text-primary: #f4f4f5;
			/* zinc-100 */
			--cr-text-secondary: #a1a1aa;
			/* zinc-400 */
			--cr-text-muted: #71717a;
			/* zinc-500 */

			/* ====== BURNT AMBER ACCENT ====== */
			--cr-accent: #D97706;
			/* amber-600 - primary */
			--cr-accent-hover: #F59E0B;
			/* amber-500 - hover */
			--cr-accent-glow: rgba(217, 119, 6, 0.4);
			--cr-accent-muted: rgba(217, 119, 6, 0.15);
			--cr-accent-subtle: rgba(217, 119, 6, 0.08);

			/* Secondary accent - Cyan for tools */
			--cr-secondary: #06B6D4;
			/* cyan-500 */
			--cr-secondary-glow: rgba(6, 182, 212, 0.3);

			/* Gradients */
			--cr-gradient-accent: linear-gradient(135deg, #F59E0B 0%, #D97706 50%, #B45309 100%);
			--cr-gradient-header: linear-gradient(180deg, rgba(217, 119, 6, 0.08) 0%, transparent 100%);
			--cr-gradient-border: linear-gradient(135deg, rgba(217, 119, 6, 0.5) 0%, rgba(217, 119, 6, 0.1) 100%);

			/* Status colors */
			--cr-status-running: #22c55e;
			/* green-500 */
			--cr-status-idle: #6b7280;
			/* gray-500 */
			--cr-status-completed: #3b82f6;
			/* blue-500 */
			--cr-status-error: #ef4444;
			/* red-500 */
			--cr-status-warning: #eab308;
			/* yellow-500 */

			/* Code/Tool colors */
			--cr-tool-cyan: #22d3ee;
			/* cyan-400 */
			--cr-diff-removed: #f87171;
			/* red-400 */
			--cr-diff-added: #4ade80;
			/* green-400 */

			/* Message colors */
			--cr-msg-user: #3b82f6;
			/* blue-500 */
			--cr-msg-claude: #22c55e;
			/* green-500 */
			--cr-msg-tool: #8b5cf6;
			/* violet-500 */
			--cr-msg-error: #ef4444;
			/* red-500 */
			--cr-msg-thinking: #a855f7;
			/* purple-500 */

			/* Border colors */
			--cr-border: #2a2a30;
			/* Subtle border */
			--cr-border-hover: #3a3a42;
			/* Hover border */
			--cr-border-focus: #D97706;
			/* Focus - amber */
			--cr-border-glass: rgba(255, 255, 255, 0.06);

			/* Sizing */
			--cr-sidebar-width: 280px;
			--cr-header-height: 56px;
			--cr-input-height: 120px;
			--cr-radius-sm: 6px;
			--cr-radius-md: 10px;
			--cr-radius-lg: 14px;

			/* ====== PREMIUM TYPOGRAPHY ====== */
			--cr-font-display: 'Space Grotesk', system-ui, sans-serif;
			--cr-font-sans: 'Inter', system-ui, sans-serif;
			--cr-font-mono: 'JetBrains Mono', ui-monospace, monospace;

			/* Font sizes */
			--cr-text-xs: 11px;
			--cr-text-sm: 13px;
			--cr-text-base: 14px;
			--cr-text-lg: 16px;
			--cr-text-xl: 20px;

			/* Letter spacing */
			--cr-tracking-tight: -0.02em;
			--cr-tracking-wide: 0.05em;
			--cr-tracking-wider: 0.1em;

			/* ====== SHADOWS & GLOWS ====== */
			--cr-shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
			--cr-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
			--cr-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
			--cr-shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
			--cr-glow-accent: 0 0 20px rgba(217, 119, 6, 0.3);
			--cr-glow-accent-strong: 0 0 40px rgba(217, 119, 6, 0.5);

			/* ====== ANIMATION TIMING ====== */
			--cr-ease-out: cubic-bezier(0.4, 0, 0.2, 1);
			--cr-ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
			--cr-duration-fast: 0.15s;
			--cr-duration-normal: 0.25s;
			--cr-duration-slow: 0.4s;
		}

		/* ========================================
       Base Layout
       ======================================== */
		* {
			box-sizing: border-box;
		}

		body {
			font-family: var(--cr-font-sans);
			background-color: var(--cr-bg-base);
			color: var(--cr-text-primary);
			margin: 0;
			padding: 0;
			height: 100vh;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			font-size: var(--cr-text-base);
			line-height: 1.5;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		/* Clean background - no grid for streamlined look */

		/* ========================================
       Header - Command Bar
       ======================================== */
		.cr-header {
			height: var(--cr-header-height);
			padding: 0 20px;
			border-bottom: 1px solid var(--cr-border);
			background: linear-gradient(180deg,
					rgba(26, 26, 31, 0.95) 0%,
					rgba(26, 26, 31, 0.85) 100%);
			backdrop-filter: blur(16px);
			-webkit-backdrop-filter: blur(16px);
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-shrink: 0;
			position: relative;
			z-index: 10;
			box-shadow: var(--cr-shadow-md);
		}

		/* Subtle amber glow line at bottom of header */
		.cr-header::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 15%;
			right: 15%;
			height: 1px;
			background: linear-gradient(90deg,
					transparent 0%,
					rgba(217, 119, 6, 0.5) 50%,
					transparent 100%);
		}

		.cr-header-left {
			display: flex;
			align-items: center;
			gap: 14px;
		}

		.cr-logo {
			width: 38px;
			height: 38px;
			border-radius: var(--cr-radius-md);
			background: var(--cr-gradient-accent);
			display: flex;
			align-items: center;
			justify-content: center;
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-sm);
			font-weight: 700;
			color: white;
			box-shadow: var(--cr-glow-accent);
			transition: all var(--cr-duration-normal) var(--cr-ease-out);
		}

		.cr-logo:hover {
			transform: scale(1.05);
			box-shadow: var(--cr-glow-accent-strong);
		}

		.cr-title {
			margin: 0;
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-xl);
			font-weight: 700;
			letter-spacing: var(--cr-tracking-tight);
			text-transform: uppercase;
			background: var(--cr-gradient-accent);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		.cr-stats {
			display: flex;
			gap: 16px;
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-xs);
		}

		.cr-stats .stat-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 4px 10px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: var(--cr-radius-sm);
			border: 1px solid var(--cr-border-glass);
		}

		.cr-stats .stat-label {
			font-size: 9px;
			text-transform: uppercase;
			letter-spacing: var(--cr-tracking-wider);
			color: var(--cr-text-muted);
		}

		.cr-stats .stat-value {
			font-size: var(--cr-text-sm);
			font-weight: 600;
			color: var(--cr-accent);
		}

		.cr-header-right {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		/* ========================================
       Main Layout - Split View
       ======================================== */
		.cr-main {
			flex: 1;
			display: flex;
			overflow: hidden;
		}

		/* ========================================
       Agent Sidebar
       ======================================== */
		.cr-sidebar {
			width: var(--cr-sidebar-width);
			background: rgba(26, 26, 31, 0.7);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			border-right: 1px solid var(--cr-border-glass);
			display: flex;
			flex-direction: column;
			flex-shrink: 0;
			position: relative;
		}

		.cr-sidebar-header {
			padding: 14px 16px;
			padding-left: 48px;
			border-bottom: 1px solid var(--cr-border);
			position: relative;
		}

		/* Section number indicator */
		.cr-sidebar-header::before {
			content: '01';
			position: absolute;
			left: 16px;
			top: 50%;
			transform: translateY(-50%);
			font-family: var(--cr-font-display);
			font-size: 10px;
			font-weight: 600;
			color: var(--cr-accent);
			opacity: 0.6;
			letter-spacing: 1px;
		}

		.cr-sidebar-label {
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-xs);
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: var(--cr-tracking-wider);
			color: var(--cr-accent);
		}

		.cr-agent-list {
			flex: 1;
			overflow-y: auto;
			padding: 10px;
		}

		/* Agent Card - Premium glassmorphism */
		.agent-card {
			padding: 14px 16px;
			border-radius: var(--cr-radius-lg);
			margin-bottom: 10px;
			cursor: pointer;
			border: 1px solid var(--cr-border-glass);
			background: rgba(26, 26, 31, 0.5);
			backdrop-filter: blur(8px);
			-webkit-backdrop-filter: blur(8px);
			transition: all var(--cr-duration-normal) var(--cr-ease-out);
			position: relative;
			overflow: hidden;
		}

		/* Numbered index indicator */
		.agent-card::before {
			content: attr(data-index);
			position: absolute;
			top: 8px;
			right: 10px;
			font-family: var(--cr-font-display);
			font-size: 10px;
			font-weight: 600;
			color: var(--cr-text-muted);
			opacity: 0.4;
			letter-spacing: 1px;
		}

		.agent-card:hover {
			background: rgba(26, 26, 31, 0.7);
			border-color: rgba(217, 119, 6, 0.3);
			transform: translateX(4px);
			box-shadow: -4px 0 0 0 var(--cr-accent);
		}

		.agent-card.selected {
			background: rgba(217, 119, 6, 0.1);
			border-color: var(--cr-accent);
			box-shadow:
				0 0 0 1px var(--cr-accent),
				inset 0 0 30px rgba(217, 119, 6, 0.05),
				var(--cr-glow-accent);
		}

		/* Animated accent border on selected */
		.agent-card.selected::after {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 3px;
			background: var(--cr-gradient-accent);
			animation: borderPulse 2s ease-in-out infinite;
		}

		@keyframes borderPulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.6;
			}
		}

		.agent-card-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 8px;
		}

		.agent-name {
			font-family: var(--cr-font-sans);
			font-size: var(--cr-text-sm);
			font-weight: 600;
			letter-spacing: var(--cr-tracking-tight);
			color: var(--cr-text-primary);
			flex: 1;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		/* Enhanced Status Dot with glow */
		.status-dot {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			flex-shrink: 0;
			position: relative;
		}

		/* Glow ring effect */
		.status-dot::before {
			content: '';
			position: absolute;
			inset: -4px;
			border-radius: 50%;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.status-dot.running {
			background-color: var(--cr-status-running);
			box-shadow: 0 0 8px var(--cr-status-running);
			animation: statusGlow 2s ease-in-out infinite;
		}

		.status-dot.running::before {
			border: 1px solid var(--cr-status-running);
			opacity: 0.5;
			animation: ringPulse 2s ease-in-out infinite;
		}

		@keyframes statusGlow {

			0%,
			100% {
				opacity: 1;
				box-shadow: 0 0 8px var(--cr-status-running);
			}

			50% {
				opacity: 0.7;
				box-shadow: 0 0 16px var(--cr-status-running);
			}
		}

		@keyframes ringPulse {

			0%,
			100% {
				transform: scale(1);
				opacity: 0.5;
			}

			50% {
				transform: scale(1.8);
				opacity: 0;
			}
		}

		.status-dot.idle {
			background-color: var(--cr-status-idle);
			box-shadow: 0 0 4px rgba(107, 114, 128, 0.3);
		}

		.status-dot.completed {
			background-color: var(--cr-status-completed);
			box-shadow: 0 0 6px rgba(59, 130, 246, 0.4);
		}

		.status-dot.error {
			background-color: var(--cr-status-error);
			box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
			animation: errorPulse 1s ease-in-out infinite;
		}

		@keyframes errorPulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		@keyframes statusPulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		.agent-task {
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			margin-bottom: 8px;
		}

		.agent-meta {
			display: flex;
			justify-content: space-between;
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-xs);
			color: var(--cr-text-muted);
		}

		/* ========================================
       Content Area
       ======================================== */
		.cr-content {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			background-color: var(--cr-bg-base);
			position: relative;
			z-index: 1;
		}

		/* Agent Content Header */
		.cr-agent-header {
			padding: 14px 20px;
			padding-left: 52px;
			border-bottom: 1px solid var(--cr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: linear-gradient(180deg,
					rgba(26, 26, 31, 0.6) 0%,
					transparent 100%);
			position: relative;
		}

		/* Section number indicator */
		.cr-agent-header::before {
			content: '02';
			position: absolute;
			left: 20px;
			top: 50%;
			transform: translateY(-50%);
			font-family: var(--cr-font-display);
			font-size: 10px;
			font-weight: 600;
			color: var(--cr-accent);
			opacity: 0.6;
			letter-spacing: 1px;
		}

		.cr-agent-info {
			display: flex;
			align-items: center;
			gap: 14px;
		}

		.cr-agent-name {
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-lg);
			font-weight: 600;
			color: var(--cr-text-primary);
			letter-spacing: var(--cr-tracking-tight);
		}

		.cr-agent-task-label {
			font-size: var(--cr-text-sm);
			color: var(--cr-text-muted);
		}

		.cr-agent-controls {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		/* ========================================
       Output Panel (Messages/Chat Container)
       ======================================== */
		.output-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.chat-container {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.messages {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
			background: linear-gradient(180deg,
					var(--cr-bg-surface-dark) 0%,
					#060608 100%);
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-sm);
			line-height: 1.7;
		}

		/* Custom scrollbar for messages */
		.messages::-webkit-scrollbar {
			width: 6px;
		}

		.messages::-webkit-scrollbar-track {
			background: transparent;
		}

		.messages::-webkit-scrollbar-thumb {
			background: rgba(217, 119, 6, 0.3);
			border-radius: 3px;
		}

		.messages::-webkit-scrollbar-thumb:hover {
			background: rgba(217, 119, 6, 0.5);
		}

		/* ========================================
       Messages - Clean, minimal styling
       ======================================== */
		.message {
			margin-bottom: 20px;
			padding: 16px 18px;
			border-radius: 12px;
			position: relative;
			overflow: hidden;
			border: none;
			background: transparent;
		}

		.message:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		/* Subtle left border indicator */
		.message::before {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 3px;
			border-radius: 3px;
		}

		.message.user::before {
			background: #3B82F6;
		}

		.message.claude::before {
			background: #22C55E;
		}

		.message.error::before {
			background: #EF4444;
		}

		.message.tool::before {
			background: #8B5CF6;
		}

		.message.tool-result::before {
			background: #14B8A6;
		}

		.message.thinking::before {
			background: #A855F7;
			opacity: 0.5;
		}

		.message.system {
			background-color: transparent;
			border: none;
			color: var(--cr-text-muted);
			font-style: italic;
			padding: 8px 12px;
			font-size: var(--cr-text-sm);
		}

		.message.system::before {
			display: none;
		}

		.message-header {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 8px;
		}

		.message-icon {
			width: 20px;
			height: 20px;
			border-radius: 6px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 10px;
		}

		.message-icon.user {
			background: var(--cr-msg-user);
		}

		.message-icon.claude {
			background: var(--cr-msg-claude);
		}

		.message-icon.error {
			background: var(--cr-msg-error);
		}

		.message-label {
			font-weight: 500;
			font-size: 12px;
			color: var(--cr-text-secondary);
		}

		.copy-btn {
			background: transparent;
			border: none;
			color: var(--cr-text-muted);
			cursor: pointer;
			padding: 4px;
			border-radius: 4px;
			opacity: 0;
			transition: all 0.15s ease;
			margin-left: auto;
		}

		.message:hover .copy-btn {
			opacity: 0.5;
		}

		.copy-btn:hover {
			opacity: 1;
			background: rgba(255, 255, 255, 0.05);
		}

		.message-content {
			line-height: 1.65;
			color: var(--cr-text-primary);
		}

		/* ========================================
       Tool Messages
       ======================================== */
		.tool-header {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 10px;
			padding-bottom: 8px;
			border-bottom: 1px solid var(--cr-border);
		}

		.tool-icon {
			width: 20px;
			height: 20px;
			border-radius: var(--cr-radius-sm);
			background: linear-gradient(135deg, var(--cr-msg-tool) 0%, #7c3aed 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 10px;
			color: white;
			margin-left: 4px;
		}

		.tool-info {
			font-weight: 500;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-primary);
		}

		.tool-input {
			padding: 8px;
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-xs);
			line-height: 1.4;
		}

		.tool-input-label {
			color: var(--cr-text-secondary);
			font-size: 10px;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 6px;
		}

		.tool-input-content {
			color: var(--cr-text-primary);
		}

		/* ========================================
       Tool Approval Card (Permission Request)
       ======================================== */
		.tool-approval-area {
			padding: 0 20px;
		}

		.permission-request,
		.tool-approval-card {
			margin: 16px 0;
			background: rgba(26, 26, 31, 0.8);
			backdrop-filter: blur(16px);
			-webkit-backdrop-filter: blur(16px);
			border-radius: var(--cr-radius-lg);
			padding: 16px;
			animation: slideUp 0.3s var(--cr-ease-out);
			position: relative;
			overflow: hidden;
			border: 1px solid transparent;
		}

		/* Animated warning gradient border */
		.permission-request::before,
		.tool-approval-card::before {
			content: '';
			position: absolute;
			inset: 0;
			border-radius: inherit;
			padding: 1px;
			background: linear-gradient(135deg,
					rgba(234, 179, 8, 0.6) 0%,
					rgba(234, 179, 8, 0.2) 50%,
					rgba(234, 179, 8, 0.4) 100%);
			-webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
			mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
			-webkit-mask-composite: xor;
			mask-composite: exclude;
			animation: borderGlow 2s ease-in-out infinite;
		}

		@keyframes borderGlow {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		@keyframes slideUp {
			from {
				opacity: 0;
				transform: translateY(12px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.permission-header,
		.tool-approval-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 12px;
		}

		.permission-header .tool-name,
		.tool-approval-header .tool-name {
			display: flex;
			align-items: center;
			gap: 8px;
			color: var(--cr-status-warning);
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-sm);
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: var(--cr-tracking-wide);
		}

		.permission-content,
		.tool-approval-content {
			font-size: var(--cr-text-xs);
			line-height: 1.5;
			color: var(--cr-text-secondary);
		}

		.permission-tool,
		.tool-approval-preview {
			font-family: var(--cr-font-mono);
			background: rgba(0, 0, 0, 0.4);
			border-radius: var(--cr-radius-sm);
			padding: 12px;
			margin: 12px 0;
			font-size: var(--cr-text-xs);
			overflow-x: auto;
			border: 1px solid var(--cr-border-glass);
		}

		.permission-buttons,
		.tool-approval-buttons {
			display: flex;
			gap: 8px;
		}

		/* Approve Button */
		.btn.approve,
		.permission-buttons .btn.allow {
			background-color: #16a34a;
			color: white;
			border: none;
			padding: 6px 12px;
			border-radius: var(--cr-radius-sm);
			font-size: var(--cr-text-xs);
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.15s ease;
		}

		.btn.approve:hover,
		.permission-buttons .btn.allow:hover {
			background-color: #22c55e;
		}

		/* Deny Button */
		.btn.deny,
		.permission-buttons .btn.deny {
			background-color: var(--cr-border);
			color: var(--cr-text-primary);
			border: none;
			padding: 6px 12px;
			border-radius: var(--cr-radius-sm);
			font-size: var(--cr-text-xs);
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.15s ease;
		}

		.btn.deny:hover,
		.permission-buttons .btn.deny:hover {
			background-color: var(--cr-border-hover);
		}

		.permission-buttons .btn.always-allow {
			background-color: rgba(59, 130, 246, 0.1);
			color: #3b82f6;
			border: 1px solid rgba(59, 130, 246, 0.3);
			padding: 6px 12px;
			border-radius: var(--cr-radius-sm);
			font-size: var(--cr-text-xs);
			font-weight: 500;
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.permission-buttons .btn.always-allow:hover {
			background-color: rgba(59, 130, 246, 0.2);
		}

		.permission-decision {
			font-size: var(--cr-text-xs);
			font-weight: 600;
			padding: 8px 12px;
			text-align: center;
			border-radius: var(--cr-radius-sm);
			margin-top: 8px;
		}

		.permission-decision.allowed {
			background-color: rgba(34, 197, 94, 0.15);
			color: var(--cr-status-running);
			border: 1px solid rgba(34, 197, 94, 0.3);
		}

		.permission-decision.denied {
			background-color: rgba(239, 68, 68, 0.15);
			color: var(--cr-status-error);
			border: 1px solid rgba(239, 68, 68, 0.3);
		}

		.permission-decided {
			opacity: 0.7;
		}

		.permission-decided .permission-buttons {
			display: none;
		}

		/* ========================================
       Input Area
       ======================================== */
		.input-container {
			padding: 16px 20px;
			background: linear-gradient(180deg,
					transparent 0%,
					rgba(26, 26, 31, 0.5) 100%);
			border-top: 1px solid rgba(217, 119, 6, 0.1);
		}

		.input-modes {
			display: flex;
			gap: 20px;
			margin-bottom: 10px;
			font-size: var(--cr-text-xs);
		}

		.mode-toggle {
			display: flex;
			align-items: center;
			gap: 8px;
			color: var(--cr-text-secondary);
			cursor: pointer;
			transition: color var(--cr-duration-fast) ease;
			font-family: var(--cr-font-sans);
		}

		.mode-toggle:hover {
			color: var(--cr-text-primary);
		}

		.mode-switch {
			position: relative;
			width: 32px;
			height: 16px;
			background-color: var(--cr-border);
			border-radius: 8px;
			cursor: pointer;
			transition: all var(--cr-duration-normal) var(--cr-ease-out);
		}

		.mode-switch.active {
			background: var(--cr-gradient-accent);
			box-shadow: 0 0 10px rgba(217, 119, 6, 0.3);
		}

		.mode-switch::after {
			content: '';
			position: absolute;
			top: 2px;
			left: 2px;
			width: 12px;
			height: 12px;
			background-color: white;
			border-radius: 50%;
			transition: transform var(--cr-duration-normal) var(--cr-ease-bounce);
			box-shadow: var(--cr-shadow-sm);
		}

		.mode-switch.active::after {
			transform: translateX(16px);
		}

		.textarea-container {
			display: flex;
			gap: 12px;
			align-items: flex-end;
		}

		.textarea-wrapper {
			flex: 1;
			display: flex;
			flex-direction: column;
			background: rgba(26, 26, 31, 0.6);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			border: 1px solid var(--cr-border-glass);
			border-radius: var(--cr-radius-lg);
			overflow: hidden;
			transition: all var(--cr-duration-normal) var(--cr-ease-out);
		}

		.textarea-wrapper:focus-within {
			border-color: var(--cr-accent);
			box-shadow:
				0 0 0 3px rgba(217, 119, 6, 0.1),
				var(--cr-glow-accent);
		}

		.input-field {
			width: 100%;
			background-color: transparent;
			color: var(--cr-text-primary);
			border: none;
			padding: 14px 18px;
			outline: none;
			font-family: var(--cr-font-sans);
			font-size: var(--cr-text-base);
			min-height: 52px;
			max-height: 200px;
			line-height: 1.4;
			resize: none;
		}

		.input-field::placeholder {
			color: var(--cr-text-muted);
		}

		.input-controls {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 8px 12px;
			border-top: 1px solid rgba(255, 255, 255, 0.03);
		}

		.left-controls,
		.right-controls {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		/* ========================================
		   Claude Code Mode Toggle
		   ======================================== */
		.mode-toggle-bar {
			display: flex;
			align-items: center;
			justify-content: center;
			margin-top: 10px;
		}

		.mode-toggle-container {
			display: inline-flex;
			align-items: center;
			background: #0a0a0c;
			border-radius: 8px;
			padding: 3px;
			gap: 2px;
			border: 1px solid rgba(255, 255, 255, 0.08);
			box-shadow:
				0 2px 8px rgba(0, 0, 0, 0.4),
				inset 0 1px 0 rgba(255, 255, 255, 0.03);
		}

		.mode-toggle-option {
			position: relative;
			display: flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border: none;
			background: transparent;
			color: var(--cr-text-muted);
			font-family: var(--cr-font-sans);
			font-size: 11px;
			font-weight: 500;
			cursor: pointer;
			border-radius: 5px;
			transition: all 0.2s ease;
			white-space: nowrap;
		}

		.mode-toggle-option:hover:not(.active) {
			color: var(--cr-text-secondary);
			background: rgba(255, 255, 255, 0.04);
		}

		.mode-toggle-option.active {
			background: rgba(255, 255, 255, 0.1);
			color: var(--cr-text-primary);
			box-shadow:
				0 1px 3px rgba(0, 0, 0, 0.3),
				inset 0 1px 0 rgba(255, 255, 255, 0.05);
		}

		.mode-toggle-option svg {
			width: 12px;
			height: 12px;
			flex-shrink: 0;
			opacity: 0.7;
		}

		.mode-toggle-option.active svg {
			opacity: 1;
		}

		/* Icon colors for different modes */
		.mode-toggle-option[data-mode="plan"] svg {
			color: #60a5fa;
		}

		.mode-toggle-option[data-mode="auto"] svg {
			color: #4ade80;
		}

		.mode-toggle-option[data-mode="ask"] svg {
			color: #f59e0b;
		}

		.mode-toggle-option.active[data-mode="plan"] {
			background: rgba(96, 165, 250, 0.15);
		}

		.mode-toggle-option.active[data-mode="auto"] {
			background: rgba(74, 222, 128, 0.15);
		}

		.mode-toggle-option.active[data-mode="ask"] {
			background: rgba(245, 158, 11, 0.15);
		}

		/* Subtle separator between options */
		.mode-toggle-separator {
			width: 1px;
			height: 16px;
			background: rgba(255, 255, 255, 0.08);
		}

		.model-selector,
		.tools-btn {
			background: transparent;
			color: var(--cr-text-muted);
			border: none;
			padding: 6px 10px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 4px;
			transition: all 0.15s ease;
		}

		.model-selector:hover,
		.tools-btn:hover {
			background: rgba(255, 255, 255, 0.05);
			color: var(--cr-text-secondary);
		}

		.slash-btn,
		.at-btn,
		.image-btn {
			background: transparent;
			color: var(--cr-text-muted);
			border: none;
			width: 32px;
			height: 32px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.15s ease;
		}

		.slash-btn:hover,
		.at-btn:hover,
		.image-btn:hover {
			background: rgba(255, 255, 255, 0.05);
			color: var(--cr-text-secondary);
		}

		/* ========================================
       Buttons - Premium Styling
       ======================================== */
		.btn {
			background-color: var(--cr-bg-surface);
			color: var(--cr-text-primary);
			border: none;
			padding: 8px 14px;
			border-radius: var(--cr-radius-sm);
			cursor: pointer;
			font-family: var(--cr-font-sans);
			font-size: var(--cr-text-sm);
			font-weight: 500;
			transition: all var(--cr-duration-normal) var(--cr-ease-out);
			display: inline-flex;
			align-items: center;
			gap: 6px;
			position: relative;
			overflow: hidden;
		}

		.btn:hover {
			background-color: var(--cr-border);
			transform: translateY(-1px);
		}

		.btn:active {
			transform: translateY(0);
		}

		.btn.icon {
			padding: 8px;
			background: transparent;
			color: var(--cr-text-muted);
			border-radius: 8px;
		}

		.btn.icon:hover {
			background-color: rgba(255, 255, 255, 0.06);
			color: var(--cr-text-secondary);
			transform: none;
		}

		.btn.icon:active {
			background-color: rgba(255, 255, 255, 0.1);
			transform: none;
		}

		.btn.small {
			padding: 5px 10px;
			font-size: var(--cr-text-xs);
		}

		/* Primary Button - Clean and subtle */
		.btn.primary {
			background: var(--cr-accent);
			color: white;
			border: none;
			padding: 10px 18px;
			border-radius: var(--cr-radius-md);
			cursor: pointer;
			font-family: var(--cr-font-sans);
			font-size: var(--cr-text-sm);
			font-weight: 500;
			transition: all var(--cr-duration-fast) var(--cr-ease-out);
		}

		.btn.primary:hover {
			background: var(--cr-accent-hover);
		}

		.btn.primary:active {
			transform: scale(0.98);
		}

		.btn.primary:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* Send button - Compact and clean */
		.send-btn {
			background: var(--cr-accent);
			color: white;
			border: none;
			width: 32px;
			height: 32px;
			border-radius: 8px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all var(--cr-duration-fast) var(--cr-ease-out);
			margin-left: 4px;
		}

		.send-btn:hover {
			background: var(--cr-accent-hover);
		}

		.send-btn:active {
			transform: scale(0.95);
		}

		.send-btn:disabled {
			opacity: 0.4;
			cursor: not-allowed;
		}

		/* Secondary Button */
		.btn.secondary {
			background: rgba(255, 255, 255, 0.05);
			color: var(--cr-text-primary);
			border: 1px solid var(--cr-border-glass);
		}

		.btn.secondary:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--cr-border-hover);
		}

		/* Danger Button */
		.btn.danger,
		.btn.stop {
			background: rgba(239, 68, 68, 0.15);
			color: #F87171;
			border: 1px solid rgba(239, 68, 68, 0.3);
		}

		.btn.danger:hover,
		.btn.stop:hover {
			background: rgba(239, 68, 68, 0.25);
			border-color: rgba(239, 68, 68, 0.5);
			box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
		}

		/* Outlined Button */
		.btn.outlined {
			background: transparent;
			color: var(--cr-text-primary);
			border: 1px solid var(--cr-border);
		}

		.btn.outlined:hover {
			background: rgba(217, 119, 6, 0.1);
			border-color: var(--cr-accent);
			color: var(--cr-accent);
		}

		/* Screen reader only utility */
		.sr-only {
			position: absolute;
			width: 1px;
			height: 1px;
			padding: 0;
			margin: -1px;
			overflow: hidden;
			clip: rect(0, 0, 0, 0);
			white-space: nowrap;
			border: 0;
		}

		/* Session Status Badge */
		.session-status {
			font-family: var(--cr-font-mono);
			font-size: 10px;
			color: var(--cr-text-secondary);
			padding: 4px 10px;
			border-radius: 12px;
			background: rgba(0, 0, 0, 0.3);
			border: 1px solid var(--cr-border-glass);
			text-transform: uppercase;
			letter-spacing: var(--cr-tracking-wide);
		}

		.session-status.active {
			color: var(--cr-status-running);
			background: rgba(34, 197, 94, 0.1);
			border-color: rgba(34, 197, 94, 0.3);
		}

		/* ========================================
       Code Blocks - Premium Terminal Style
       ======================================== */
		.message-content pre.code-block {
			background: rgba(0, 0, 0, 0.4);
			border: 1px solid var(--cr-border-glass);
			border-radius: var(--cr-radius-md);
			padding: 14px;
			margin: 10px 0;
			overflow-x: auto;
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-xs);
			line-height: 1.6;
		}

		.message-content code {
			background: rgba(217, 119, 6, 0.1);
			border: 1px solid rgba(217, 119, 6, 0.2);
			border-radius: 4px;
			padding: 2px 6px;
			font-family: var(--cr-font-mono);
			font-size: 0.9em;
			color: var(--cr-accent-hover);
		}

		.code-block-container {
			margin: 10px 0;
			border: 1px solid var(--cr-border-glass);
			border-radius: var(--cr-radius-md);
			overflow: hidden;
			background: rgba(0, 0, 0, 0.3);
		}

		.code-block-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 8px 12px;
			background: rgba(26, 26, 31, 0.8);
			border-bottom: 1px solid var(--cr-border-glass);
			font-size: 10px;
		}

		.code-block-language {
			color: var(--cr-accent);
			font-family: var(--cr-font-mono);
			font-weight: 500;
			text-transform: uppercase;
			letter-spacing: var(--cr-tracking-wider);
		}

		.code-copy-btn {
			background: none;
			border: none;
			color: var(--cr-text-secondary);
			cursor: pointer;
			padding: 6px;
			border-radius: var(--cr-radius-sm);
			opacity: 0.7;
			transition: all var(--cr-duration-fast) ease;
		}

		.code-copy-btn:hover {
			background: rgba(217, 119, 6, 0.1);
			color: var(--cr-accent);
			opacity: 1;
		}

		/* ========================================
       Diff Display
       ======================================== */
		.diff-container {
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			overflow: hidden;
		}

		.diff-header {
			background-color: var(--cr-bg-surface);
			padding: 6px 12px;
			font-size: 11px;
			font-weight: 600;
			border-bottom: 1px solid var(--cr-border);
		}

		.diff-line {
			padding: 2px 12px;
			font-family: var(--cr-font-mono);
			font-size: var(--cr-text-xs);
			line-height: 1.5;
		}

		.diff-line.removed {
			background-color: rgba(239, 68, 68, 0.1);
			color: var(--cr-diff-removed);
		}

		.diff-line.added {
			background-color: rgba(34, 197, 94, 0.1);
			color: var(--cr-diff-added);
		}

		.diff-file-path {
			padding: 8px 12px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			font-size: var(--cr-text-xs);
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.diff-file-path:hover {
			background-color: var(--cr-bg-hover);
			border-color: var(--cr-accent);
		}

		.diff-open-btn {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			background: transparent;
			border: 1px solid var(--cr-border);
			color: var(--cr-text-secondary);
			padding: 4px 10px;
			border-radius: var(--cr-radius-sm);
			font-size: 11px;
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.diff-open-btn:hover {
			background: var(--cr-bg-hover);
			border-color: var(--cr-accent);
			color: var(--cr-text-primary);
		}

		/* ========================================
       Modals
       ======================================== */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
			z-index: 1000;
			display: flex;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(2px);
		}

		.modal-content {
			background-color: var(--cr-bg-surface);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-lg);
			width: 500px;
			max-width: 90vw;
			max-height: 80vh;
			display: flex;
			flex-direction: column;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
			animation: modalIn 0.2s ease;
		}

		@keyframes modalIn {
			from {
				opacity: 0;
				transform: scale(0.95);
			}

			to {
				opacity: 1;
				transform: scale(1);
			}
		}

		.tools-modal-content {
			width: 700px;
		}

		.modal-header,
		.file-picker-header,
		.tools-modal-header {
			padding: 16px;
			border-bottom: 1px solid var(--cr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-weight: 600;
		}

		.close-btn {
			background: none;
			border: none;
			color: var(--cr-text-secondary);
			cursor: pointer;
			padding: 4px;
			border-radius: var(--cr-radius-sm);
			transition: all 0.15s ease;
		}

		.close-btn:hover {
			background-color: var(--cr-bg-hover);
			color: var(--cr-text-primary);
		}

		.tools-list {
			padding: 16px;
			max-height: 400px;
			overflow-y: auto;
		}

		.file-list {
			max-height: 400px;
			overflow-y: auto;
			padding: 8px;
		}

		.file-item {
			display: flex;
			align-items: center;
			padding: 8px 12px;
			cursor: pointer;
			border-radius: var(--cr-radius-sm);
			font-size: 13px;
			gap: 8px;
			transition: background-color 0.15s ease;
		}

		.file-item:hover {
			background-color: var(--cr-bg-hover);
		}

		.file-item.selected {
			background-color: var(--cr-accent-muted);
		}

		.file-search-input {
			width: 100%;
			background-color: var(--cr-bg-surface-dark);
			color: var(--cr-text-primary);
			border: 1px solid var(--cr-border);
			padding: 8px 12px;
			border-radius: var(--cr-radius-sm);
			outline: none;
			font-size: 13px;
			transition: border-color 0.15s ease;
		}

		.file-search-input:focus {
			border-color: var(--cr-accent);
		}

		/* ========================================
       Conversation History
       ======================================== */
		.conversation-history {
			position: absolute;
			top: var(--cr-header-height);
			left: 0;
			right: 0;
			bottom: 0;
			background-color: var(--cr-bg-base);
			z-index: 100;
		}

		.conversation-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			border-bottom: 1px solid var(--cr-border);
		}

		.conversation-header h3 {
			margin: 0;
			font-size: var(--cr-text-sm);
			font-weight: 600;
		}

		.conversation-list {
			padding: 12px;
			overflow-y: auto;
			height: calc(100% - 50px);
		}

		.conversation-item {
			padding: 12px;
			margin: 4px 0;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.conversation-item:hover {
			background-color: var(--cr-bg-hover);
			border-color: var(--cr-accent);
		}

		.conversation-title {
			font-weight: 500;
			margin-bottom: 4px;
			font-size: 13px;
		}

		.conversation-meta {
			font-size: 11px;
			color: var(--cr-text-secondary);
		}

		/* ========================================
       WSL Alert
       ======================================== */
		.wsl-alert {
			margin: 12px;
			background-color: rgba(59, 130, 246, 0.1);
			border: 1px solid rgba(59, 130, 246, 0.3);
			border-radius: var(--cr-radius-lg);
			animation: slideUp 0.2s ease;
		}

		.wsl-alert-content {
			display: flex;
			align-items: center;
			padding: 12px 16px;
			gap: 12px;
		}

		.wsl-alert-icon {
			color: #3b82f6;
		}

		.wsl-alert-text {
			flex: 1;
			font-size: var(--cr-text-xs);
			line-height: 1.4;
		}

		.wsl-alert-actions {
			display: flex;
			gap: 8px;
		}

		/* ========================================
       YOLO Warning
       ======================================== */
		.yolo-warning {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 11px;
			color: var(--cr-accent);
			text-align: center;
			font-weight: 500;
			background-color: var(--cr-accent-muted);
			border: 1px solid rgba(249, 115, 22, 0.3);
			padding: 6px 12px;
			margin: 4px 16px;
			border-radius: var(--cr-radius-sm);
		}

		/* ========================================
       Processing Indicator
       ======================================== */
		.processing-indicator {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			padding: 12px;
		}

		.processing-indicator .morph-dot {
			width: 8px;
			height: 8px;
			background: var(--cr-accent);
			border-radius: 50%;
			animation: morphPulse 1.5s ease-in-out infinite;
		}

		@keyframes morphPulse {

			0%,
			100% {
				transform: scale(1);
				opacity: 1;
			}

			50% {
				transform: scale(1.3);
				opacity: 0.5;
			}
		}

		/* ========================================
       Loading State
       ======================================== */
		.tool-loading {
			padding: 12px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.loading-spinner {
			display: flex;
			gap: 4px;
		}

		.loading-ball {
			width: 6px;
			height: 6px;
			border-radius: 50%;
			background-color: var(--cr-accent);
			animation: bounce 1.4s ease-in-out infinite both;
		}

		.loading-ball:nth-child(1) {
			animation-delay: -0.32s;
		}

		.loading-ball:nth-child(2) {
			animation-delay: -0.16s;
		}

		.loading-ball:nth-child(3) {
			animation-delay: 0s;
		}

		@keyframes bounce {

			0%,
			80%,
			100% {
				transform: scale(0.6);
				opacity: 0.5;
			}

			40% {
				transform: scale(1);
				opacity: 1;
			}
		}

		.loading-text {
			font-size: 11px;
			color: var(--cr-text-secondary);
			font-style: italic;
		}

		/* ========================================
       Scrollbar Styling
       ======================================== */
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		::-webkit-scrollbar-track {
			background: transparent;
		}

		::-webkit-scrollbar-thumb {
			background: var(--cr-border);
			border-radius: 4px;
		}

		::-webkit-scrollbar-thumb:hover {
			background: var(--cr-text-muted);
		}

		/* ========================================
       MCP Servers
       ======================================== */
		.mcp-servers-list {
			padding: 4px;
		}

		.mcp-server-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 16px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			margin-bottom: 12px;
			transition: all 0.15s ease;
		}

		.mcp-server-item:hover {
			border-color: var(--cr-accent);
		}

		.server-info {
			flex: 1;
		}

		.server-name {
			font-weight: 600;
			font-size: var(--cr-text-sm);
			margin-bottom: 4px;
		}

		.server-type {
			display: inline-block;
			background-color: var(--cr-bg-elevated);
			padding: 2px 8px;
			border-radius: var(--cr-radius-sm);
			font-size: 10px;
			font-weight: 500;
			margin-bottom: 4px;
		}

		.server-config {
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
		}

		.mcp-add-server {
			text-align: center;
			margin: 16px 0;
		}

		.mcp-add-form {
			background-color: var(--cr-bg-elevated);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			padding: 16px;
			margin-top: 12px;
		}

		.form-group {
			margin-bottom: 12px;
		}

		.form-group label {
			display: block;
			margin-bottom: 4px;
			font-weight: 500;
			font-size: var(--cr-text-xs);
		}

		.form-group input,
		.form-group select,
		.form-group textarea {
			width: 100%;
			padding: 8px 10px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-base);
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
		}

		.form-group input:focus,
		.form-group select:focus,
		.form-group textarea:focus {
			outline: none;
			border-color: var(--cr-accent);
		}

		.form-hint {
			font-size: 10px;
			color: var(--cr-text-muted);
			margin-top: 4px;
		}

		.form-hint code {
			background-color: var(--cr-bg-surface-dark);
			padding: 1px 4px;
			border-radius: 2px;
		}

		.form-buttons {
			display: flex;
			gap: 8px;
			justify-content: flex-end;
			margin-top: 16px;
		}

		.mcp-popular-servers {
			margin-top: 24px;
			padding-top: 16px;
			border-top: 1px solid var(--cr-border);
		}

		.mcp-popular-servers h4 {
			margin: 0 0 12px 0;
			font-size: var(--cr-text-xs);
			font-weight: 600;
			color: var(--cr-text-secondary);
		}

		.popular-servers-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
			gap: 8px;
		}

		.popular-server-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px 12px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.popular-server-item:hover {
			border-color: var(--cr-accent);
			background-color: var(--cr-bg-hover);
		}

		.popular-server-icon {
			color: var(--cr-text-secondary);
		}

		.popular-server-name {
			font-weight: 500;
			font-size: var(--cr-text-xs);
		}

		.popular-server-desc {
			font-size: 10px;
			color: var(--cr-text-secondary);
		}

		/* ========================================
       Install Modal
       ======================================== */
		.install-modal-backdrop {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(2px);
		}

		.install-modal-content {
			position: relative;
			background: var(--cr-bg-surface);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-lg);
			width: 320px;
			padding: 24px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
		}

		.install-close-btn {
			position: absolute;
			top: 12px;
			right: 12px;
			width: 28px;
			height: 28px;
			background: none;
			border: none;
			color: var(--cr-text-secondary);
			cursor: pointer;
			border-radius: var(--cr-radius-sm);
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.install-close-btn:hover {
			background: var(--cr-bg-hover);
		}

		.install-body {
			text-align: center;
		}

		.install-icon-wrapper {
			width: 56px;
			height: 56px;
			border-radius: 12px;
			background: var(--cr-accent);
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 16px;
			color: white;
		}

		.install-title {
			margin: 0 0 8px 0;
			font-size: 16px;
			font-weight: 600;
		}

		.install-desc {
			margin: 0 0 20px 0;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
		}

		.install-btn {
			width: 100%;
			padding: 10px 20px;
			font-size: 13px;
			font-weight: 500;
			background: var(--cr-accent);
			color: white;
			border: none;
			border-radius: var(--cr-radius-md);
			cursor: pointer;
		}

		.install-btn:hover {
			background: var(--cr-accent-hover);
		}

		.install-link {
			display: block;
			margin-top: 12px;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
			text-decoration: none;
		}

		.install-link:hover {
			color: var(--cr-accent);
		}

		.install-spinner {
			width: 32px;
			height: 32px;
			border: 3px solid var(--cr-border);
			border-top-color: var(--cr-accent);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 16px;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		.install-progress-text {
			margin: 0;
			font-size: var(--cr-text-sm);
			font-weight: 500;
		}

		.install-progress-hint {
			margin: 8px 0 0;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-muted);
		}

		.install-success-icon {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			background: rgba(34, 197, 94, 0.2);
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 16px;
		}

		.install-check {
			width: 24px;
			height: 24px;
			stroke: var(--cr-status-running);
		}

		.install-success-text {
			margin: 0;
			font-size: var(--cr-text-sm);
			font-weight: 500;
			color: var(--cr-status-running);
		}

		.install-success-hint {
			margin: 8px 0 0;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-muted);
		}

		/* ========================================
       Settings
       ======================================== */
		.settings-section {
			margin-bottom: 24px;
		}

		.settings-section h3 {
			margin: 0 0 8px 0;
			font-size: var(--cr-text-sm);
			font-weight: 600;
		}

		.settings-description {
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
			margin: 0 0 12px 0;
		}

		.settings-group {
			padding: 12px;
			background-color: var(--cr-bg-elevated);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
		}

		.tool-item {
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 8px 0;
		}

		.tool-item input[type="checkbox"] {
			accent-color: var(--cr-accent);
		}

		.wsl-options {
			margin-top: 12px;
			padding-top: 12px;
			border-top: 1px solid var(--cr-border);
		}

		.form-input {
			width: 100%;
			padding: 8px 10px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-base);
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
		}

		.form-input:focus {
			outline: none;
			border-color: var(--cr-accent);
		}

		/* Permissions */
		.permissions-list {
			max-height: 200px;
			overflow-y: auto;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			margin-top: 8px;
		}

		.permission-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 8px 12px;
			border-bottom: 1px solid var(--cr-border);
			font-size: var(--cr-text-xs);
		}

		.permission-item:last-child {
			border-bottom: none;
		}

		.permissions-empty {
			padding: 16px;
			text-align: center;
			color: var(--cr-text-secondary);
			font-style: italic;
			font-size: var(--cr-text-xs);
		}

		.permissions-loading {
			padding: 16px;
			text-align: center;
			color: var(--cr-text-muted);
		}

		.permissions-add-section {
			margin-top: 12px;
		}

		.permissions-add-form {
			padding: 12px;
			background-color: var(--cr-bg-base);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			margin-bottom: 8px;
		}

		.permissions-form-row {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.permissions-tool-select {
			padding: 6px 8px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-surface);
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
		}

		.permissions-command-input {
			flex: 1;
			padding: 6px 8px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-surface);
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
		}

		.permissions-add-btn {
			padding: 6px 12px;
		}

		.permissions-form-hint {
			font-size: 10px;
			color: var(--cr-text-muted);
			margin-top: 8px;
		}

		.permissions-show-add-btn {
			width: 100%;
		}

		.yolo-mode-section {
			margin-top: 12px;
			padding-top: 12px;
			border-top: 1px solid var(--cr-border);
			display: flex;
			align-items: center;
			gap: 8px;
		}

		/* ========================================
       Model Selector Modal
       ======================================== */
		.model-modal-content {
			width: 400px;
		}

		.model-explanatory-text {
			padding: 12px 16px;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
			border-bottom: 1px solid var(--cr-border);
		}

		.model-list {
			padding: 8px;
		}

		.model-item {
			display: flex;
			align-items: flex-start;
			gap: 12px;
			padding: 12px;
			border-radius: var(--cr-radius-md);
			cursor: pointer;
			transition: background-color 0.15s ease;
		}

		.model-item:hover {
			background-color: var(--cr-bg-hover);
		}

		.model-item input[type="radio"] {
			accent-color: var(--cr-accent);
			margin-top: 2px;
		}

		.model-title {
			font-weight: 500;
			font-size: var(--cr-text-sm);
			margin-bottom: 2px;
		}

		.model-description {
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
		}

		.default-model-layout {
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
		}

		.configure-button {
			padding: 4px 8px;
			font-size: 11px;
		}

		/* ========================================
       Thinking Intensity Modal
       ======================================== */
		.thinking-modal-content {
			width: 400px;
		}

		.thinking-modal-description {
			padding: 12px 16px;
			font-size: var(--cr-text-xs);
			color: var(--cr-text-secondary);
			border-bottom: 1px solid var(--cr-border);
		}

		.thinking-slider-container {
			padding: 16px 8px;
		}

		.thinking-slider {
			width: 100%;
			height: 4px;
			-webkit-appearance: none;
			appearance: none;
			background: var(--cr-border);
			border-radius: 2px;
			cursor: pointer;
		}

		.thinking-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 14px;
			height: 14px;
			background: var(--cr-accent);
			border-radius: 50%;
			cursor: pointer;
		}

		.slider-labels {
			display: flex;
			justify-content: space-between;
			margin-top: 8px;
			font-size: 10px;
			color: var(--cr-text-secondary);
		}

		.slider-label {
			cursor: pointer;
			transition: color 0.15s ease;
		}

		.slider-label:hover,
		.slider-label.active {
			color: var(--cr-text-primary);
		}

		.thinking-modal-actions {
			padding: 12px 0;
			text-align: center;
		}

		.confirm-btn {
			padding: 8px 24px;
		}

		/* ========================================
       Slash Commands Modal
       ======================================== */
		.slash-modal-content {
			width: 600px;
			max-height: 70vh;
		}

		.tools-modal-body {
			overflow-y: auto;
			max-height: calc(70vh - 60px);
		}

		.slash-commands-search {
			padding: 12px 16px;
			border-bottom: 1px solid var(--cr-border);
			position: sticky;
			top: 0;
			background-color: var(--cr-bg-surface);
			z-index: 10;
		}

		.search-input-wrapper {
			display: flex;
			align-items: center;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			background-color: var(--cr-bg-surface-dark);
			transition: border-color 0.15s ease;
		}

		.search-input-wrapper:focus-within {
			border-color: var(--cr-accent);
		}

		.search-prefix {
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 32px;
			height: 32px;
			background-color: var(--cr-bg-surface);
			color: var(--cr-text-secondary);
			font-size: 13px;
			font-weight: 600;
			border-radius: var(--cr-radius-md) 0 0 var(--cr-radius-md);
			border-right: 1px solid var(--cr-border);
		}

		.slash-commands-search input {
			flex: 1;
			padding: 8px 12px;
			border: none;
			background: transparent;
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
			outline: none;
		}

		.slash-commands-section {
			padding: 12px 16px;
		}

		.slash-commands-section h3 {
			margin: 0 0 8px 0;
			font-size: var(--cr-text-xs);
			font-weight: 600;
			color: var(--cr-text-muted);
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.slash-commands-info {
			font-size: 11px;
			color: var(--cr-text-secondary);
			margin-bottom: 12px;
		}

		.slash-commands-info p {
			margin: 0;
		}

		.slash-commands-list {
			display: grid;
			gap: 4px;
		}

		.slash-command-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px 12px;
			border-radius: var(--cr-radius-sm);
			cursor: pointer;
			transition: all 0.15s ease;
			border: 1px solid transparent;
		}

		.slash-command-item:hover {
			background-color: var(--cr-bg-hover);
			border-color: var(--cr-border);
		}

		.slash-command-icon {
			color: var(--cr-text-secondary);
			min-width: 20px;
			text-align: center;
		}

		.slash-command-content {
			flex: 1;
		}

		.slash-command-title {
			font-size: var(--cr-text-xs);
			font-weight: 500;
		}

		.slash-command-description {
			font-size: 10px;
			color: var(--cr-text-secondary);
		}

		.add-snippet-item {
			border: 1px dashed var(--cr-border);
		}

		.add-snippet-item:hover {
			border-style: solid;
			border-color: var(--cr-accent);
		}

		.add-snippet-form {
			padding: 12px;
			margin: 8px 0;
			background-color: var(--cr-bg-elevated);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
		}

		.command-input-wrapper {
			display: flex;
			align-items: center;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-base);
		}

		.command-prefix {
			padding: 6px 8px;
			color: var(--cr-text-muted);
			border-right: 1px solid var(--cr-border);
		}

		.command-input-wrapper input {
			flex: 1;
			padding: 6px 8px;
			border: none;
			background: transparent;
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
			outline: none;
		}

		.custom-command-item {
			border: 1px solid var(--cr-border);
		}

		.custom-command-input {
			padding: 4px 8px;
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-sm);
			background-color: var(--cr-bg-base);
			color: var(--cr-text-primary);
			font-size: var(--cr-text-xs);
			width: 150px;
		}

		.custom-command-input:focus {
			border-color: var(--cr-accent);
			outline: none;
		}

		/* ========================================
       Restore Button
       ======================================== */
		.restore-container {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}

		.restore-btn {
			background-color: var(--cr-bg-elevated);
			color: var(--cr-text-secondary);
			border: 1px solid var(--cr-border);
			padding: 4px 10px;
			border-radius: var(--cr-radius-sm);
			cursor: pointer;
			font-size: 11px;
			font-weight: 500;
			transition: all 0.15s ease;
		}

		.restore-btn:hover {
			background-color: var(--cr-bg-hover);
			border-color: var(--cr-accent);
			color: var(--cr-text-primary);
		}

		.restore-date {
			font-size: 10px;
			color: var(--cr-text-muted);
		}

		/* ========================================
       Markdown in Messages
       ======================================== */
		.message h1,
		.message h2,
		.message h3,
		.message h4 {
			margin: 0.8em 0 0.4em 0;
			font-weight: 600;
			line-height: 1.3;
		}

		.message h1 {
			font-size: 1.4em;
		}

		.message h2 {
			font-size: 1.2em;
		}

		.message h3 {
			font-size: 1.1em;
		}

		.message strong {
			font-weight: 600;
		}

		.message ul,
		.message ol {
			margin: 0.5em 0;
			padding-left: 1.5em;
		}

		.message li {
			margin: 0.3em 0;
		}

		.message p {
			margin: 0.5em 0;
		}

		.message p:first-child {
			margin-top: 0;
		}

		.message p:last-child {
			margin-bottom: 0;
		}

		/* ========================================
       Expand Button
       ======================================== */
		.expand-btn {
			background: var(--cr-accent-muted);
			border: 1px solid rgba(249, 115, 22, 0.3);
			color: var(--cr-accent-hover);
			padding: 2px 8px;
			border-radius: var(--cr-radius-sm);
			cursor: pointer;
			font-size: 10px;
			font-weight: 500;
			margin-left: 4px;
			transition: all 0.15s ease;
		}

		.expand-btn:hover {
			background: rgba(249, 115, 22, 0.2);
			border-color: var(--cr-accent);
		}

		.expanded-content {
			margin-top: 8px;
			padding: 12px;
			background: var(--cr-bg-surface-dark);
			border: 1px solid var(--cr-border);
			border-radius: var(--cr-radius-md);
			position: relative;
		}

		.expanded-content::before {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 3px;
			background: var(--cr-accent);
			border-radius: var(--cr-radius-md) 0 0 var(--cr-radius-md);
		}

		.expanded-content pre {
			margin: 0;
			white-space: pre-wrap;
			word-wrap: break-word;
		}

		/* ========================================
       TAB-BASED NAVIGATION - Minimal Layout
       ======================================== */

		/* Tab navigation in header */
		.cr-tabs {
			display: flex;
			gap: 2px;
			background: rgba(255, 255, 255, 0.03);
			padding: 3px;
			border-radius: 8px;
			border: 1px solid var(--cr-border-glass);
		}

		.cr-tab {
			padding: 6px 14px;
			border-radius: 6px;
			font-family: var(--cr-font-sans);
			font-size: 13px;
			font-weight: 500;
			color: var(--cr-text-muted);
			background: transparent;
			border: none;
			cursor: pointer;
			transition: all var(--cr-duration-fast) var(--cr-ease-out);
		}

		.cr-tab:hover {
			color: var(--cr-text-secondary);
		}

		.cr-tab.active {
			color: var(--cr-text-primary);
			background: var(--cr-bg-surface);
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
		}

		/* View containers */
		.cr-view {
			display: none;
			flex: 1;
			overflow: hidden;
		}

		.cr-view.active {
			display: flex;
			flex-direction: column;
		}

		/* Chat View - Clean, centered */
		.cr-chat-view {
			max-width: 900px;
			width: 100%;
			margin: 0 auto;
			padding: 0 20px;
		}

		.cr-chat-view .messages {
			background: transparent;
			padding: 24px 0;
		}

		.cr-chat-view .message {
			max-width: 100%;
			margin-bottom: 20px;
		}

		.cr-chat-view .input-container {
			background: transparent;
			border-top: none;
			padding: 16px 0 24px 0;
		}

		/* Agent Manager View - Full width grid */
		.cr-agents-view {
			padding: 24px;
		}

		.cr-agents-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 16px;
			max-width: 1200px;
			margin: 0 auto;
		}

		.cr-agents-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			max-width: 1200px;
			margin-left: auto;
			margin-right: auto;
		}

		.cr-agents-title {
			font-family: var(--cr-font-display);
			font-size: var(--cr-text-xl);
			font-weight: 600;
			color: var(--cr-text-primary);
		}

		/* Simplified header for minimal mode */
		.cr-header.minimal {
			height: 52px;
			padding: 0 24px;
			background: rgba(15, 15, 18, 0.95);
			border-bottom: 1px solid var(--cr-border-glass);
		}

		.cr-header.minimal::after {
			display: none;
		}

		.cr-header.minimal .cr-logo {
			width: 32px;
			height: 32px;
			font-size: 12px;
		}

		.cr-header.minimal .cr-title {
			font-size: var(--cr-text-lg);
			display: none;
			/* Hide title in minimal mode for cleaner look */
		}

		/* Hide sidebar in chat mode */
		.cr-main.chat-mode .cr-sidebar {
			display: none;
		}

		.cr-main.chat-mode .cr-content {
			max-width: 900px;
			margin: 0 auto;
			width: 100%;
		}

		.cr-main.chat-mode .cr-agent-header {
			display: none;
		}

		/* Streamlined input - Clean, modern look */
		.input-container.streamlined {
			background: transparent;
			border-top: none;
			padding: 16px 24px 24px 24px;
			max-width: 900px;
			margin: 0 auto;
			width: 100%;
		}

		.input-container.streamlined .input-modes {
			display: none;
			/* Hide mode toggles in streamlined mode */
		}

		.input-container.streamlined .textarea-wrapper {
			background: var(--cr-bg-surface);
			border: 1px solid var(--cr-border);
			border-radius: 16px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		}

		.input-container.streamlined .textarea-wrapper:focus-within {
			border-color: var(--cr-accent);
			box-shadow:
				0 2px 12px rgba(0, 0, 0, 0.2),
				0 0 0 2px rgba(217, 119, 6, 0.15);
		}

		.input-container.streamlined .input-field {
			padding: 16px 18px;
			min-height: 56px;
		}

		.input-container.streamlined .input-controls {
			padding: 8px 12px 10px;
			background: rgba(0, 0, 0, 0.1);
		}

		/* Inline Slash Command Menu */
		.slash-command-menu {
			position: absolute;
			bottom: 100%;
			left: 0;
			right: 0;
			margin-bottom: 8px;
			background: rgba(26, 26, 31, 0.95);
			backdrop-filter: blur(16px);
			-webkit-backdrop-filter: blur(16px);
			border: 1px solid var(--cr-border-glass);
			border-radius: var(--cr-radius-md);
			box-shadow: var(--cr-shadow-lg);
			max-height: 300px;
			overflow-y: auto;
			display: none;
			z-index: 100;
			padding: 6px;
			bottom: 100%;
			/* Ensure it appears above input */
		}

		.slash-command-menu.visible {
			display: block;
			animation: slideUpFade 0.2s cubic-bezier(0.16, 1, 0.3, 1);
		}

		@keyframes slideUpFade {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.slash-menu-header {
			padding: 8px 10px 4px;
			font-size: 10px;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: var(--cr-text-muted);
			font-weight: 600;
			margin-top: 4px;
		}

		.slash-menu-header:first-child {
			margin-top: 0;
		}

		.slash-menu-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 8px 10px;
			border-radius: var(--cr-radius-sm);
			cursor: pointer;
			transition: all 0.1s ease;
			color: var(--cr-text-secondary);
			margin-bottom: 2px;
		}

		.slash-menu-item:hover,
		.slash-menu-item.active {
			background: var(--cr-accent);
			color: white;
		}

		.slash-menu-item:hover .slash-menu-desc,
		.slash-menu-item.active .slash-menu-desc {
			color: rgba(255, 255, 255, 0.8);
		}

		.slash-menu-item:hover .slash-menu-icon,
		.slash-menu-item.active .slash-menu-icon {
			background: rgba(255, 255, 255, 0.2);
			color: white;
		}

		.slash-menu-icon {
			width: 24px;
			height: 24px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 6px;
			background: rgba(255, 255, 255, 0.05);
			color: var(--cr-text-muted);
			font-size: 12px;
			transition: all 0.2s ease;
		}

		.slash-menu-content {
			flex: 1;
			min-width: 0;
			display: flex;
			flex-direction: column;
			gap: 2px;
		}

		.slash-menu-title {
			font-size: 13px;
			font-weight: 500;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.slash-menu-desc {
			font-size: 11px;
			color: var(--cr-text-muted);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			opacity: 0.8;
		}

		/* Agent card in grid view */
		.agent-card.grid-card {
			padding: 20px;
			min-height: 120px;
			display: flex;
			flex-direction: column;
		}

		.agent-card.grid-card .agent-name {
			font-size: var(--cr-text-base);
			margin-bottom: 8px;
		}

		.agent-card.grid-card .agent-task {
			flex: 1;
			margin-bottom: 12px;
		}

		.agent-card.grid-card .agent-meta {
			margin-top: auto;
			padding-top: 8px;
			border-top: 1px solid var(--cr-border-glass);
		}

		/* Empty state - Elegant and minimal */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			min-height: 400px;
			color: var(--cr-text-muted);
			text-align: center;
			padding: 60px 40px;
		}

		.empty-state-icon {
			width: 48px;
			height: 48px;
			margin-bottom: 24px;
			opacity: 0.15;
			stroke-width: 1;
		}

		.empty-state-title {
			font-family: var(--cr-font-display);
			font-size: 24px;
			font-weight: 600;
			margin-bottom: 12px;
			color: var(--cr-text-primary);
			letter-spacing: -0.02em;
		}

		.empty-state-text {
			font-size: var(--cr-text-sm);
			max-width: 340px;
			line-height: 1.6;
			color: var(--cr-text-muted);
		}

		/* ========================================
       Glassmorphic Agent Sidebar
       ======================================== */
		.agent-panel-overlay {
			display: none;
			/* Hidden - sidebar doesn't need overlay */
		}

		.agent-panel {
			position: fixed;
			top: 52px;
			right: 0;
			width: 0;
			height: calc(100vh - 52px);
			background: rgba(20, 20, 25, 0.85);
			backdrop-filter: blur(24px) saturate(180%);
			-webkit-backdrop-filter: blur(24px) saturate(180%);
			border-left: 1px solid rgba(255, 255, 255, 0.08);
			box-shadow:
				-8px 0 30px rgba(0, 0, 0, 0.3),
				inset 1px 0 0 rgba(255, 255, 255, 0.05);
			transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			z-index: 100;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.agent-panel.open {
			width: 320px;
		}

		/* Main content adjusts when sidebar is open */
		.cr-main {
			transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		body.sidebar-open .cr-main {
			margin-right: 320px;
		}

		/* Panel Header */
		.agent-panel-header {
			padding: 16px 16px 12px;
			/* Reduced padding */
			border-bottom: 1px solid rgba(255, 255, 255, 0.06);
			background: linear-gradient(180deg,
					rgba(217, 119, 6, 0.08) 0%,
					transparent 100%);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.agent-panel-title {
			font-family: var(--cr-font-display);
			font-size: 18px;
			font-weight: 600;
			color: var(--cr-text-primary);
			letter-spacing: -0.02em;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.agent-panel-title::before {
			content: '';
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--cr-accent);
			box-shadow: 0 0 10px var(--cr-accent-glow);
		}

		.agent-panel-close {
			width: 32px;
			height: 32px;
			border-radius: 8px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.08);
			color: var(--cr-text-secondary);
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.agent-panel-close:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--cr-accent);
			color: var(--cr-text-primary);
		}

		/* Panel Content */
		.agent-panel-content {
			flex: 1;
			overflow-y: auto;
			padding: 10px;
			/* Reduced from 16px */
			height: 100%;
			/* Ensure full height usage for scrolling */
		}

		.agent-panel-content::-webkit-scrollbar {
			width: 4px;
			/* Thinner scrollbar */
		}

		.agent-panel-content::-webkit-scrollbar-track {
			background: transparent;
		}

		.agent-panel-content::-webkit-scrollbar-thumb {
			background: rgba(217, 119, 6, 0.2);
			border-radius: 3px;
		}

		.agent-panel-content::-webkit-scrollbar-thumb:hover {
			background: rgba(217, 119, 6, 0.4);
		}

		/* Panel Agent Cards */
		.agent-panel .agent-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.06);
			border-radius: 10px;
			/* Tighter radius */
			padding: 12px;
			/* Reduced from 16px */
			margin-bottom: 8px;
			/* Reduced from 12px */
			transition: all 0.2s ease;
			position: relative;
			overflow: hidden;
		}

		.agent-panel .agent-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 1px;
			background: linear-gradient(90deg,
					transparent 0%,
					rgba(255, 255, 255, 0.1) 50%,
					transparent 100%);
		}

		.agent-panel .agent-card:hover {
			background: rgba(255, 255, 255, 0.05);
			border-color: rgba(217, 119, 6, 0.3);
			transform: translateY(-2px);
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
		}

		.agent-panel .agent-card.selected {
			background: rgba(217, 119, 6, 0.08);
			border-color: var(--cr-accent);
			box-shadow:
				0 0 0 1px var(--cr-accent),
				0 8px 24px rgba(217, 119, 6, 0.15),
				inset 0 0 40px rgba(217, 119, 6, 0.03);
		}

		.agent-panel .agent-card.selected::after {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 3px;
			background: var(--cr-gradient-accent);
			border-radius: 0 3px 3px 0;
		}

		/* Agent Status Badge - Enhanced styling */
		.agent-panel .agent-status-badge {
			display: inline-flex;
			align-items: center;
			gap: 5px;
			padding: 3px 8px;
			/* Reduced padding */
			border-radius: 20px;
			font-size: 9px;
			/* Slightly smaller text */
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-top: 6px;
			/* Reduced margin */
		}

		.agent-panel .agent-status-badge.idle {
			background: rgba(107, 114, 128, 0.15);
			color: #9ca3af;
		}

		.agent-panel .agent-status-badge.running {
			background: rgba(34, 197, 94, 0.15);
			color: #4ade80;
			animation: statusPulseRunning 2s ease-in-out infinite;
		}

		.agent-panel .agent-status-badge.awaiting {
			background: rgba(251, 191, 36, 0.15);
			color: #fbbf24;
			animation: statusPulseAwaiting 1.5s ease-in-out infinite;
		}

		@keyframes statusPulseRunning {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.7;
			}
		}

		@keyframes statusPulseAwaiting {

			0%,
			100% {
				opacity: 1;
				box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4);
			}

			50% {
				opacity: 0.9;
				box-shadow: 0 0 8px 2px rgba(251, 191, 36, 0.2);
			}
		}

		.agent-panel .agent-status-badge svg {
			width: 10px;
			height: 10px;
		}

		/* Agent Preview Text */
		.agent-panel .agent-preview {
			font-size: 11px;
			color: var(--cr-text-muted);
			margin-top: 8px;
			/* Reduced margin */
			padding: 8px 10px;
			/* Reduced padding */
			background: rgba(0, 0, 0, 0.2);
			border-radius: 6px;
			border-left: 2px solid var(--cr-border);
			line-height: 1.4;
			max-height: 54px;
			/* Adjusted height */
			overflow: hidden;
			position: relative;
		}

		.agent-panel .agent-preview.running {
			border-left-color: #4ade80;
		}

		.agent-panel .agent-preview.awaiting {
			border-left-color: #fbbf24;
		}

		.agent-panel .agent-preview-label {
			font-size: 9px;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			color: var(--cr-text-muted);
			margin-bottom: 4px;
			display: block;
		}

		.agent-panel .agent-preview-text {
			color: var(--cr-text-secondary);
			display: -webkit-box;
			-webkit-line-clamp: 2;
			line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		/* Enhanced agent meta row */
		.agent-panel .agent-card .agent-meta {
			margin-top: 8px;
			/* Reduced margin */
			padding-top: 8px;
			/* Reduced padding */
			border-top: 1px solid rgba(255, 255, 255, 0.05);
		}

		/* Panel Footer */
		.agent-panel-footer {
			padding: 16px 24px;
			border-top: 1px solid rgba(255, 255, 255, 0.06);
			background: rgba(0, 0, 0, 0.2);
		}

		.new-agent-btn {
			width: 100%;
			padding: 12px 20px;
			border-radius: 10px;
			background: linear-gradient(135deg,
					rgba(217, 119, 6, 0.15) 0%,
					rgba(217, 119, 6, 0.08) 100%);
			border: 1px solid rgba(217, 119, 6, 0.3);
			color: var(--cr-accent-hover);
			font-family: var(--cr-font-sans);
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.new-agent-btn:hover {
			background: linear-gradient(135deg,
					rgba(217, 119, 6, 0.25) 0%,
					rgba(217, 119, 6, 0.15) 100%);
			border-color: var(--cr-accent);
			box-shadow: 0 0 20px rgba(217, 119, 6, 0.2);
			transform: translateY(-1px);
		}

		.new-agent-btn svg {
			width: 16px;
			height: 16px;
		}

		/* Updated tab style for Agents toggle */
		.cr-tab.panel-toggle {
			position: relative;
			padding-right: 24px;
			/* Extra space for arrow icon */
		}

		.cr-tab.panel-toggle::after {
			content: '';
			position: absolute;
			top: 50%;
			right: 10px;
			width: 5px;
			height: 5px;
			border-right: 1.5px solid currentColor;
			border-bottom: 1.5px solid currentColor;
			transform: translateY(-50%) rotate(-45deg);
			transition: transform 0.2s ease;
		}

		.cr-tab.panel-toggle.open::after {
			transform: translateY(-50%) rotate(45deg);
		}

		/* ========================================
       Responsive
       ======================================== */
		@media (max-width: 600px) {
			.cr-sidebar {
				display: none;
			}

			:root {
				--cr-sidebar-width: 0px;
			}

			.cr-chat-view {
				padding: 0 12px;
			}

			.cr-tabs {
				gap: 2px;
				padding: 3px;
			}

			.cr-tab {
				padding: 6px 12px;
				font-size: var(--cr-text-xs);
			}

			.agent-panel {
				width: 100%;
				right: -100%;
			}
		}
	</style>

</head>

<body>
	<!-- ========================================
	     HEADER - Minimal Command Bar with Tabs
	     ======================================== -->
	<div class="cr-header minimal">
		<div class="cr-header-left">
			<div class="cr-logo">CR</div>
			<!-- Tab Navigation -->
			<div class="cr-tabs">
				<button class="cr-tab active" id="tabChat" onclick="switchTab('chat')">Chat</button>
				<button class="cr-tab panel-toggle" id="tabAgents" onclick="toggleAgentPanel()">Control Panel</button>
			</div>
		</div>
		<div class="cr-header-right">
			<span class="cr-stats" id="globalStats" style="font-size: 11px; color: var(--cr-text-muted);">$0.00</span>
			<button class="btn icon" id="historyBtn" onclick="toggleConversationHistory()" title="History">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
				</svg>
			</button>
			<button class="btn icon" id="settingsBtn" onclick="toggleSettings()" title="Settings">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="12" cy="12" r="3" />
					<path
						d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
				</svg>
			</button>
		</div>
	</div>

	<!-- ========================================
	     MAIN LAYOUT - Tab-based Views
	     ======================================== -->
	<div class="cr-main">
		<!-- ========================================
		     CHAT VIEW - Clean, focused chat interface
		     ======================================== -->
		<div class="cr-view cr-chat-view active" id="chatView">
			<!-- Output Panel -->
			<div class="output-panel">
				<div class="chat-container" id="chatContainer">
					<div class="messages" id="messages">
						<!-- Empty state shown when no messages -->
						<div class="empty-state" id="emptyState">
							<svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="1.5">
								<path d="M12 3v18m9-9H3" />
							</svg>
							<div class="empty-state-title">What can I help you build?</div>
							<div class="empty-state-text">I can help you write code, debug issues, refactor projects,
								and explore your codebase.</div>
						</div>
					</div>

					<!-- WSL Alert for Windows users -->
					<div id="wslAlert" class="wsl-alert" style="display: none;">
						<div class="wsl-alert-content">
							<div class="wsl-alert-icon">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
									stroke-width="2">
									<rect x="2" y="3" width="20" height="14" rx="2" />
									<path d="M8 21h8m-4-4v4" />
								</svg>
							</div>
							<div class="wsl-alert-text">
								<strong>Windows detected</strong><br />
								Enable WSL integration in settings if using WSL.
							</div>
							<div class="wsl-alert-actions">
								<button class="btn primary small" onclick="openWSLSettings()">Enable</button>
								<button class="btn secondary small" onclick="dismissWSLAlert()">Dismiss</button>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Tool Approval Area -->
			<div class="tool-approval-area" id="toolApprovalArea">
				<!-- Tool approval cards will be inserted here dynamically -->
			</div>

			<!-- Streamlined Input Area -->
			<div class="input-container streamlined" id="inputContainer" style="position: relative;">
				<div class="slash-command-menu" id="slashCommandMenu">
					<!-- Dynamically populated -->
				</div>
				<div class="textarea-container">
					<div class="textarea-wrapper">
						<textarea class="input-field" id="messageInput"
							placeholder="Message Claude... (@ for files, / for commands)" rows="1"></textarea>
						<div class="input-controls">
							<div class="left-controls">
								<button class="model-selector" id="modelSelector" onclick="showModelSelector()"
									title="Select model">
									<span id="selectedModel">Opus</span>
									<svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor">
										<path d="M1 2.5l3 3 3-3"></path>
									</svg>
								</button>
							</div>
							<div class="right-controls">
								<button class="slash-btn" onclick="showSlashCommandsModal()" title="Commands">/</button>
								<button class="at-btn" onclick="showFilePicker()" title="Files">@</button>
								<button class="image-btn" id="imageBtn" onclick="selectImage()" title="Images">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
										<g fill="currentColor">
											<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0"></path>
											<path
												d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2zm13 1a.5.5 0 0 1 .5.5v6l-3.775-1.947a.5.5 0 0 0-.577.093l-3.71 3.71l-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12v.54L1 12.5v-9a.5.5 0 0 1 .5-.5z">
											</path>
										</g>
									</svg>
								</button>
								<button class="send-btn" id="sendBtn" onclick="sendMessage()">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
										<path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
									</svg>
								</button>
							</div>
						</div>
					</div>
					<button class="btn danger small" id="stopBtn" onclick="stopRequest()"
						style="display: none; margin-left: 8px;">
						Stop
					</button>
				</div>
				<!-- Claude Code Mode Toggle -->
				<div class="mode-toggle-bar">
					<div class="mode-toggle-container">
						<button class="mode-toggle-option" data-mode="plan" onclick="setEditMode('plan')"
							title="Plan changes without making edits">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
								<polyline points="14 2 14 8 20 8" />
								<line x1="16" y1="13" x2="8" y2="13" />
								<line x1="16" y1="17" x2="8" y2="17" />
								<polyline points="10 9 9 9 8 9" />
							</svg>
							<span>Planning Mode</span>
						</button>
						<div class="mode-toggle-separator"></div>
						<button class="mode-toggle-option" data-mode="auto" onclick="setEditMode('auto')"
							title="Automatically apply edits">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
							</svg>
							<span>Edit Automatically</span>
						</button>
						<div class="mode-toggle-separator"></div>
						<button class="mode-toggle-option active" data-mode="ask" onclick="setEditMode('ask')"
							title="Ask before making edits">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
								<path d="M9 12l2 2 4-4" />
							</svg>
							<span>Ask Before Edits</span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- ========================================
	     AGENTS VIEW - Hidden for compatibility
	     ======================================== -->
		<div class="cr-view cr-agents-view" id="agentsView" style="display: none !important;">
			<div class="cr-agents-header">
				<h2 class="cr-agents-title">Agents</h2>
				<button class="btn primary" id="newAgentBtn" onclick="newSession()">+ New Agent</button>
			</div>
			<div class="cr-agents-grid" id="agentList">
				<!-- Agent Card -->
				<div class="agent-card grid-card selected" id="agent-default" onclick="selectAgentAndSwitch('default')">
					<div class="agent-card-header">
						<span class="agent-name">Agent 1</span>
						<span class="status-dot idle" id="agent-default-status"></span>
					</div>
					<div class="agent-task" id="agent-default-task">Ready for input</div>
					<div class="agent-meta">
						<span class="agent-cost" id="agent-default-cost">$0.00</span>
						<span class="agent-time" id="agent-default-time">--</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Hidden elements for compatibility -->
		<div style="display: none;">
			<span id="selectedAgentStatus"></span>
			<span id="selectedAgentName"></span>
			<span id="selectedAgentTask"></span>
			<button id="checkpointBtn"></button>
			<div id="planModeSwitch"></div>
			<div id="thinkingModeSwitch"></div>
			<span id="thinkingModeLabel"></span>
		</div>
	</div>

	<!-- ========================================
	     GLASSMORPHIC AGENT PANEL (Pop-out)
	     ======================================== -->
	<div class="agent-panel-overlay" id="agentPanelOverlay" onclick="toggleAgentPanel()"></div>

	<div class="agent-panel" id="agentPanel">
		<div class="agent-panel-header">
			<span class="agent-panel-title">Control Panel</span>
			<button class="agent-panel-close" onclick="toggleAgentPanel()" title="Close panel">
				<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M6 18L18 6M6 6l12 12" />
				</svg>
			</button>
		</div>

		<div class="agent-panel-content" id="agentPanelList">
			<!-- Agent cards will be dynamically populated here -->
			<div class="agent-card selected" id="panel-agent-default" onclick="selectAgentFromPanel('default')">
				<div class="agent-card-header">
					<span class="agent-name">Agent 1</span>
					<span class="status-dot idle" id="panel-agent-default-dot"></span>
				</div>

				<!-- Status Badge -->
				<div class="agent-status-badge idle" id="panel-agent-default-status">
					<svg viewBox="0 0 24 24" fill="currentColor">
						<circle cx="12" cy="12" r="4" />
					</svg>
					<span id="panel-agent-default-status-text">Idle</span>
				</div>

				<!-- Live Preview -->
				<div class="agent-preview" id="panel-agent-default-preview">
					<span class="agent-preview-label">Current Activity</span>
					<span class="agent-preview-text" id="panel-agent-default-preview-text">Ready for input</span>
				</div>

				<div class="agent-meta">
					<span class="agent-cost" id="panel-agent-default-cost">$0.00</span>
					<span class="agent-time" id="panel-agent-default-time">--</span>
				</div>
			</div>
		</div>

		<div class="agent-panel-footer">
			<button class="new-agent-btn" onclick="newSession()">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 5v14M5 12h14" />
				</svg>
				New Agent
			</button>
		</div>
	</div>

	<!-- Status indicator (hidden, used for JS state tracking) -->
	<div id="status" class="sr-only" style="display: none;">
		<span id="statusText">Ready</span>
	</div>

	<!-- YOLO Warning -->
	<div id="yoloWarning" class="yolo-warning" style="display: none;">
		<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
			<path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5zM11 10v4h2v-4h-2zm0 6v2h2v-2h-2z" />
		</svg>
		<span>Yolo Mode Active: Claude Code will auto-approve all tool requests.</span>
	</div>

	<!-- ========================================
	     MODALS
	     ======================================== -->

	<!-- Conversation History Panel -->
	<div id="conversationHistory" class="conversation-history" style="display: none;">
		<div class="conversation-header">
			<h3>Conversation History</h3>
			<button class="btn icon" onclick="toggleConversationHistory()">
				<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M6 18L18 6M6 6l12 12" />
				</svg>
			</button>
		</div>
		<div id="conversationList" class="conversation-list">
			<!-- Conversations will be loaded here -->
		</div>
	</div>

	<!-- File picker modal -->
	<div id="filePickerModal" class="modal file-picker-modal" style="display: none;">
		<div class="modal-content file-picker-content">
			<div class="modal-header file-picker-header">
				<span>Select File</span>
				<input type="text" id="fileSearchInput" placeholder="Search files..." class="file-search-input">
			</div>
			<div id="fileList" class="file-list">
				<!-- Files will be loaded here -->
			</div>
		</div>
	</div>

	<!-- MCP Servers modal -->
	<div id="mcpModal" class="modal tools-modal" style="display: none;">
		<div class="modal-content tools-modal-content">
			<div class="modal-header tools-modal-header">
				<span>MCP Servers</span>
				<button class="btn icon close-btn" onclick="hideMCPModal()">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="tools-list">
				<div class="mcp-servers-list" id="mcpServersList">
					<!-- MCP servers will be loaded here -->
				</div>
				<div class="mcp-add-server">
					<button class="btn secondary" onclick="showAddServerForm()" id="addServerBtn">+ Add MCP
						Server</button>
				</div>
				<div class="mcp-popular-servers" id="popularServers">
					<h4>Popular MCP Servers</h4>
					<div class="popular-servers-grid">
						<div class="popular-server-item"
							onclick="addPopularServer('context7', { type: 'http', url: 'https://context7.liam.sh/mcp' })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v-1H6.5A2.5 2.5 0 0 0 4 18.5v1zM6.5 2H20v13H6.5a3.5 3.5 0 0 0-2.5 1.062V4.5A2.5 2.5 0 0 1 6.5 2z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Context7</div>
								<div class="popular-server-desc">Up-to-date Code Docs</div>
							</div>
						</div>
						<div class="popular-server-item"
							onclick="addPopularServer('sequential-thinking', { type: 'stdio', command: 'npx', args: ['-y', '@modelcontextprotocol/server-sequential-thinking'] })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Sequential Thinking</div>
								<div class="popular-server-desc">Step-by-step reasoning</div>
							</div>
						</div>
						<div class="popular-server-item"
							onclick="addPopularServer('memory', { type: 'stdio', command: 'npx', args: ['-y', '@modelcontextprotocol/server-memory'] })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2a9 9 0 0 0-9 9c0 4.17 2.84 7.67 6.69 8.69L12 22l2.31-2.31C18.16 18.67 21 15.17 21 11a9 9 0 0 0-9-9zm0 13c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Memory</div>
								<div class="popular-server-desc">Knowledge graph storage</div>
							</div>
						</div>
						<div class="popular-server-item"
							onclick="addPopularServer('puppeteer', { type: 'stdio', command: 'npx', args: ['-y', '@modelcontextprotocol/server-puppeteer'] })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Puppeteer</div>
								<div class="popular-server-desc">Browser automation</div>
							</div>
						</div>
						<div class="popular-server-item"
							onclick="addPopularServer('fetch', { type: 'stdio', command: 'npx', args: ['-y', '@modelcontextprotocol/server-fetch'] })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Fetch</div>
								<div class="popular-server-desc">HTTP requests & scraping</div>
							</div>
						</div>
						<div class="popular-server-item"
							onclick="addPopularServer('filesystem', { type: 'stdio', command: 'npx', args: ['-y', '@modelcontextprotocol/server-filesystem'] })">
							<div class="popular-server-icon">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" />
								</svg>
							</div>
							<div class="popular-server-info">
								<div class="popular-server-name">Filesystem</div>
								<div class="popular-server-desc">File operations</div>
							</div>
						</div>
					</div>
				</div>
				<div class="mcp-add-form" id="addServerForm" style="display: none;">
					<div class="form-group">
						<label for="serverName">Server Name:</label>
						<input type="text" id="serverName" placeholder="my-server" required>
					</div>
					<div class="form-group">
						<label for="serverType">Server Type:</label>
						<select id="serverType" onchange="updateServerForm()">
							<option value="http">HTTP</option>
							<option value="sse">SSE</option>
							<option value="stdio">stdio</option>
						</select>
					</div>
					<div class="form-group" id="commandGroup" style="display: none;">
						<label for="serverCommand">Command:</label>
						<input type="text" id="serverCommand" placeholder="/path/to/server">
					</div>
					<div class="form-group" id="urlGroup">
						<label for="serverUrl">URL:</label>
						<input type="text" id="serverUrl" placeholder="https://example.com/mcp">
					</div>
					<div class="form-group" id="argsGroup" style="display: none;">
						<label for="serverArgs">Arguments (one per line):</label>
						<textarea id="serverArgs" placeholder="--api-key&#10;abc123" rows="3"></textarea>
					</div>
					<div class="form-group" id="envGroup" style="display: none;">
						<label for="serverEnv">Environment Variables (KEY=value, one per line):</label>
						<textarea id="serverEnv" placeholder="API_KEY=123&#10;CACHE_DIR=/tmp" rows="3"></textarea>
					</div>
					<div class="form-group" id="headersGroup">
						<label for="serverHeaders">Headers (KEY=value, one per line):</label>
						<textarea id="serverHeaders" placeholder="Authorization=Bearer token&#10;X-API-Key=key"
							rows="3"></textarea>
					</div>
					<div class="form-buttons">
						<button class="btn primary" onclick="saveMCPServer()">Add Server</button>
						<button class="btn secondary" onclick="hideAddServerForm()">Cancel</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Settings modal -->
	<div id="settingsModal" class="modal tools-modal" style="display: none;">
		<div class="modal-content tools-modal-content">
			<div class="modal-header tools-modal-header">
				<span>Settings</span>
				<button class="btn icon close-btn" onclick="hideSettingsModal()">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="tools-list settings-list">
				<div class="settings-section">
					<h3>WSL Configuration</h3>
					<p class="settings-description">
						WSL integration allows you to run Claude Code from within Windows Subsystem for Linux.
						This is useful if you have Claude installed in WSL instead of Windows.
					</p>
					<div class="settings-group">
						<div class="tool-item">
							<input type="checkbox" id="wsl-enabled" onchange="updateSettings()">
							<label for="wsl-enabled">Enable WSL Integration</label>
						</div>

						<div id="wslOptions" class="wsl-options" style="display: none;">
							<div class="form-group">
								<label for="wsl-distro">WSL Distribution</label>
								<input type="text" id="wsl-distro" class="form-input" placeholder="Ubuntu"
									onchange="updateSettings()">
							</div>

							<div class="form-group">
								<label for="wsl-node-path">Node.js Path in WSL</label>
								<input type="text" id="wsl-node-path" class="form-input" placeholder="/usr/bin/node"
									onchange="updateSettings()">
								<p class="form-hint">
									Find your node installation path in WSL by running: <code>which node</code>
								</p>
							</div>

							<div class="form-group">
								<label for="wsl-claude-path">Claude Path in WSL</label>
								<input type="text" id="wsl-claude-path" class="form-input"
									placeholder="/usr/local/bin/claude" onchange="updateSettings()">
								<p class="form-hint">
									Find your claude installation path in WSL by running: <code>which claude</code>
								</p>
							</div>
						</div>
					</div>
				</div>

				<div class="settings-section">
					<h3>Permissions</h3>
					<p class="settings-description">
						Manage commands and tools that are automatically allowed without asking for permission.
					</p>
					<div class="settings-group">
						<div id="permissionsList" class="permissions-list">
							<div class="permissions-loading">
								Loading permissions...
							</div>
						</div>
						<div class="permissions-add-section">
							<div id="addPermissionForm" class="permissions-add-form" style="display: none;">
								<div class="permissions-form-row">
									<select id="addPermissionTool" class="permissions-tool-select"
										onchange="toggleCommandInput()">
										<option value="">Select tool...</option>
										<option value="Bash">Bash</option>
										<option value="Read">Read</option>
										<option value="Edit">Edit</option>
										<option value="Write">Write</option>
										<option value="MultiEdit">MultiEdit</option>
										<option value="Glob">Glob</option>
										<option value="Grep">Grep</option>
										<option value="LS">LS</option>
										<option value="WebSearch">WebSearch</option>
										<option value="WebFetch">WebFetch</option>
									</select>
									<div class="permissions-command-wrapper">
										<input type="text" id="addPermissionCommand" class="permissions-command-input"
											placeholder="Command pattern (e.g., npm i *)" style="display: none;" />
									</div>
									<button id="addPermissionBtn" class="btn primary small permissions-add-btn"
										onclick="addPermission()">Add</button>
								</div>
								<div id="permissionsFormHint" class="permissions-form-hint">
									Select a tool to add always-allow permission.
								</div>
							</div>
							<button id="showAddPermissionBtn" class="btn secondary permissions-show-add-btn"
								onclick="showAddPermissionForm()">
								+ Add permission
							</button>
							<div class="yolo-mode-section">
								<input type="checkbox" id="yolo-mode" onchange="updateSettings(); updateYoloWarning();">
								<label for="yolo-mode">Enable Yolo Mode (Auto-allow all permissions)</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Model selector modal -->
	<div id="modelModal" class="modal tools-modal" style="display: none;">
		<div class="modal-content tools-modal-content model-modal-content">
			<div class="modal-header tools-modal-header">
				<span>Enforce Model</span>
				<button class="btn icon close-btn" onclick="hideModelModal()">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="model-explanatory-text">
				This overrides your default model setting for this conversation only.
			</div>
			<div class="tools-list model-list">
				<div class="tool-item model-item" onclick="selectModel('opus')">
					<input type="radio" name="model" id="model-opus" value="opus" checked>
					<label for="model-opus">
						<div class="model-title">Opus 4.5  Most capable model</div>
						<div class="model-description">
							Best for complex tasks and highest quality output
						</div>
					</label>
				</div>
				<div class="tool-item model-item" onclick="selectModel('sonnet')">
					<input type="radio" name="model" id="model-sonnet" value="sonnet">
					<label for="model-sonnet">
						<div class="model-title">Sonnet 4.5  Balanced model</div>
						<div class="model-description">
							Good balance of speed and capability
						</div>
					</label>
				</div>
				<div class="tool-item model-item" onclick="selectModel('default')">
					<input type="radio" name="model" id="model-default" value="default">
					<label for="model-default" class="default-model-layout">
						<div class="model-option-content">
							<div class="model-title">Default - User configured</div>
							<div class="model-description">
								Uses the model configured in your settings
							</div>
						</div>
						<button class="btn secondary small configure-button"
							onclick="event.stopPropagation(); openModelTerminal();">
							Configure
						</button>
					</label>
				</div>
			</div>
		</div>
	</div>

	<!-- Install Claude Code modal -->
	<div id="installModal" class="modal install-modal" style="display: none;">
		<div class="install-modal-backdrop" onclick="hideInstallModal()"></div>
		<div class="modal-content install-modal-content">
			<button class="btn icon close-btn install-close-btn" onclick="hideInstallModal()">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M6 18L18 6M6 6l12 12" />
				</svg>
			</button>

			<div class="install-body" id="installBody">
				<div class="install-main" id="installMain">
					<div class="install-icon-wrapper">
						<svg class="install-icon" width="40" height="40" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="1.5">
							<path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" stroke-linecap="round"
								stroke-linejoin="round" />
							<path d="M12 3V15M12 15L7 10M12 15L17 10" stroke-linecap="round" stroke-linejoin="round" />
						</svg>
					</div>
					<div class="install-text">
						<h2 class="install-title">Install Claude Code</h2>
						<p class="install-desc">The CLI is required to use this extension</p>
					</div>

					<button class="btn primary install-btn" id="installMainBtn" onclick="startInstallation()">
						Install Now
					</button>

					<a href="https://docs.anthropic.com/en/docs/claude-code" target="_blank" class="install-link">
						View documentation
					</a>
				</div>

				<div class="install-progress" id="installProgress" style="display: none;">
					<div class="install-spinner"></div>
					<p class="install-progress-text">Installing Claude Code...</p>
					<p class="install-progress-hint">This may take a minute</p>
				</div>

				<div class="install-success" id="installSuccess" style="display: none;">
					<div class="install-success-icon">
						<svg class="install-check" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2.5">
							<polyline points="20 6 9 17 4 12"></polyline>
						</svg>
					</div>
					<p class="install-success-text">Installation Complete</p>
					<p class="install-success-hint">Send a message to get started</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Thinking intensity modal -->
	<div id="thinkingIntensityModal" class="modal tools-modal" style="display: none;">
		<div class="modal-content tools-modal-content thinking-modal-content">
			<div class="modal-header tools-modal-header">
				<span>Thinking Mode Intensity</span>
				<button class="btn icon close-btn" onclick="hideThinkingIntensityModal()">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="thinking-modal-description">
				Configure the intensity of thinking mode. Higher levels provide more detailed reasoning but consume more
				tokens.
			</div>
			<div class="tools-list">
				<div class="thinking-slider-container">
					<input type="range" min="0" max="3" value="0" step="1" class="thinking-slider"
						id="thinkingIntensitySlider" oninput="updateThinkingIntensityDisplay(this.value)">
					<div class="slider-labels">
						<div class="slider-label active" id="thinking-label-0" onclick="setThinkingIntensityValue(0)">
							Think</div>
						<div class="slider-label" id="thinking-label-1" onclick="setThinkingIntensityValue(1)">Think
							Hard</div>
						<div class="slider-label" id="thinking-label-2" onclick="setThinkingIntensityValue(2)">Think
							Harder</div>
						<div class="slider-label" id="thinking-label-3" onclick="setThinkingIntensityValue(3)">
							Ultrathink</div>
					</div>
				</div>
				<div class="thinking-modal-actions">
					<button class="btn primary confirm-btn" onclick="confirmThinkingIntensity()">Confirm</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Slash commands modal -->
	<div id="slashCommandsModal" class="modal tools-modal" style="display: none;">
		<div class="modal-content tools-modal-content slash-modal-content">
			<div class="modal-header tools-modal-header">
				<span>Commands & Prompt Snippets</span>
				<button class="btn icon close-btn" onclick="hideSlashCommandsModal()">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>
			<div class="tools-modal-body">

				<!-- Search box -->
				<div class="slash-commands-search">
					<div class="search-input-wrapper">
						<span class="search-prefix">/</span>
						<input type="text" id="slashCommandsSearch" placeholder="Search commands and snippets..."
							oninput="filterSlashCommands()">
					</div>
				</div>

				<!-- Custom Commands Section -->
				<div class="slash-commands-section">
					<h3>Custom Commands</h3>
					<div class="slash-commands-info">
						<p>Custom slash commands for quick prompt access. Click to use directly in chat.</p>
					</div>
					<div class="slash-commands-list" id="promptSnippetsList">
						<!-- Add Custom Snippet Button -->
						<div class="slash-command-item add-snippet-item" onclick="showAddSnippetForm()">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">Add Custom Command</div>
								<div class="slash-command-description">Create your own slash command</div>
							</div>
						</div>

						<!-- Add Custom Command Form (initially hidden) -->
						<div class="add-snippet-form" id="addSnippetForm" style="display: none;">
							<div class="form-group">
								<label for="snippetName">Command name:</label>
								<div class="command-input-wrapper">
									<span class="command-prefix">/</span>
									<input type="text" id="snippetName" placeholder="e.g., fix-bug" maxlength="50">
								</div>
							</div>
							<div class="form-group">
								<label for="snippetPrompt">Prompt Text:</label>
								<textarea id="snippetPrompt" placeholder="e.g., Help me fix this bug in my code..."
									rows="3"></textarea>
							</div>
							<div class="form-buttons">
								<button class="btn primary" onclick="saveCustomSnippet()">Save Command</button>
								<button class="btn secondary" onclick="hideAddSnippetForm()">Cancel</button>
							</div>
						</div>

						<!-- Built-in Snippets -->
						<div class="slash-command-item prompt-snippet-item"
							onclick="usePromptSnippet('performance-analysis')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.94 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.28 2.28C6.08 17.99 4 15.21 4 12c0-4.08 3.05-7.44 7-7.93V2.05z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/performance-analysis</div>
								<div class="slash-command-description">Analyze this code for performance issues and
									suggest optimizations</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item"
							onclick="usePromptSnippet('security-review')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/security-review</div>
								<div class="slash-command-description">Review this code for security vulnerabilities
								</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item"
							onclick="usePromptSnippet('implementation-review')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/implementation-review</div>
								<div class="slash-command-description">Review the implementation in this code</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item"
							onclick="usePromptSnippet('code-explanation')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v-1H6.5A2.5 2.5 0 0 0 4 18.5v1zM6.5 2H20v13H6.5a3.5 3.5 0 0 0-2.5 1.062V4.5A2.5 2.5 0 0 1 6.5 2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/code-explanation</div>
								<div class="slash-command-description">Explain how this code works in detail</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item" onclick="usePromptSnippet('bug-fix')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M20 8h-2.81a5.985 5.985 0 0 0-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/bug-fix</div>
								<div class="slash-command-description">Help me fix this bug in my code</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item" onclick="usePromptSnippet('refactor')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/refactor</div>
								<div class="slash-command-description">Refactor this code to improve readability and
									maintainability</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item"
							onclick="usePromptSnippet('test-generation')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M7 13h2v2H7v-2zm14-6v14c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2zm-2 0H5v14h14V7zm-4 6h-2v2h2v-2zm-4 0h-2v2h2v-2zm8-4H7v2h10V9zm-4 8h-2v2h2v-2zm4 0h-2v2h2v-2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/test-generation</div>
								<div class="slash-command-description">Generate comprehensive tests for this code</div>
							</div>
						</div>
						<div class="slash-command-item prompt-snippet-item" onclick="usePromptSnippet('documentation')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/documentation</div>
								<div class="slash-command-description">Generate documentation for this code</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Built-in Commands Section -->
				<div class="slash-commands-section">
					<h3>Built-in Commands</h3>
					<div class="slash-commands-info">
						<p>These commands require the Claude CLI and will open in VS Code terminal. Return here after
							completion.</p>
					</div>
					<div class="slash-commands-list" id="nativeCommandsList">
						<div class="slash-command-item" onclick="executeSlashCommand('add-dir')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 8h-3v3h-2v-3h-3v-2h3V9h2v3h3v2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/add-dir</div>
								<div class="slash-command-description">Add additional working directories</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('clear')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/clear</div>
								<div class="slash-command-description">Clear conversation history</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('compact')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path d="M8 11h3v10h2V11h3l-4-4-4 4zM4 3v2h16V3H4z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/compact</div>
								<div class="slash-command-description">Compact conversation with optional focus
									instructions</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('config')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/config</div>
								<div class="slash-command-description">Open the Settings interface</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('cost')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/cost</div>
								<div class="slash-command-description">Show token usage statistics</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('doctor')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/doctor</div>
								<div class="slash-command-description">Checks the health of your Claude Code
									installation</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('help')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/help</div>
								<div class="slash-command-description">Get usage help</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('init')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/init</div>
								<div class="slash-command-description">Initialize project with CLAUDE.md guide</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('login')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/login</div>
								<div class="slash-command-description">Switch Anthropic accounts</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('logout')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/logout</div>
								<div class="slash-command-description">Sign out from your Anthropic account</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('model')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6V7h12v12zm-9-6c-.83 0-1.5-.67-1.5-1.5S8.17 10 9 10s1.5.67 1.5 1.5S9.83 13 9 13zm7.5-1.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5zM8 15h8v2H8v-2z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/model</div>
								<div class="slash-command-description">Select or change the AI model</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('permissions')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/permissions</div>
								<div class="slash-command-description">View or update permissions</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('review')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/review</div>
								<div class="slash-command-description">Request code review</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('status')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path
										d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/status</div>
								<div class="slash-command-description">Open the Settings interface (Status tab)</div>
							</div>
						</div>
						<div class="slash-command-item" onclick="executeSlashCommand('usage')">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">/usage</div>
								<div class="slash-command-description">Show plan usage limits and rate limit status
								</div>
							</div>
						</div>
						<div class="slash-command-item custom-command-item">
							<div class="slash-command-icon">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
									<path d="M13 10V3L4 14h7v7l9-11h-7z" />
								</svg>
							</div>
							<div class="slash-command-content">
								<div class="slash-command-title">Quick Command</div>
								<div class="slash-command-description">
									<div class="command-input-wrapper">
										<span class="command-prefix">/</span>
										<input type="text" class="custom-command-input" id="customCommandInput"
											placeholder="enter-command" onkeydown="handleCustomCommandKeydown(event)"
											onclick="event.stopPropagation()">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		const vscode = { postMessage: (msg) => console.log("VS Code message:", msg) };
		const messagesDiv = document.getElementById('messages');
		const messageInput = document.getElementById('messageInput');
		const sendBtn = document.getElementById('sendBtn');
		const statusDiv = document.getElementById('status');
		const statusTextDiv = document.getElementById('statusText');
		const filePickerModal = document.getElementById('filePickerModal');
		const fileSearchInput = document.getElementById('fileSearchInput');
		const fileList = document.getElementById('fileList');
		const imageBtn = document.getElementById('imageBtn');

		// Tab Navigation
		let currentTab = 'chat';

		function switchTab(tabName) {
			currentTab = tabName;

			// Update tab buttons
			document.querySelectorAll('.cr-tab').forEach(tab => {
				tab.classList.remove('active');
			});
			document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

			// Update views
			document.querySelectorAll('.cr-view').forEach(view => {
				view.classList.remove('active');
			});
			document.getElementById(tabName + 'View').classList.add('active');

			// Focus input when switching to chat
			if (tabName === 'chat') {
				setTimeout(() => messageInput.focus(), 100);
			}
		}

		function selectAgentAndSwitch(agentId) {
			selectAgent(agentId);
			switchTab('chat');
		}

		// ========================================
		// Agent Panel Control Functions
		// ========================================
		let agentPanelOpen = false;

		function toggleAgentPanel() {
			const panel = document.getElementById('agentPanel');
			const tabBtn = document.getElementById('tabAgents');

			agentPanelOpen = !agentPanelOpen;

			if (agentPanelOpen) {
				panel.classList.add('open');
				tabBtn.classList.add('open');
				document.body.classList.add('sidebar-open');
			} else {
				panel.classList.remove('open');
				tabBtn.classList.remove('open');
				document.body.classList.remove('sidebar-open');
			}
		}

		function selectAgentFromPanel(agentId) {
			selectAgent(agentId);
			// Update selection in panel
			document.querySelectorAll('.agent-panel .agent-card').forEach(card => {
				card.classList.remove('selected');
			});
			const selectedCard = document.getElementById('panel-agent-' + agentId);
			if (selectedCard) {
				selectedCard.classList.add('selected');
			}
			// Sidebar stays open - no auto-close for persistent sidebar
		}

		// Close panel with ESC key
		document.addEventListener('keydown', function (e) {
			if (e.key === 'Escape' && agentPanelOpen) {
				toggleAgentPanel();
			}
		});

		let isProcessRunning = false;
		let filteredFiles = [];
		let selectedFileIndex = -1;
		let planModeEnabled = false;
		let thinkingModeEnabled = false;
		let lastPendingEditIndex = -1; // Track the last Edit/MultiEdit/Write toolUse without result
		let lastPendingEditData = null; // Store diff data for the pending edit { filePath, oldContent, newContent }

		// Edit mode state: 'plan' | 'auto' | 'ask'
		let currentEditMode = 'ask'; // Default to ask before edits (safest option)

		// Set edit mode and update UI
		function setEditMode(mode) {
			currentEditMode = mode;

			// Update button states
			document.querySelectorAll('.mode-toggle-option').forEach(btn => {
				btn.classList.remove('active');
			});
			const activeBtn = document.querySelector(`.mode-toggle-option[data-mode="${mode}"]`);
			if (activeBtn) {
				activeBtn.classList.add('active');
			}

			// Update planModeEnabled based on mode
			planModeEnabled = (mode === 'plan');

			// Notify VS Code of mode change
			vscode.postMessage({
				type: 'setEditMode',
				mode: mode
			});
		}

		// Open diff using stored data (no file read needed)
		function openDiffEditor() {
			if (lastPendingEditData) {
				vscode.postMessage({
					type: 'openDiff',
					filePath: lastPendingEditData.filePath,
					oldContent: lastPendingEditData.oldContent,
					newContent: lastPendingEditData.newContent
				});
			}
		}

		function shouldAutoScroll(messagesDiv) {
			const threshold = 100; // pixels from bottom
			const scrollTop = messagesDiv.scrollTop;
			const scrollHeight = messagesDiv.scrollHeight;
			const clientHeight = messagesDiv.clientHeight;

			return (scrollTop + clientHeight >= scrollHeight - threshold);
		}

		function scrollToBottomIfNeeded(messagesDiv, shouldScroll = null) {
			// If shouldScroll is not provided, check current scroll position
			if (shouldScroll === null) {
				shouldScroll = shouldAutoScroll(messagesDiv);
			}

			if (shouldScroll) {
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}
		}

		function addMessage(content, type = 'claude') {
			const messagesDiv = document.getElementById('messages');
			const shouldScroll = shouldAutoScroll(messagesDiv);

			const messageDiv = document.createElement('div');
			messageDiv.className = `message ${type}`;

			// Add header for main message types (excluding system)
			if (type === 'user' || type === 'claude' || type === 'error') {
				const headerDiv = document.createElement('div');
				headerDiv.className = 'message-header';

				const iconDiv = document.createElement('div');
				iconDiv.className = `message-icon ${type}`;

				const labelDiv = document.createElement('div');
				labelDiv.className = 'message-label';

				// Set icon and label based on type
				switch (type) {
					case 'user':
						iconDiv.textContent = '';
						labelDiv.textContent = 'You';
						break;
					case 'claude':
						iconDiv.textContent = '';
						labelDiv.textContent = 'Claude';
						break;
					case 'error':
						iconDiv.textContent = '';
						labelDiv.textContent = 'Error';
						break;
				}

				// Add copy button
				const copyBtn = document.createElement('button');
				copyBtn.className = 'copy-btn';
				copyBtn.title = 'Copy message';
				copyBtn.onclick = () => copyMessageContent(messageDiv);
				copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';

				headerDiv.appendChild(iconDiv);
				headerDiv.appendChild(labelDiv);
				headerDiv.appendChild(copyBtn);
				messageDiv.appendChild(headerDiv);
			}

			// Add content
			const contentDiv = document.createElement('div');
			contentDiv.className = 'message-content';

			if (type == 'user' || type === 'claude' || type === 'thinking') {
				contentDiv.innerHTML = content;
			} else {
				const preElement = document.createElement('pre');
				preElement.textContent = content;
				contentDiv.appendChild(preElement);
			}

			messageDiv.appendChild(contentDiv);

			// Check if this is a permission-related error and add yolo mode button
			if (type === 'error' && isPermissionError(content)) {
				const yoloSuggestion = document.createElement('div');
				yoloSuggestion.className = 'yolo-suggestion';
				yoloSuggestion.innerHTML = `
					<div class="yolo-suggestion-text">
						<span> This looks like a permission issue. You can enable Yolo Mode to skip all permission checks.</span>
					</div>
					<button class="yolo-suggestion-btn" onclick="enableYoloMode()">Enable Yolo Mode</button>
				`;
				messageDiv.appendChild(yoloSuggestion);
			}

			messagesDiv.appendChild(messageDiv);
			moveProcessingIndicatorToLast();
			scrollToBottomIfNeeded(messagesDiv, shouldScroll);
		}


		function addToolUseMessage(data) {
			const messagesDiv = document.getElementById('messages');
			const shouldScroll = shouldAutoScroll(messagesDiv);

			const messageDiv = document.createElement('div');
			messageDiv.className = 'message tool';

			// Create modern header with icon
			const headerDiv = document.createElement('div');
			headerDiv.className = 'tool-header';

			const iconDiv = document.createElement('div');
			iconDiv.className = 'tool-icon';
			iconDiv.textContent = '';

			const toolInfoElement = document.createElement('div');
			toolInfoElement.className = 'tool-info';
			let toolName = data.toolInfo.replace(' Executing: ', '');
			// Replace TodoWrite with more user-friendly name
			if (toolName === 'TodoWrite') {
				toolName = 'Update Todos';
			}
			toolInfoElement.textContent = toolName;

			// Update Control Panel with running status
			setAgentRunning(toolName);

			headerDiv.appendChild(iconDiv);
			headerDiv.appendChild(toolInfoElement);
			messageDiv.appendChild(headerDiv);

			if (data.rawInput) {
				const inputElement = document.createElement('div');
				inputElement.className = 'tool-input';

				const contentDiv = document.createElement('div');
				contentDiv.className = 'tool-input-content';

				// Handle TodoWrite specially or format raw input
				if (data.toolName === 'TodoWrite' && data.rawInput.todos) {
					let todoHtml = 'Todo List Update:';
					for (const todo of data.rawInput.todos) {
						const status = todo.status === 'completed' ? '' :
							todo.status === 'in_progress' ? '' : '';
						todoHtml += '\n' + status + ' ' + todo.content;
					}
					contentDiv.innerHTML = todoHtml;
				} else {
					// Format raw input with expandable content for long values
					// Use diff format for Edit, MultiEdit, and Write tools, regular format for others
					if (data.toolName === 'Edit' || data.toolName === 'MultiEdit' || data.toolName === 'Write') {
						// Only show Open Diff button if we have fileContentBefore (live session, not reload)
						const showButton = data.fileContentBefore !== undefined && data.messageIndex >= 0;

						// Hide any existing pending edit button before showing new one
						if (showButton && lastPendingEditIndex >= 0) {
							const prevContent = document.querySelector('[data-edit-message-index="' + lastPendingEditIndex + '"]');
							if (prevContent) {
								const btn = prevContent.querySelector('.diff-open-btn');
								if (btn) btn.style.display = 'none';
							}
							lastPendingEditData = null;
						}

						if (showButton) {
							lastPendingEditIndex = data.messageIndex;
							contentDiv.setAttribute('data-edit-message-index', data.messageIndex);

							// Compute and store diff data for when button is clicked
							const oldContent = data.fileContentBefore || '';
							let newContent = oldContent;
							if (data.toolName === 'Edit' && data.rawInput.old_string && data.rawInput.new_string) {
								newContent = oldContent.replace(data.rawInput.old_string, data.rawInput.new_string);
							} else if (data.toolName === 'MultiEdit' && data.rawInput.edits) {
								for (const edit of data.rawInput.edits) {
									if (edit.old_string && edit.new_string) {
										newContent = newContent.replace(edit.old_string, edit.new_string);
									}
								}
							} else if (data.toolName === 'Write' && data.rawInput.content) {
								newContent = data.rawInput.content;
							}
							lastPendingEditData = {
								filePath: data.rawInput.file_path,
								oldContent: oldContent,
								newContent: newContent
							};
						}

						if (data.toolName === 'Edit') {
							contentDiv.innerHTML = formatEditToolDiff(data.rawInput, data.fileContentBefore, showButton, data.startLine);
						} else if (data.toolName === 'MultiEdit') {
							contentDiv.innerHTML = formatMultiEditToolDiff(data.rawInput, data.fileContentBefore, showButton, data.startLines);
						} else {
							contentDiv.innerHTML = formatWriteToolDiff(data.rawInput, data.fileContentBefore, showButton);
						}
					} else {
						contentDiv.innerHTML = formatToolInputUI(data.rawInput);
					}
				}

				inputElement.appendChild(contentDiv);
				messageDiv.appendChild(inputElement);
			} else if (data.toolInput) {
				// Fallback for pre-formatted input
				const inputElement = document.createElement('div');
				inputElement.className = 'tool-input';

				const labelDiv = document.createElement('div');
				labelDiv.className = 'tool-input-label';
				labelDiv.textContent = 'INPUT';
				inputElement.appendChild(labelDiv);

				const contentDiv = document.createElement('div');
				contentDiv.className = 'tool-input-content';
				contentDiv.textContent = data.toolInput;
				inputElement.appendChild(contentDiv);
				messageDiv.appendChild(inputElement);
			}

			messagesDiv.appendChild(messageDiv);
			moveProcessingIndicatorToLast();
			scrollToBottomIfNeeded(messagesDiv, shouldScroll);
		}

		function createExpandableInput(toolInput, rawInput) {
			try {
				let html = toolInput.replace(/\[expand\]/g, '<span class="expand-btn" onclick="toggleExpand(this)">expand</span>');

				// Store raw input data for expansion
				if (rawInput && typeof rawInput === 'object') {
					let btnIndex = 0;
					html = html.replace(/<span class="expand-btn"[^>]*>expand<\/span>/g, (match) => {
						const keys = Object.keys(rawInput);
						const key = keys[btnIndex] || '';
						const value = rawInput[key] || '';
						const valueStr = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
						const escapedValue = valueStr.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
						btnIndex++;
						return `<span class="expand-btn" data-key="${key}" data-value="${escapedValue}" onclick="toggleExpand(this)">expand</span>`;
					});
				}

				return html;
			} catch (error) {
				console.error('Error creating expandable input:', error);
				return toolInput;
			}
		}


		function addToolResultMessage(data) {
			const messagesDiv = document.getElementById('messages');
			const shouldScroll = shouldAutoScroll(messagesDiv);

			// When result comes in for Edit/MultiEdit/Write, hide the Open Diff button on the request
			// since the edit has now been applied (no longer pending)
			if (lastPendingEditIndex >= 0) {
				// Find and hide the button on the corresponding toolUse
				const toolUseContent = document.querySelector('[data-edit-message-index="' + lastPendingEditIndex + '"]');
				if (toolUseContent) {
					const btn = toolUseContent.querySelector('.diff-open-btn');
					if (btn) {
						btn.style.display = 'none';
					}
				}
				lastPendingEditIndex = -1;
				lastPendingEditData = null;
			}

			// For Read and TodoWrite tools, just hide loading state (no result message needed)
			if ((data.toolName === 'Read' || data.toolName === 'TodoWrite') && !data.isError) {
				return;
			}

			// For Edit/MultiEdit/Write, show simple completion message (diff is already shown on request)
			if ((data.toolName === 'Edit' || data.toolName === 'MultiEdit' || data.toolName === 'Write') && !data.isError) {
				let completionText;
				if (data.toolName === 'Edit') {
					completionText = ' Edit completed';
				} else if (data.toolName === 'MultiEdit') {
					completionText = ' MultiEdit completed';
				} else {
					completionText = ' Write completed';
				}
				addMessage(completionText, 'system');
				scrollToBottomIfNeeded(messagesDiv, shouldScroll);
				return;
			}

			if (data.isError && data.content?.includes("File has not been read yet. Read it first before writing to it.")) {
				return addMessage("File has not been read yet. Let me read it first before writing to it.", 'system');
			}

			const messageDiv = document.createElement('div');
			messageDiv.className = data.isError ? 'message error' : 'message tool-result';

			// Create header
			const headerDiv = document.createElement('div');
			headerDiv.className = 'message-header';

			const iconDiv = document.createElement('div');
			iconDiv.className = data.isError ? 'message-icon error' : 'message-icon';
			iconDiv.style.background = data.isError ?
				'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' :
				'linear-gradient(135deg, #1cc08c 0%, #16a974 100%)';
			iconDiv.textContent = data.isError ? '' : '';

			const labelDiv = document.createElement('div');
			labelDiv.className = 'message-label';
			labelDiv.textContent = data.isError ? 'Error' : 'Result';

			headerDiv.appendChild(iconDiv);
			headerDiv.appendChild(labelDiv);
			messageDiv.appendChild(headerDiv);

			// Add content
			const contentDiv = document.createElement('div');
			contentDiv.className = 'message-content';

			// Check if it's a tool result and truncate appropriately
			let content = data.content;

			// Clean up error messages by removing XML-like tags
			if (data.isError && content) {
				content = content.replace(/<tool_use_error>/g, '').replace(/<\/tool_use_error>/g, '').trim();
			}
			if (content.length > 200 && !data.isError) {
				const truncateAt = 197;
				const truncated = content.substring(0, truncateAt);
				const resultId = 'result_' + Math.random().toString(36).substr(2, 9);

				const preElement = document.createElement('pre');
				preElement.innerHTML = '<span id="' + resultId + '_visible">' + escapeHtml(truncated) + '</span>' +
					'<span id="' + resultId + '_ellipsis">...</span>' +
					'<span id="' + resultId + '_hidden" style="display: none;">' + escapeHtml(content.substring(truncateAt)) + '</span>';
				contentDiv.appendChild(preElement);

				// Add expand button container
				const expandContainer = document.createElement('div');
				expandContainer.className = 'diff-expand-container';
				const expandButton = document.createElement('button');
				expandButton.className = 'diff-expand-btn';
				expandButton.textContent = 'Show more';
				expandButton.setAttribute('onclick', 'toggleResultExpansion(\'' + resultId + '\')');
				expandContainer.appendChild(expandButton);
				contentDiv.appendChild(expandContainer);
			} else {
				const preElement = document.createElement('pre');
				preElement.textContent = content;
				contentDiv.appendChild(preElement);
			}

			messageDiv.appendChild(contentDiv);

			// Check if this is a permission-related error and add yolo mode button
			if (data.isError && isPermissionError(content)) {
				const yoloSuggestion = document.createElement('div');
				yoloSuggestion.className = 'yolo-suggestion';
				yoloSuggestion.innerHTML = `
					<div class="yolo-suggestion-text">
						<span> This looks like a permission issue. You can enable Yolo Mode to skip all permission checks.</span>
					</div>
					<button class="yolo-suggestion-btn" onclick="enableYoloMode()">Enable Yolo Mode</button>
				`;
				messageDiv.appendChild(yoloSuggestion);
			}

			messagesDiv.appendChild(messageDiv);
			moveProcessingIndicatorToLast();
			scrollToBottomIfNeeded(messagesDiv, shouldScroll);
		}

		function formatToolInputUI(input) {
			if (!input || typeof input !== 'object') {
				const str = String(input);
				if (str.length > 100) {
					const truncateAt = 97;
					const truncated = str.substring(0, truncateAt);
					const inputId = 'input_' + Math.random().toString(36).substr(2, 9);

					return '<span id="' + inputId + '_visible">' + escapeHtml(truncated) + '</span>' +
						'<span id="' + inputId + '_ellipsis">...</span>' +
						'<span id="' + inputId + '_hidden" style="display: none;">' + escapeHtml(str.substring(truncateAt)) + '</span>' +
						'<div class="diff-expand-container">' +
						'<button class="diff-expand-btn" onclick="toggleResultExpansion(\'' + inputId + '\')">Show more</button>' +
						'</div>';
				}
				return str;
			}

			// Special handling for Read tool with file_path
			if (input.file_path && Object.keys(input).length === 1) {
				const formattedPath = formatFilePath(input.file_path);
				return '<div class="diff-file-path" onclick="openFileInEditor(\'' + escapeHtml(input.file_path) + '\')">' + formattedPath + '</div>';
			}

			let result = '';
			let isFirst = true;
			for (const [key, value] of Object.entries(input)) {
				const valueStr = typeof value === 'string' ? value : JSON.stringify(value, null, 2);

				if (!isFirst) result += '\n';
				isFirst = false;

				// Special formatting for file_path in Read tool context
				if (key === 'file_path') {
					const formattedPath = formatFilePath(valueStr);
					result += '<div class="diff-file-path" onclick="openFileInEditor(\'' + escapeHtml(valueStr) + '\')">' + formattedPath + '</div>';
				} else if (valueStr.length > 100) {
					const truncated = valueStr.substring(0, 97) + '...';
					const escapedValue = valueStr.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
					result += '<span class="expandable-item"><strong>' + key + ':</strong> ' + truncated + ' <span class="expand-btn" data-key="' + key + '" data-value="' + escapedValue + '" onclick="toggleExpand(this)">expand</span></span>';
				} else {
					result += '<strong>' + key + ':</strong> ' + valueStr;
				}
			}
			return result;
		}

		// Simple LCS-based diff algorithm
		function computeLineDiff(oldLines, newLines) {
			// Compute longest common subsequence
			const m = oldLines.length;
			const n = newLines.length;
			const lcs = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

			for (let i = 1; i <= m; i++) {
				for (let j = 1; j <= n; j++) {
					if (oldLines[i - 1] === newLines[j - 1]) {
						lcs[i][j] = lcs[i - 1][j - 1] + 1;
					} else {
						lcs[i][j] = Math.max(lcs[i - 1][j], lcs[i][j - 1]);
					}
				}
			}

			// Backtrack to build diff
			const diff = [];
			let i = m, j = n;

			while (i > 0 || j > 0) {
				if (i > 0 && j > 0 && oldLines[i - 1] === newLines[j - 1]) {
					diff.unshift({ type: 'context', oldLine: i - 1, newLine: j - 1, content: oldLines[i - 1] });
					i--;
					j--;
				} else if (j > 0 && (i === 0 || lcs[i][j - 1] >= lcs[i - 1][j])) {
					diff.unshift({ type: 'added', newLine: j - 1, content: newLines[j - 1] });
					j--;
				} else if (i > 0) {
					diff.unshift({ type: 'removed', oldLine: i - 1, content: oldLines[i - 1] });
					i--;
				}
			}

			return diff;
		}

		// Parse tool result to extract line numbers
		function parseToolResult(resultContent) {
			if (!resultContent || typeof resultContent !== 'string') {
				return { startLine: 1, lines: [] };
			}

			const lines = resultContent.split('\n');
			const parsed = [];
			let startLine = null;

			for (const line of lines) {
				const match = line.match(/^\s*(\d+)(.*)$/);
				if (match) {
					const lineNum = parseInt(match[1]);
					const content = match[2];
					if (startLine === null) startLine = lineNum;
					parsed.push({ num: lineNum, content });
				}
			}

			return { startLine: startLine || 1, lines: parsed };
		}

		// Generate unified diff HTML with line numbers
		// showButton controls whether to show the "Open Diff" button
		function generateUnifiedDiffHTML(oldString, newString, filePath, startLine = 1, showButton = false) {
			const oldLines = oldString.split('\n');
			const newLines = newString.split('\n');
			const diff = computeLineDiff(oldLines, newLines);

			// Generate unique ID for this diff (used for truncation)
			const diffId = 'diff_' + Math.random().toString(36).substr(2, 9);

			let html = '';
			const formattedPath = formatFilePath(filePath);

			// Header with file path
			html += '<div class="diff-file-header">';
			html += '<div class="diff-file-path" onclick="openFileInEditor(\'' + escapeHtml(filePath) + '\')">' + formattedPath + '</div>';
			html += '</div>\n';

			// Calculate line range
			let firstLine = startLine;
			let lastLine = startLine;
			let addedCount = 0;
			let removedCount = 0;

			// Calculate actual line numbers
			for (const change of diff) {
				if (change.type === 'added') addedCount++;
				if (change.type === 'removed') removedCount++;
			}

			lastLine = startLine + newLines.length - 1;

			html += '<div class="diff-container">';
			html += '<div class="diff-header">Lines ' + firstLine + '-' + lastLine + '</div>';

			// Build diff lines with proper line numbers
			let oldLineNum = startLine;
			let newLineNum = startLine;
			const maxLines = 6;
			let lineIndex = 0;

			// First pass: build all line HTML
			const allLinesHtml = [];
			for (const change of diff) {
				let lineNum, prefix, cssClass;

				if (change.type === 'context') {
					lineNum = newLineNum;
					prefix = ' ';
					cssClass = 'context';
					oldLineNum++;
					newLineNum++;
				} else if (change.type === 'added') {
					lineNum = newLineNum;
					prefix = '+';
					cssClass = 'added';
					newLineNum++;
				} else {
					lineNum = oldLineNum;
					prefix = '-';
					cssClass = 'removed';
					oldLineNum++;
				}

				const lineNumStr = lineNum.toString().padStart(3);
				allLinesHtml.push('<div class="diff-line ' + cssClass + '">' + prefix + lineNumStr + '  ' + escapeHtml(change.content) + '</div>');
			}

			// Show visible lines
			const shouldTruncate = allLinesHtml.length > maxLines;
			const visibleLines = shouldTruncate ? allLinesHtml.slice(0, maxLines) : allLinesHtml;
			const hiddenLines = shouldTruncate ? allLinesHtml.slice(maxLines) : [];

			html += '<div id="' + diffId + '_visible">';
			html += visibleLines.join('');
			html += '</div>';

			// Show hidden lines (initially hidden)
			if (shouldTruncate) {
				html += '<div id="' + diffId + '_hidden" style="display: none;">';
				html += hiddenLines.join('');
				html += '</div>';

				// Add expand button
				html += '<div class="diff-expand-container">';
				html += '<button class="diff-expand-btn" onclick="toggleDiffExpansion(\'' + diffId + '\')">Show ' + hiddenLines.length + ' more lines</button>';
				html += '</div>';
			}

			html += '</div>';

			// Summary
			let summary = '';
			if (addedCount > 0 && removedCount > 0) {
				summary = '+' + addedCount + ' line' + (addedCount > 1 ? 's' : '') + ' added, -' + removedCount + ' line' + (removedCount > 1 ? 's' : '') + ' removed';
			} else if (addedCount > 0) {
				summary = '+' + addedCount + ' line' + (addedCount > 1 ? 's' : '') + ' added';
			} else if (removedCount > 0) {
				summary = '-' + removedCount + ' line' + (removedCount > 1 ? 's' : '') + ' removed';
			}

			if (summary) {
				html += '<div class="diff-summary-row">';
				html += '<span class="diff-summary">Summary: ' + summary + '</span>';
				if (showButton) {
					html += '<button class="diff-open-btn" onclick="openDiffEditor()" title="Open side-by-side diff in VS Code">';
					html += '<svg width="14" height="14" viewBox="0 0 16 16"><rect x="1" y="1" width="6" height="14" rx="1" fill="none" stroke="currentColor" stroke-opacity="0.5"/><rect x="9" y="1" width="6" height="14" rx="1" fill="none" stroke="currentColor" stroke-opacity="0.5"/><line x1="2.5" y1="4" x2="5.5" y2="4" stroke="#e8a0a0" stroke-width="1.5"/><line x1="2.5" y1="7" x2="5.5" y2="7" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="2.5" y1="10" x2="5.5" y2="10" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="10.5" y1="4" x2="13.5" y2="4" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="10.5" y1="7" x2="13.5" y2="7" stroke="#8fd48f" stroke-width="1.5"/><line x1="10.5" y1="10" x2="13.5" y2="10" stroke="#8fd48f" stroke-width="1.5"/></svg>';
					html += 'Open Diff</button>';
				}
				html += '</div>';
			}

			return html;
		}

		function formatEditToolDiff(input, fileContentBefore, showButton = false, providedStartLine = null) {
			if (!input || typeof input !== 'object') {
				return formatToolInputUI(input);
			}

			// Check if this is an Edit tool (has file_path, old_string, new_string)
			if (!input.file_path || !input.old_string || !input.new_string) {
				return formatToolInputUI(input);
			}

			// Use provided startLine if available (from saved data), otherwise compute from fileContentBefore
			let startLine = providedStartLine || 1;
			if (!providedStartLine && fileContentBefore) {
				const position = fileContentBefore.indexOf(input.old_string);
				if (position !== -1) {
					// Count newlines before the match to get line number
					const textBefore = fileContentBefore.substring(0, position);
					startLine = (textBefore.match(/\n/g) || []).length + 1;
				}
			}

			return generateUnifiedDiffHTML(input.old_string, input.new_string, input.file_path, startLine, showButton);
		}

		function formatMultiEditToolDiff(input, fileContentBefore, showButton = false, providedStartLines = null) {
			if (!input || typeof input !== 'object') {
				return formatToolInputUI(input);
			}

			// Check if this is a MultiEdit tool (has file_path and edits array)
			if (!input.file_path || !input.edits || !Array.isArray(input.edits)) {
				return formatToolInputUI(input);
			}

			// Show full diffs for each edit
			const formattedPath = formatFilePath(input.file_path);
			let html = '<div class="diff-file-header">';
			html += '<div class="diff-file-path" onclick="openFileInEditor(\'' + escapeHtml(input.file_path) + '\')">' + formattedPath + '</div>';
			html += '</div>\n';

			input.edits.forEach((edit, index) => {
				if (edit.old_string && edit.new_string) {
					if (index > 0) {
						html += '<div class="diff-edit-separator"></div>';
					}

					// Use provided startLine if available, otherwise compute from fileContentBefore
					let startLine = (providedStartLines && providedStartLines[index]) || 1;
					if (!providedStartLines && fileContentBefore) {
						const position = fileContentBefore.indexOf(edit.old_string);
						if (position !== -1) {
							const textBefore = fileContentBefore.substring(0, position);
							startLine = (textBefore.match(/\n/g) || []).length + 1;
						}
					}

					const oldLines = edit.old_string.split('\n');
					const newLines = edit.new_string.split('\n');
					const diff = computeLineDiff(oldLines, newLines);

					html += '<div class="diff-container">';
					html += '<div class="diff-header">Edit ' + (index + 1) + ' (Line ' + startLine + ')</div>';

					let lineNum = startLine;
					for (const change of diff) {
						let prefix, cssClass;
						if (change.type === 'context') {
							prefix = ' ';
							cssClass = 'context';
							lineNum++;
						} else if (change.type === 'added') {
							prefix = '+';
							cssClass = 'added';
							lineNum++;
						} else {
							prefix = '-';
							cssClass = 'removed';
						}
						const lineNumStr = (change.type === 'removed' ? '' : lineNum - 1).toString().padStart(3);
						html += '<div class="diff-line ' + cssClass + '">' + prefix + lineNumStr + '  ' + escapeHtml(change.content) + '</div>';
					}
					html += '</div>';
				}
			});

			// Add summary row with Open Diff button
			html += '<div class="diff-summary-row">';
			html += '<span class="diff-summary">Summary: ' + input.edits.length + ' edit' + (input.edits.length > 1 ? 's' : '') + '</span>';
			if (showButton) {
				html += '<button class="diff-open-btn" onclick="openDiffEditor()" title="Open side-by-side diff in VS Code">';
				html += '<svg width="14" height="14" viewBox="0 0 16 16"><rect x="1" y="1" width="6" height="14" rx="1" fill="none" stroke="currentColor" stroke-opacity="0.5"/><rect x="9" y="1" width="6" height="14" rx="1" fill="none" stroke="currentColor" stroke-opacity="0.5"/><line x1="2.5" y1="4" x2="5.5" y2="4" stroke="#e8a0a0" stroke-width="1.5"/><line x1="2.5" y1="7" x2="5.5" y2="7" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="2.5" y1="10" x2="5.5" y2="10" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="10.5" y1="4" x2="13.5" y2="4" stroke="currentColor" stroke-opacity="0.4" stroke-width="1.5"/><line x1="10.5" y1="7" x2="13.5" y2="7" stroke="#8fd48f" stroke-width="1.5"/><line x1="10.5" y1="10" x2="13.5" y2="10" stroke="#8fd48f" stroke-width="1.5"/></svg>';
				html += 'Open Diff</button>';
			}
			html += '</div>';

			return html;
		}

		function formatWriteToolDiff(input, fileContentBefore, showButton = false) {
			if (!input || typeof input !== 'object') {
				return formatToolInputUI(input);
			}

			// Check if this is a Write tool (has file_path and content)
			if (!input.file_path || !input.content) {
				return formatToolInputUI(input);
			}

			// fileContentBefore may be empty string if new file, or existing content if overwriting
			const fullFileBefore = fileContentBefore || '';

			// Show full content as added lines (new file or replacement)
			return generateUnifiedDiffHTML(fullFileBefore, input.content, input.file_path, 1, showButton);
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function openFileInEditor(filePath) {
			vscode.postMessage({
				type: 'openFile',
				filePath: filePath
			});
		}

		function formatFilePath(filePath) {
			if (!filePath) return '';

			// Extract just the filename
			const parts = filePath.split('/');
			const fileName = parts[parts.length - 1];

			return '<span class="file-path-truncated" title="' + escapeHtml(filePath) + '" data-file-path="' + escapeHtml(filePath) + '">' +
				'<span class="file-icon"></span>' + escapeHtml(fileName) + '</span>';
		}

		function toggleDiffExpansion(diffId) {
			const hiddenDiv = document.getElementById(diffId + '_hidden');
			const button = document.querySelector('[onclick*="' + diffId + '"]');

			if (hiddenDiv && button) {
				if (hiddenDiv.style.display === 'none') {
					hiddenDiv.style.display = 'block';
					button.textContent = 'Show less';
				} else {
					hiddenDiv.style.display = 'none';
					const hiddenLines = hiddenDiv.querySelectorAll('.diff-line').length;
					button.textContent = 'Show ' + hiddenLines + ' more lines';
				}
			}
		}

		function toggleResultExpansion(resultId) {
			const hiddenDiv = document.getElementById(resultId + '_hidden');
			const ellipsis = document.getElementById(resultId + '_ellipsis');
			const button = document.querySelector('[onclick*="toggleResultExpansion(\'' + resultId + '\')"]');

			if (hiddenDiv && button) {
				if (hiddenDiv.style.display === 'none') {
					hiddenDiv.style.display = 'inline';
					if (ellipsis) ellipsis.style.display = 'none';
					button.textContent = 'Show less';
				} else {
					hiddenDiv.style.display = 'none';
					if (ellipsis) ellipsis.style.display = 'inline';
					button.textContent = 'Show more';
				}
			}
		}

		function toggleExpand(button) {
			const key = button.getAttribute('data-key');
			const value = button.getAttribute('data-value');

			// Find the container that holds just this key-value pair
			let container = button.parentNode;
			while (container && !container.classList.contains('expandable-item')) {
				container = container.parentNode;
			}

			if (!container) {
				// Fallback: create a wrapper around the current line
				const parent = button.parentNode;
				const wrapper = document.createElement('div');
				wrapper.className = 'expandable-item';
				parent.insertBefore(wrapper, button.previousSibling || button);

				// Move the key, value text, and button into the wrapper
				let currentNode = wrapper.nextSibling;
				const nodesToMove = [];
				while (currentNode && currentNode !== button.nextSibling) {
					nodesToMove.push(currentNode);
					currentNode = currentNode.nextSibling;
				}
				nodesToMove.forEach(node => wrapper.appendChild(node));
				container = wrapper;
			}

			if (button.textContent === 'expand') {
				// Show full content
				const decodedValue = value.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
				container.innerHTML = '<strong>' + key + ':</strong> ' + decodedValue + ' <span class="expand-btn" data-key="' + key + '" data-value="' + value + '" onclick="toggleExpand(this)">collapse</span>';
			} else {
				// Show truncated content
				const decodedValue = value.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
				const truncated = decodedValue.substring(0, 97) + '...';
				container.innerHTML = '<strong>' + key + ':</strong> ' + truncated + ' <span class="expand-btn" data-key="' + key + '" data-value="' + value + '" onclick="toggleExpand(this)">expand</span>';
			}
		}

		function sendMessage() {
			const text = messageInput.value.trim();
			if (text) {
				vscode.postMessage({
					type: 'sendMessage',
					text: text,
					planMode: planModeEnabled,
					thinkingMode: thinkingModeEnabled
				});

				messageInput.value = '';

				// Update Control Panel to show running state
				setAgentRunning('Processing request...');
			}
		}

		function togglePlanMode() {
			planModeEnabled = !planModeEnabled;
			const switchElement = document.getElementById('planModeSwitch');
			if (planModeEnabled) {
				switchElement.classList.add('active');
			} else {
				switchElement.classList.remove('active');
			}
		}

		function toggleThinkingMode() {
			thinkingModeEnabled = !thinkingModeEnabled;

			if (thinkingModeEnabled) {
				sendStats('Thinking mode enabled');
			}

			const switchElement = document.getElementById('thinkingModeSwitch');
			const toggleLabel = document.getElementById('thinkingModeLabel');
			if (thinkingModeEnabled) {
				switchElement.classList.add('active');
				// Show thinking intensity modal when thinking mode is enabled
				showThinkingIntensityModal();
			} else {
				switchElement.classList.remove('active');
				// Reset to default "Thinking Mode" when turned off
				if (toggleLabel) {
					toggleLabel.textContent = 'Thinking Mode';
				}
			}
		}

		// Agent management functions for command center UI
		function updateAgentList(agents) {
			const agentList = document.getElementById('agentList');
			if (!agentList) return;

			// For now, show single agent card
			agentList.innerHTML = `
				<div class="agent-card active" data-agent-id="main">
					<div class="agent-status running"></div>
					<div class="agent-info">
						<div class="agent-name">Agent 1</div>
						<div class="agent-task">Current session</div>
					</div>
				</div>
			`;
		}

		function updateAgentHeader(name, status) {
			const nameEl = document.getElementById('selectedAgentName');
			const statusEl = document.getElementById('selectedAgentStatus');
			if (nameEl) nameEl.textContent = name || 'Agent 1';
			if (statusEl) {
				statusEl.className = 'agent-status-badge ' + (status || 'idle');
				statusEl.textContent = status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Idle';
			}
			// Also update Control Panel
			updateControlPanelAgent('default', status, null);
		}

		// Update Control Panel agent status and preview
		// status: 'idle' | 'running' | 'awaiting'
		// previewText: optional text to show in preview
		let currentAgentPreview = 'Ready for input';

		function updateControlPanelAgent(agentId, status, previewText) {
			const statusBadge = document.getElementById('panel-agent-' + agentId + '-status');
			const statusText = document.getElementById('panel-agent-' + agentId + '-status-text');
			const statusDot = document.getElementById('panel-agent-' + agentId + '-dot');
			const preview = document.getElementById('panel-agent-' + agentId + '-preview');
			const previewTextEl = document.getElementById('panel-agent-' + agentId + '-preview-text');

			// Update preview text if provided
			if (previewText) {
				currentAgentPreview = previewText;
			}

			// Update status badge
			if (statusBadge && status) {
				statusBadge.className = 'agent-status-badge ' + status;

				// Update status text
				if (statusText) {
					switch (status) {
						case 'running':
							statusText.textContent = 'Running...';
							break;
						case 'awaiting':
							statusText.textContent = 'Awaiting Input';
							break;
						default:
							statusText.textContent = 'Idle';
					}
				}
			}

			// Update status dot
			if (statusDot && status) {
				statusDot.className = 'status-dot ' + status;
			}

			// Update preview section
			if (preview && status) {
				preview.className = 'agent-preview ' + status;
			}

			if (previewTextEl) {
				previewTextEl.textContent = currentAgentPreview;
			}
		}

		// Helper function to set agent as running with a tool name
		function setAgentRunning(toolName) {
			const preview = toolName ? 'Executing: ' + toolName : 'Processing request...';
			updateControlPanelAgent('default', 'running', preview);
		}

		// Helper function to set agent as awaiting input
		function setAgentAwaiting(reason) {
			const preview = reason || 'Waiting for approval...';
			updateControlPanelAgent('default', 'awaiting', preview);
		}

		// Helper function to set agent as idle
		function setAgentIdle() {
			updateControlPanelAgent('default', 'idle', 'Ready for input');
		}


		let totalCost = 0;
		let totalTokensInput = 0;
		let totalTokensOutput = 0;
		let requestCount = 0;
		let isProcessing = false;
		let requestStartTime = null;
		let requestTimer = null;
		let subscriptionType = null;  // 'pro', 'max', or null for API users

		// Send usage statistics
		function sendStats(eventName) {
			// Telemetry disabled - no tracking
		}

		function updateStatus(text, state = 'ready') {
			statusTextDiv.textContent = text;
			statusDiv.className = `status ${state}`;
		}

		function updateStatusHtml(html, state = 'ready') {
			statusTextDiv.innerHTML = html;
			statusDiv.className = `status ${state}`;
		}

		function viewUsage(usageType) {
			vscode.postMessage({ type: 'viewUsage', usageType: usageType });
		}

		function updateStatusWithTotals() {
			const totalTokens = totalTokensInput + totalTokensOutput;

			// Update global stats in header
			const globalStats = document.getElementById('globalStats');
			if (globalStats) {
				globalStats.textContent = totalTokens > 0 ?
					`${totalTokens.toLocaleString()} tokens` :
					'0 tokens';
			}

			if (isProcessing) {
				// While processing, show tokens and elapsed time
				const tokensStr = totalTokens > 0 ?
					`${totalTokens.toLocaleString()} tokens` : '0 tokens';

				let elapsedStr = '';
				if (requestStartTime) {
					const elapsedSeconds = Math.floor((Date.now() - requestStartTime) / 1000);
					elapsedStr = `  ${elapsedSeconds}s`;
				}

				const statusText = `Processing  ${tokensStr}${elapsedStr}`;
				updateStatus(statusText, 'processing');
			} else {
				// When ready, show full info
				// Show plan type for subscription users, cost for API users
				let usageStr;
				const usageIcon = `<svg class="usage-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
					<rect x="1" y="8" width="3" height="6" rx="0.5" fill="currentColor" opacity="0.5"/>
					<rect x="5.5" y="5" width="3" height="9" rx="0.5" fill="currentColor" opacity="0.7"/>
					<rect x="10" y="2" width="3" height="12" rx="0.5" fill="currentColor"/>
				</svg>`;
				if (subscriptionType) {
					// Extract just the plan type (e.g., "Claude Max" -> "Max", "pro" -> "Pro")
					let planName = subscriptionType.replace(/^claude\s*/i, '').trim();
					planName = planName.charAt(0).toUpperCase() + planName.slice(1);
					usageStr = `<a href="#" onclick="event.preventDefault(); viewUsage('plan');" class="usage-badge" title="View live usage">${planName} Plan${usageIcon}</a>`;
				} else {
					const costStr = totalCost > 0 ? `$${totalCost.toFixed(4)}` : '$0.00';
					usageStr = `<a href="#" onclick="event.preventDefault(); viewUsage('api');" class="usage-badge" title="View usage">${costStr}${usageIcon}</a>`;
				}
				const tokensStr = totalTokens > 0 ?
					`${totalTokens.toLocaleString()} tokens` : '0 tokens';
				const requestStr = requestCount > 0 ? `${requestCount} requests` : '';

				const statusText = `Ready  ${tokensStr}${requestStr ? `  ${requestStr}` : ''}  ${usageStr}`;
				updateStatusHtml(statusText, 'ready');
			}
		}

		function startRequestTimer(startTime = undefined) {
			requestStartTime = startTime || Date.now();
			// Update status every 100ms for smooth real-time display
			requestTimer = setInterval(() => {
				if (isProcessing) {
					updateStatusWithTotals();
				}
			}, 100);
		}

		function stopRequestTimer() {
			if (requestTimer) {
				clearInterval(requestTimer);
				requestTimer = null;
			}
			requestStartTime = null;
		}

		function showProcessingIndicator() {
			// Remove any existing indicator first
			hideProcessingIndicator();

			// Create the indicator and append after all messages
			const indicator = document.createElement('div');
			indicator.className = 'processing-indicator';
			indicator.innerHTML = '<div class="morph-dot"></div>';
			messagesDiv.appendChild(indicator);
		}

		function hideProcessingIndicator() {
			const indicator = document.querySelector('.processing-indicator');
			if (indicator) {
				indicator.remove();
			}
		}

		function moveProcessingIndicatorToLast() {
			// Only move if we're processing
			if (isProcessing) {
				showProcessingIndicator();
			}
		}

		// Auto-resize textarea
		function adjustTextareaHeight() {
			// Reset height to calculate new height
			messageInput.style.height = 'auto';

			// Get computed styles
			const computedStyle = getComputedStyle(messageInput);
			const lineHeight = parseFloat(computedStyle.lineHeight);
			const paddingTop = parseFloat(computedStyle.paddingTop);
			const paddingBottom = parseFloat(computedStyle.paddingBottom);
			const borderTop = parseFloat(computedStyle.borderTopWidth);
			const borderBottom = parseFloat(computedStyle.borderBottomWidth);

			// Calculate heights
			const scrollHeight = messageInput.scrollHeight;
			const maxRows = 5;
			const minHeight = lineHeight + paddingTop + paddingBottom + borderTop + borderBottom;
			const maxHeight = (lineHeight * maxRows) + paddingTop + paddingBottom + borderTop + borderBottom;

			// Set height
			if (scrollHeight <= maxHeight) {
				messageInput.style.height = Math.max(scrollHeight, minHeight) + 'px';
				messageInput.style.overflowY = 'hidden';
			} else {
				messageInput.style.height = maxHeight + 'px';
				messageInput.style.overflowY = 'auto';
			}
		}

		messageInput.addEventListener('input', adjustTextareaHeight);

		// Save input text as user types (debounced)
		let saveInputTimeout;
		messageInput.addEventListener('input', () => {
			clearTimeout(saveInputTimeout);
			saveInputTimeout = setTimeout(() => {
				vscode.postMessage({
					type: 'saveInputText',
					text: messageInput.value
				});
			}, 500); // Save after 500ms of no typing
		});

		messageInput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				const sendBtn = document.getElementById('sendBtn');
				if (sendBtn.disabled) {
					return;
				}
				sendMessage();
			} else if (e.key === '@' && !e.ctrlKey && !e.metaKey) {
				// Don't prevent default, let @ be typed first
				setTimeout(() => {
					showFilePicker();
				}, 0);
			} else if (e.key === 'Escape' && filePickerModal.style.display === 'flex') {
				e.preventDefault();
				hideFilePicker();
			} else if (e.key === 'v' && (e.ctrlKey || e.metaKey)) {
				// Handle Ctrl+V/Cmd+V explicitly in case paste event doesn't fire
				// Don't prevent default - let browser handle it first
				setTimeout(() => {
					// If value hasn't changed, manually trigger paste
					const currentValue = messageInput.value;
					setTimeout(() => {
						if (messageInput.value === currentValue) {
							// Value didn't change, request clipboard from VS Code
							vscode.postMessage({
								type: 'getClipboardText'
							});
						}
					}, 50);
				}, 0);
			}
		});

		// Add explicit paste event handler for better clipboard support in VSCode webviews
		messageInput.addEventListener('paste', async (e) => {
			e.preventDefault();

			try {
				// Try to get clipboard data from the event first
				const clipboardData = e.clipboardData;

				// Check for images first
				if (clipboardData && clipboardData.items) {
					let hasImage = false;
					for (let i = 0; i < clipboardData.items.length; i++) {
						const item = clipboardData.items[i];
						if (item.type.startsWith('image/')) {
							// Found an image, handle it
							console.log('Image detected in clipboard:', item.type);
							hasImage = true;
							const blob = item.getAsFile();
							if (blob) {
								console.log('Converting image blob to base64...');
								// Convert blob to base64
								const reader = new FileReader();
								reader.onload = function (event) {
									const base64Data = event.target.result;
									console.log('Sending image to extension for file creation');
									// Send to extension to create file
									vscode.postMessage({
										type: 'createImageFile',
										imageData: base64Data,
										imageType: item.type
									});
								};
								reader.readAsDataURL(blob);
							}
							break; // Process only the first image found
						}
					}

					// If we found an image, don't process any text
					if (hasImage) {
						return;
					}
				}

				// No image found, handle text
				let text = '';

				if (clipboardData) {
					text = clipboardData.getData('text/plain');
				}

				// If no text from event, try navigator.clipboard API
				if (!text && navigator.clipboard && navigator.clipboard.readText) {
					try {
						text = await navigator.clipboard.readText();
					} catch (err) {
						console.log('Clipboard API failed:', err);
					}
				}

				// If still no text, request from VS Code extension
				if (!text) {
					vscode.postMessage({
						type: 'getClipboardText'
					});
					return;
				}

				// Insert text at cursor position
				const start = messageInput.selectionStart;
				const end = messageInput.selectionEnd;
				const currentValue = messageInput.value;

				const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
				messageInput.value = newValue;

				// Set cursor position after pasted text
				const newCursorPos = start + text.length;
				messageInput.setSelectionRange(newCursorPos, newCursorPos);

				// Trigger input event to adjust height
				messageInput.dispatchEvent(new Event('input', { bubbles: true }));
			} catch (error) {
				console.error('Paste error:', error);
			}
		});

		// Handle context menu paste
		messageInput.addEventListener('contextmenu', (e) => {
			// Don't prevent default - allow context menu to show
			// but ensure paste will work when selected
		});

		// Initialize textarea height
		adjustTextareaHeight();

		// File picker event listeners
		fileSearchInput.addEventListener('input', (e) => {
			filterFiles(e.target.value);
		});

		fileSearchInput.addEventListener('keydown', (e) => {
			if (e.key === 'ArrowDown') {
				e.preventDefault();
				selectedFileIndex = Math.min(selectedFileIndex + 1, filteredFiles.length - 1);
				renderFileList();
			} else if (e.key === 'ArrowUp') {
				e.preventDefault();
				selectedFileIndex = Math.max(selectedFileIndex - 1, -1);
				renderFileList();
			} else if (e.key === 'Enter' && selectedFileIndex >= 0) {
				e.preventDefault();
				selectFile(filteredFiles[selectedFileIndex]);
			} else if (e.key === 'Escape') {
				e.preventDefault();
				hideFilePicker();
			}
		});

		// Close modal when clicking outside
		filePickerModal.addEventListener('click', (e) => {
			if (e.target === filePickerModal) {
				hideFilePicker();
			}
		});

		// Tools modal functions
		function showMCPModal() {
			document.getElementById('mcpModal').style.display = 'flex';
			// Load existing MCP servers
			loadMCPServers();
		}

		function updateYoloWarning() {
			const yoloModeCheckbox = document.getElementById('yolo-mode');
			const warning = document.getElementById('yoloWarning');

			if (!yoloModeCheckbox || !warning) {
				return; // Elements not ready yet
			}

			const yoloMode = yoloModeCheckbox.checked;
			warning.style.display = yoloMode ? 'block' : 'none';
		}

		function isPermissionError(content) {
			const permissionErrorPatterns = [
				'Error: MCP config file not found',
				'Error: MCP tool',
				'Claude requested permissions to use',
				'permission denied',
				'Permission denied',
				'permission request',
				'Permission request',
				'EACCES',
				'permission error',
				'Permission error'
			];

			return permissionErrorPatterns.some(pattern =>
				content.toLowerCase().includes(pattern.toLowerCase())
			);
		}

		function enableYoloMode() {
			sendStats('YOLO mode enabled');

			// Update the checkbox
			const yoloModeCheckbox = document.getElementById('yolo-mode');
			if (yoloModeCheckbox) {
				yoloModeCheckbox.checked = true;

				// Trigger the settings update
				updateSettings();

				// Show confirmation message
				addMessage(' Yolo Mode enabled! All permission checks will be bypassed for future commands.', 'system');

				// Update the warning banner
				updateYoloWarning();
			}
		}

		function hideMCPModal() {
			document.getElementById('mcpModal').style.display = 'none';
			hideAddServerForm();
		}

		// Close MCP modal when clicking outside
		document.getElementById('mcpModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('mcpModal')) {
				hideMCPModal();
			}
		});

		// MCP Server management functions
		function loadMCPServers() {
			vscode.postMessage({ type: 'loadMCPServers' });
		}

		function showAddServerForm() {
			document.getElementById('addServerBtn').style.display = 'none';
			document.getElementById('popularServers').style.display = 'none';
			document.getElementById('addServerForm').style.display = 'block';
		}

		function hideAddServerForm() {
			document.getElementById('addServerBtn').style.display = 'block';
			document.getElementById('popularServers').style.display = 'block';
			document.getElementById('addServerForm').style.display = 'none';

			// Reset editing state
			editingServerName = null;

			// Reset form title and button
			const formTitle = document.querySelector('#addServerForm h5');
			if (formTitle) formTitle.remove();

			const saveBtn = document.querySelector('#addServerForm .btn:not(.outlined)');
			if (saveBtn) saveBtn.textContent = 'Add Server';

			// Clear form
			document.getElementById('serverName').value = '';
			document.getElementById('serverName').disabled = false;
			document.getElementById('serverCommand').value = '';
			document.getElementById('serverUrl').value = '';
			document.getElementById('serverArgs').value = '';
			document.getElementById('serverEnv').value = '';
			document.getElementById('serverHeaders').value = '';
			document.getElementById('serverType').value = 'http';
			updateServerForm();
		}

		function updateServerForm() {
			const serverType = document.getElementById('serverType').value;
			const commandGroup = document.getElementById('commandGroup');
			const urlGroup = document.getElementById('urlGroup');
			const argsGroup = document.getElementById('argsGroup');
			const envGroup = document.getElementById('envGroup');
			const headersGroup = document.getElementById('headersGroup');

			if (serverType === 'stdio') {
				commandGroup.style.display = 'block';
				urlGroup.style.display = 'none';
				argsGroup.style.display = 'block';
				envGroup.style.display = 'block';
				headersGroup.style.display = 'none';
			} else if (serverType === 'http' || serverType === 'sse') {
				commandGroup.style.display = 'none';
				urlGroup.style.display = 'block';
				argsGroup.style.display = 'none';
				envGroup.style.display = 'none';
				headersGroup.style.display = 'block';
			}
		}

		function saveMCPServer() {
			sendStats('MCP server added');

			const name = document.getElementById('serverName').value.trim();
			const type = document.getElementById('serverType').value;

			if (!name) {
				// Use a simple notification instead of alert which is blocked
				const notification = document.createElement('div');
				notification.textContent = 'Server name is required';
				notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-inputValidation-errorForeground); padding: 8px 12px; border-radius: 4px; z-index: 9999;';
				document.body.appendChild(notification);
				setTimeout(() => notification.remove(), 3000);
				return;
			}

			// If editing, we can use the same name; if adding, check for duplicates
			if (!editingServerName) {
				const serversList = document.getElementById('mcpServersList');
				const existingServers = serversList.querySelectorAll('.server-name');
				for (let server of existingServers) {
					if (server.textContent === name) {
						const notification = document.createElement('div');
						notification.textContent = `Server "${name}" already exists`;
						notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-inputValidation-errorForeground); padding: 8px 12px; border-radius: 4px; z-index: 9999;';
						document.body.appendChild(notification);
						setTimeout(() => notification.remove(), 3000);
						return;
					}
				}
			}

			const serverConfig = { type };

			if (type === 'stdio') {
				const command = document.getElementById('serverCommand').value.trim();
				if (!command) {
					const notification = document.createElement('div');
					notification.textContent = 'Command is required for stdio servers';
					notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-inputValidation-errorForeground); padding: 8px 12px; border-radius: 4px; z-index: 9999;';
					document.body.appendChild(notification);
					setTimeout(() => notification.remove(), 3000);
					return;
				}
				serverConfig.command = command;

				const argsText = document.getElementById('serverArgs').value.trim();
				if (argsText) {
					serverConfig.args = argsText.split('\n').filter(line => line.trim());
				}

				const envText = document.getElementById('serverEnv').value.trim();
				if (envText) {
					serverConfig.env = {};
					envText.split('\n').forEach(line => {
						const [key, ...valueParts] = line.split('=');
						if (key && valueParts.length > 0) {
							serverConfig.env[key.trim()] = valueParts.join('=').trim();
						}
					});
				}
			} else if (type === 'http' || type === 'sse') {
				const url = document.getElementById('serverUrl').value.trim();
				if (!url) {
					const notification = document.createElement('div');
					notification.textContent = 'URL is required for HTTP/SSE servers';
					notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-inputValidation-errorForeground); padding: 8px 12px; border-radius: 4px; z-index: 9999;';
					document.body.appendChild(notification);
					setTimeout(() => notification.remove(), 3000);
					return;
				}
				serverConfig.url = url;

				const headersText = document.getElementById('serverHeaders').value.trim();
				if (headersText) {
					serverConfig.headers = {};
					headersText.split('\n').forEach(line => {
						const [key, ...valueParts] = line.split('=');
						if (key && valueParts.length > 0) {
							serverConfig.headers[key.trim()] = valueParts.join('=').trim();
						}
					});
				}
			}

			vscode.postMessage({
				type: 'saveMCPServer',
				name: name,
				config: serverConfig
			});

			hideAddServerForm();
		}

		function deleteMCPServer(serverName) {
			// Just delete without confirmation
			vscode.postMessage({
				type: 'deleteMCPServer',
				name: serverName
			});
		}

		let editingServerName = null;

		function editMCPServer(name, config) {
			editingServerName = name;

			// Hide add button and popular servers
			document.getElementById('addServerBtn').style.display = 'none';
			document.getElementById('popularServers').style.display = 'none';

			// Show form
			document.getElementById('addServerForm').style.display = 'block';

			// Update form title and button
			const formTitle = document.querySelector('#addServerForm h5') ||
				document.querySelector('#addServerForm').insertAdjacentHTML('afterbegin', '<h5>Edit MCP Server</h5>') ||
				document.querySelector('#addServerForm h5');
			if (!document.querySelector('#addServerForm h5')) {
				document.getElementById('addServerForm').insertAdjacentHTML('afterbegin', '<h5 style="margin: 0 0 20px 0; font-size: 14px; font-weight: 600;">Edit MCP Server</h5>');
			} else {
				document.querySelector('#addServerForm h5').textContent = 'Edit MCP Server';
			}

			// Update save button text
			const saveBtn = document.querySelector('#addServerForm .btn:not(.outlined)');
			if (saveBtn) saveBtn.textContent = 'Update Server';

			// Populate form with existing values
			document.getElementById('serverName').value = name;
			document.getElementById('serverName').disabled = true; // Don't allow name changes when editing

			document.getElementById('serverType').value = config.type || 'stdio';

			if (config.command) {
				document.getElementById('serverCommand').value = config.command;
			}
			if (config.url) {
				document.getElementById('serverUrl').value = config.url;
			}
			if (config.args && Array.isArray(config.args)) {
				document.getElementById('serverArgs').value = config.args.join('\n');
			}
			if (config.env) {
				const envLines = Object.entries(config.env).map(([key, value]) => `${key}=${value}`);
				document.getElementById('serverEnv').value = envLines.join('\n');
			}
			if (config.headers) {
				const headerLines = Object.entries(config.headers).map(([key, value]) => `${key}=${value}`);
				document.getElementById('serverHeaders').value = headerLines.join('\n');
			}

			// Update form field visibility
			updateServerForm();

			const toolsList = document.querySelector('.tools-list');
			if (toolsList) {
				toolsList.scrollTop = toolsList.scrollHeight;
			}
		}

		function addPopularServer(name, config) {
			// Check if server already exists
			const serversList = document.getElementById('mcpServersList');
			const existingServers = serversList.querySelectorAll('.server-name');
			for (let server of existingServers) {
				if (server.textContent === name) {
					const notification = document.createElement('div');
					notification.textContent = `Server "${name}" already exists`;
					notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-inputValidation-errorForeground); padding: 8px 12px; border-radius: 4px; z-index: 9999;';
					document.body.appendChild(notification);
					setTimeout(() => notification.remove(), 3000);
					return;
				}
			}

			sendStats('MCP server added');

			// Add the server
			vscode.postMessage({
				type: 'saveMCPServer',
				name: name,
				config: config
			});
		}

		function displayMCPServers(servers) {
			const serversList = document.getElementById('mcpServersList');
			serversList.innerHTML = '';

			if (Object.keys(servers).length === 0) {
				serversList.innerHTML = '<div class="no-servers">No MCP servers configured</div>';
				return;
			}

			for (const [name, config] of Object.entries(servers)) {
				const serverItem = document.createElement('div');
				serverItem.className = 'mcp-server-item';

				// Defensive check for config structure
				if (!config || typeof config !== 'object') {
					console.error('Invalid config for server:', name, config);
					continue;
				}

				const serverType = config.type || 'stdio';
				let configDisplay = '';

				if (serverType === 'stdio') {
					configDisplay = `Command: ${config.command || 'Not specified'}`;
					if (config.args && Array.isArray(config.args)) {
						configDisplay += `<br>Args: ${config.args.join(' ')}`;
					}
				} else if (serverType === 'http' || serverType === 'sse') {
					configDisplay = `URL: ${config.url || 'Not specified'}`;
				} else {
					configDisplay = `Type: ${serverType}`;
				}

				serverItem.innerHTML = `
					<div class="server-info">
						<div class="server-name">${name}</div>
						<div class="server-type">${serverType.toUpperCase()}</div>
						<div class="server-config">${configDisplay}</div>
					</div>
					<div class="server-actions">
						<button class="btn outlined server-edit-btn" onclick="editMCPServer('${name}', ${JSON.stringify(config).replace(/"/g, '&quot;')})">Edit</button>
						<button class="btn outlined server-delete-btn" onclick="deleteMCPServer('${name}')">Delete</button>
					</div>
				`;

				serversList.appendChild(serverItem);
			}
		}

		// Model selector functions
		let currentModel = 'opus'; // Default model

		function showModelSelector() {
			document.getElementById('modelModal').style.display = 'flex';
			// Select the current model radio button
			const radioButton = document.getElementById('model-' + currentModel);
			if (radioButton) {
				radioButton.checked = true;
			}
		}

		function hideModelModal() {
			document.getElementById('modelModal').style.display = 'none';
		}

		// Slash commands modal functions
		function showSlashCommandsModal() {
			document.getElementById('slashCommandsModal').style.display = 'flex';
			// Auto-focus the search input
			setTimeout(() => {
				document.getElementById('slashCommandsSearch').focus();
			}, 100);
		}

		function hideSlashCommandsModal() {
			document.getElementById('slashCommandsModal').style.display = 'none';
			const menu = document.getElementById('slashCommandMenu');
			if (menu) {
				menu.classList.remove('visible');
				slashMenuVisible = false;
			}
		}

		// Install modal functions
		function showInstallModal() {
			const modal = document.getElementById('installModal');
			const main = document.getElementById('installMain');
			const progress = document.getElementById('installProgress');
			const success = document.getElementById('installSuccess');

			if (modal) modal.style.display = 'flex';
			if (main) main.style.display = 'flex';
			if (progress) progress.style.display = 'none';
			if (success) success.style.display = 'none';

			sendStats('Install modal shown');
		}

		function hideInstallModal() {
			document.getElementById('installModal').style.display = 'none';
		}

		function startInstallation() {
			sendStats('Install started');

			// Hide main content, show progress
			document.getElementById('installMain').style.display = 'none';
			document.getElementById('installProgress').style.display = 'flex';

			// Extension handles platform detection and command selection
			vscode.postMessage({
				type: 'runInstallCommand'
			});
		}

		function handleInstallComplete(success, error) {
			document.getElementById('installProgress').style.display = 'none';

			const successEl = document.getElementById('installSuccess');
			successEl.style.display = 'flex';

			if (success) {
				sendStats('Install success');
				successEl.querySelector('.install-success-text').textContent = 'Installed';
				successEl.querySelector('.install-success-hint').textContent = 'Send a message to get started';
			} else {
				sendStats('Install failed');
				// Show error state
				successEl.querySelector('.install-check').style.display = 'none';
				successEl.querySelector('.install-success-text').textContent = 'Installation failed';
				successEl.querySelector('.install-success-hint').textContent = error || 'Try installing manually from claude.ai/download';
			}
		}

		// Thinking intensity modal functions
		function showThinkingIntensityModal() {
			// Request current settings from VS Code first
			vscode.postMessage({
				type: 'getSettings'
			});
			document.getElementById('thinkingIntensityModal').style.display = 'flex';
		}

		function hideThinkingIntensityModal() {
			document.getElementById('thinkingIntensityModal').style.display = 'none';
		}

		function saveThinkingIntensity() {
			const thinkingSlider = document.getElementById('thinkingIntensitySlider');
			const intensityValues = ['think', 'think-hard', 'think-harder', 'ultrathink'];
			const thinkingIntensity = intensityValues[thinkingSlider.value] || 'think';

			// Send settings to VS Code
			vscode.postMessage({
				type: 'updateSettings',
				settings: {
					'thinking.intensity': thinkingIntensity
				}
			});
		}

		function updateThinkingModeToggleName(intensityValue) {
			const intensityNames = ['Thinking', 'Think Hard', 'Think Harder', 'Ultrathink'];
			const modeName = intensityNames[intensityValue] || 'Thinking';
			const toggleLabel = document.getElementById('thinkingModeLabel');
			if (toggleLabel) {
				toggleLabel.textContent = modeName + ' Mode';
			}
		}

		function updateThinkingIntensityDisplay(value) {
			// Update label highlighting for thinking intensity modal
			for (let i = 0; i < 4; i++) {
				const label = document.getElementById('thinking-label-' + i);
				if (i == value) {
					label.classList.add('active');
				} else {
					label.classList.remove('active');
				}
			}

			// Don't update toggle name until user confirms
		}

		function setThinkingIntensityValue(value) {
			// Set slider value for thinking intensity modal
			document.getElementById('thinkingIntensitySlider').value = value;

			// Update visual state
			updateThinkingIntensityDisplay(value);
		}

		function confirmThinkingIntensity() {
			// Get the current slider value
			const currentValue = document.getElementById('thinkingIntensitySlider').value;

			// Update the toggle name with confirmed selection
			updateThinkingModeToggleName(currentValue);

			// Save the current intensity setting
			saveThinkingIntensity();

			// Close the modal
			hideThinkingIntensityModal();
		}

		// WSL Alert functions
		function showWSLAlert() {
			const alert = document.getElementById('wslAlert');
			if (alert) {
				alert.style.display = 'block';
			}
		}

		function dismissWSLAlert() {
			const alert = document.getElementById('wslAlert');
			if (alert) {
				alert.style.display = 'none';
			}
			// Send dismiss message to extension to store in globalState
			vscode.postMessage({
				type: 'dismissWSLAlert'
			});
		}

		function openWSLSettings() {
			// Dismiss the alert
			dismissWSLAlert();

			// Open settings modal
			toggleSettings();
		}

		function executeSlashCommand(command) {
			// Hide the modal
			hideSlashCommandsModal();

			// Clear the input since user selected a command
			messageInput.value = '';

			// Send command to VS Code to execute
			vscode.postMessage({
				type: 'executeSlashCommand',
				command: command
			});

			// Show user feedback - /compact runs in chat, others in terminal
			if (command === 'compact') {
				// No message needed - compact runs in chat and shows its own status
			} else {
				addMessage('user', `Executing /${command} command in terminal. Check the terminal output and return when ready.`, 'assistant');
			}
		}

		function handleCustomCommandKeydown(event) {
			if (event.key === 'Enter') {
				event.preventDefault();
				const customCommand = event.target.value.trim();
				if (customCommand) {
					executeSlashCommand(customCommand);
					// Clear the input for next use
					event.target.value = '';
				}
			}
		}

		// Store custom snippets data globally
		let customSnippetsData = {};

		function usePromptSnippet(snippetType) {
			const builtInSnippets = {
				'performance-analysis': 'Analyze this code for performance issues and suggest optimizations',
				'security-review': 'Review this code for security vulnerabilities',
				'implementation-review': 'Review the implementation in this code',
				'code-explanation': 'Explain how this code works in detail',
				'bug-fix': 'Help me fix this bug in my code',
				'refactor': 'Refactor this code to improve readability and maintainability',
				'test-generation': 'Generate comprehensive tests for this code',
				'documentation': 'Generate documentation for this code'
			};

			// Check built-in snippets first
			let promptText = builtInSnippets[snippetType];

			// If not found in built-in, check custom snippets
			if (!promptText && customSnippetsData[snippetType]) {
				promptText = customSnippetsData[snippetType].prompt;
			}

			if (promptText) {
				// Hide the modal
				hideSlashCommandsModal();

				// Insert the prompt into the message input
				messageInput.value = promptText;
				messageInput.focus();

				// Auto-resize the textarea
				autoResizeTextarea();
			}
		}

		function showAddSnippetForm() {
			document.getElementById('addSnippetForm').style.display = 'block';
			document.getElementById('snippetName').focus();
		}

		function hideAddSnippetForm() {
			document.getElementById('addSnippetForm').style.display = 'none';
			// Clear form fields
			document.getElementById('snippetName').value = '';
			document.getElementById('snippetPrompt').value = '';
		}

		function saveCustomSnippet() {
			const name = document.getElementById('snippetName').value.trim();
			const prompt = document.getElementById('snippetPrompt').value.trim();

			if (!name || !prompt) {
				alert('Please fill in both name and prompt text.');
				return;
			}

			// Generate a unique ID for the snippet
			const snippetId = 'custom-' + Date.now();

			// Save the snippet using VS Code global storage
			const snippetData = {
				name: name,
				prompt: prompt,
				id: snippetId
			};

			vscode.postMessage({
				type: 'saveCustomSnippet',
				snippet: snippetData
			});

			// Hide the form
			hideAddSnippetForm();
		}

		function loadCustomSnippets(snippetsData = {}) {
			// Update inline menu if visible
			if (typeof slashMenuVisible !== 'undefined' && slashMenuVisible) {
				renderSlashMenu(messageInput.value);
			}

			const snippetsList = document.getElementById('promptSnippetsList');

			// Remove existing custom snippets
			const existingCustom = snippetsList.querySelectorAll('.custom-snippet-item');
			existingCustom.forEach(item => item.remove());

			// Add custom snippets after the add button and form
			const addForm = document.getElementById('addSnippetForm');

			Object.values(snippetsData).forEach(snippet => {
				const snippetElement = document.createElement('div');
				snippetElement.className = 'slash-command-item prompt-snippet-item custom-snippet-item';
				snippetElement.onclick = () => usePromptSnippet(snippet.id);

				snippetElement.innerHTML = `
					<div class="slash-command-icon"></div>
					<div class="slash-command-content">
						<div class="slash-command-title">/${snippet.name}</div>
						<div class="slash-command-description">${snippet.prompt}</div>
					</div>
					<div class="snippet-actions">
						<button class="snippet-delete-btn" onclick="event.stopPropagation(); deleteCustomSnippet('${snippet.id}')" title="Delete snippet"></button>
					</div>
				`;

				// Insert after the form
				addForm.parentNode.insertBefore(snippetElement, addForm.nextSibling);
			});
		}

		function deleteCustomSnippet(snippetId) {
			vscode.postMessage({
				type: 'deleteCustomSnippet',
				snippetId: snippetId
			});
		}

		function filterSlashCommands() {
			const searchTerm = document.getElementById('slashCommandsSearch').value.toLowerCase();
			const allItems = document.querySelectorAll('.slash-command-item');

			allItems.forEach(item => {
				const title = item.querySelector('.slash-command-title').textContent.toLowerCase();
				const description = item.querySelector('.slash-command-description').textContent.toLowerCase();

				if (title.includes(searchTerm) || description.includes(searchTerm)) {
					item.style.display = 'flex';
				} else {
					item.style.display = 'none';
				}
			});
		}

		function openModelTerminal() {
			vscode.postMessage({
				type: 'openModelTerminal'
			});
			hideModelModal();
		}

		function selectModel(model, fromBackend = false) {
			currentModel = model;

			// Update the display text with exact model names
			const displayNames = {
				'opus': 'Opus 4.5',
				'sonnet': 'Sonnet 4.5',
				'default': 'Default'
			};
			document.getElementById('selectedModel').textContent = displayNames[model] || model;

			// Only send model selection to VS Code extension if not from backend
			if (!fromBackend) {
				vscode.postMessage({
					type: 'selectModel',
					model: model
				});

				// Save preference
				localStorage.setItem('selectedModel', model);
			}

			// Update radio button if modal is open
			const radioButton = document.getElementById('model-' + model);
			if (radioButton) {
				radioButton.checked = true;
			}

			hideModelModal();
		}

		// Initialize model display without sending message
		currentModel = 'opus';
		const displayNamesInit = {
			'opus': 'Opus 4.5',
			'sonnet': 'Sonnet 4.5',
			'default': 'Default'
		};
		document.getElementById('selectedModel').textContent = displayNamesInit[currentModel];

		// Close model modal when clicking outside
		document.getElementById('modelModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('modelModal')) {
				hideModelModal();
			}
		});

		// Stop button functions
		function showStopButton() {
			document.getElementById('stopBtn').style.display = 'flex';
		}

		function hideStopButton() {
			document.getElementById('stopBtn').style.display = 'none';
		}

		function stopRequest() {
			sendStats('Stop request');

			vscode.postMessage({
				type: 'stopRequest'
			});
			hideStopButton();
		}

		// Disable/enable buttons during processing
		function disableButtons() {
			const sendBtn = document.getElementById('sendBtn');
			if (sendBtn) sendBtn.disabled = true;
		}

		function enableButtons() {
			const sendBtn = document.getElementById('sendBtn');
			if (sendBtn) sendBtn.disabled = false;
		}

		// Copy message content function
		function copyMessageContent(messageDiv) {
			const contentDiv = messageDiv.querySelector('.message-content');
			if (contentDiv) {
				// Get text content, preserving line breaks
				const text = contentDiv.innerText || contentDiv.textContent;

				// Copy to clipboard
				navigator.clipboard.writeText(text).then(() => {
					// Show brief feedback
					const copyBtn = messageDiv.querySelector('.copy-btn');
					const originalHtml = copyBtn.innerHTML;
					copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
					copyBtn.style.color = '#4caf50';

					setTimeout(() => {
						copyBtn.innerHTML = originalHtml;
						copyBtn.style.color = '';
					}, 1000);
				}).catch(err => {
					console.error('Failed to copy message:', err);
				});
			}
		}

		function copyCodeBlock(codeId) {
			const codeElement = document.getElementById(codeId);
			if (codeElement) {
				const rawCode = codeElement.getAttribute('data-raw-code');
				if (rawCode) {
					// Decode HTML entities
					const decodedCode = rawCode.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
					navigator.clipboard.writeText(decodedCode).then(() => {
						// Show temporary feedback
						const copyBtn = codeElement.closest('.code-block-container').querySelector('.code-copy-btn');
						if (copyBtn) {
							const originalInnerHTML = copyBtn.innerHTML;
							copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
							copyBtn.style.color = '#4caf50';
							setTimeout(() => {
								copyBtn.innerHTML = originalInnerHTML;
								copyBtn.style.color = '';
							}, 1000);
						}
					}).catch(err => {
						console.error('Failed to copy code:', err);
					});
				}
			}
		}

		window.addEventListener('message', event => {
			const message = event.data;

			switch (message.type) {
				case 'ready':
					addMessage(message.data, 'system');
					updateStatusWithTotals();
					break;

				case 'restoreInputText':
					const inputField = document.getElementById('messageInput');
					if (inputField && message.data) {
						inputField.value = message.data;
						// Auto-resize the textarea
						inputField.style.height = 'auto';
						inputField.style.height = Math.min(inputField.scrollHeight, 200) + 'px';
					}
					break;

				case 'output':
					if (message.data.trim()) {
						let displayData = message.data;

						// Check if this is a usage limit message with Unix timestamp
						const usageLimitMatch = displayData.match(/Claude AI usage limit reached\|(\d+)/);
						if (usageLimitMatch) {
							const timestamp = parseInt(usageLimitMatch[1]);
							const date = new Date(timestamp * 1000);
							const readableDate = date.toLocaleString(
								undefined,
								{
									weekday: 'short',
									month: 'short',
									day: 'numeric',
									hour: 'numeric',
									minute: '2-digit',
									second: '2-digit',
									hour12: true,
									timeZoneName: 'short',
									year: 'numeric'
								}
							);
							displayData = displayData.replace(usageLimitMatch[0], `Claude AI usage limit reached: ${readableDate}`);
						}

						addMessage(parseSimpleMarkdown(displayData), 'claude');
					}
					updateStatusWithTotals();
					break;

				case 'userInput':
					if (message.data.trim()) {
						addMessage(parseSimpleMarkdown(message.data), 'user');
					}
					break;

				case 'loading':
					addMessage(message.data, 'system');
					updateStatusWithTotals();
					break;

				case 'setProcessing':
					isProcessing = message.data.isProcessing;
					if (isProcessing) {
						startRequestTimer(message.data.requestStartTime);
						showStopButton();
						disableButtons();
						showProcessingIndicator();
						updateAgentHeader('Agent 1', 'running');
					} else {
						stopRequestTimer();
						hideStopButton();
						enableButtons();
						hideProcessingIndicator();
						updateAgentHeader('Agent 1', 'idle');
					}
					updateStatusWithTotals();
					break;

				case 'clearLoading':
					// Remove the last loading message
					const messages = messagesDiv.children;
					if (messages.length > 0) {
						const lastMessage = messages[messages.length - 1];
						if (lastMessage.classList.contains('system')) {
							lastMessage.remove();
						}
					}
					updateStatusWithTotals();
					break;

				case 'error':
					if (message.data.trim()) {
						// Check if this is an install required error
						if (message.data.includes('Install claude code first') ||
							message.data.includes('command not found') ||
							message.data.includes('ENOENT')) {
							sendStats('Install required');
						}
						addMessage(message.data, 'error');
					}
					updateStatusWithTotals();
					break;

				case 'toolUse':
					if (typeof message.data === 'object') {
						addToolUseMessage(message.data);
					} else if (message.data.trim()) {
						addMessage(message.data, 'tool');
					}
					break;

				case 'toolResult':
					addToolResultMessage(message.data);
					break;

				case 'thinking':
					if (message.data.trim()) {
						addMessage(' Thinking...' + parseSimpleMarkdown(message.data), 'thinking');
					}
					break;

				case 'sessionInfo':
					if (message.data.sessionId) {
						showSessionInfo(message.data.sessionId);
						// Show detailed session information
						const sessionDetails = [
							` Session ID: ${message.data.sessionId}`,
							` Tools Available: ${message.data.tools.length}`,
							` MCP Servers: ${message.data.mcpServers ? message.data.mcpServers.length : 0}`
						];
						//addMessage(sessionDetails.join('\n'), 'system');
					}
					break;

				case 'imagePath':
					// Handle image file path response
					if (message.data.filePath) {
						// Get current cursor position and content
						const cursorPosition = messageInput.selectionStart || messageInput.value.length;
						const currentValue = messageInput.value || '';

						// Insert the file path at the current cursor position
						const textBefore = currentValue.substring(0, cursorPosition);
						const textAfter = currentValue.substring(cursorPosition);

						// Add a space before the path if there's text before and it doesn't end with whitespace
						const separator = (textBefore && !textBefore.endsWith(' ') && !textBefore.endsWith('\n')) ? ' ' : '';

						messageInput.value = textBefore + separator + message.data.filePath + textAfter;

						// Move cursor to end of inserted path
						const newCursorPosition = cursorPosition + separator.length + message.data.filePath.length;
						messageInput.setSelectionRange(newCursorPosition, newCursorPosition);

						// Focus back on textarea and adjust height
						messageInput.focus();
						adjustTextareaHeight();

						console.log('Inserted image path:', message.data.filePath);
						console.log('Full textarea value:', messageInput.value);
					}
					break;

				case 'updateTokens':
					// Update token totals in real-time
					totalTokensInput = message.data.totalTokensInput || 0;
					totalTokensOutput = message.data.totalTokensOutput || 0;

					// Update status bar immediately
					updateStatusWithTotals();

					// Show detailed token breakdown for current message
					const currentTotal = (message.data.currentInputTokens || 0) + (message.data.currentOutputTokens || 0);
					if (currentTotal > 0) {
						let tokenBreakdown = ` Tokens: ${currentTotal.toLocaleString()}`;

						if (message.data.cacheCreationTokens || message.data.cacheReadTokens) {
							const cacheInfo = [];
							if (message.data.cacheCreationTokens) cacheInfo.push(`${message.data.cacheCreationTokens.toLocaleString()} cache created`);
							if (message.data.cacheReadTokens) cacheInfo.push(`${message.data.cacheReadTokens.toLocaleString()} cache read`);
							tokenBreakdown += `  ${cacheInfo.join('  ')}`;
						}

						addMessage(tokenBreakdown, 'system');
					}
					break;

				case 'updateTotals':
					// Update local tracking variables
					totalCost = message.data.totalCost || 0;
					totalTokensInput = message.data.totalTokensInput || 0;
					totalTokensOutput = message.data.totalTokensOutput || 0;
					requestCount = message.data.requestCount || 0;

					// Update status bar with new totals
					updateStatusWithTotals();

					// Show current request info if available (only for API users)
					if (!subscriptionType && (message.data.currentCost || message.data.currentDuration)) {
						const currentCostStr = message.data.currentCost ? `$${message.data.currentCost.toFixed(4)}` : 'N/A';
						const currentDurationStr = message.data.currentDuration ? `${message.data.currentDuration}ms` : 'N/A';
						addMessage(`Request completed - Cost: ${currentCostStr}, Duration: ${currentDurationStr}`, 'system');
					}
					break;

				case 'accountInfo':
					// Store subscription type to determine cost vs plan display
					subscriptionType = message.data.subscriptionType || null;
					console.log('Account info received:', subscriptionType);
					// Update status bar to reflect plan type
					updateStatusWithTotals();
					break;

				case 'sessionResumed':
					console.log('Session resumed:', message.data);
					showSessionInfo(message.data.sessionId);
					addMessage(` Resumed previous session\n Session ID: ${message.data.sessionId}\n Your conversation history is preserved`, 'system');
					break;

				case 'sessionCleared':
					console.log('Session cleared');
					// Clear all messages from UI
					messagesDiv.innerHTML = '';
					hideSessionInfo();
					addMessage(' Started new session', 'system');
					// Reset totals
					totalCost = 0;
					totalTokensInput = 0;
					totalTokensOutput = 0;
					requestCount = 0;
					updateStatusWithTotals();
					break;

				case 'compacting':
					if (message.data.isCompacting) {
						addMessage(' Compacting conversation...', 'system');
					}
					break;

				case 'compactBoundary':
					// Reset token counts since conversation was compacted
					totalTokensInput = 0;
					totalTokensOutput = 0;
					updateStatusWithTotals();

					const preTokens = message.data.preTokens ? message.data.preTokens.toLocaleString() : 'unknown';
					addMessage(' Compacted (' + preTokens + ' tokens  summary)', 'system');
					break;

				case 'loginRequired':
					sendStats('Login required');
					addMessage(' Login Required\n\nPlease login with your Claude plan (Pro/Max) or API key.\nA terminal has been opened - follow the login process there.\n\nAfter logging in, come back to this chat to continue.', 'error');
					updateStatus('Login Required', 'error');
					break;

				case 'showInstallModal':
					sendStats('Claude not installed');
					showInstallModal();
					updateStatus('Claude Code not installed', 'error');
					break;

				case 'installComplete':
					handleInstallComplete(message.success, message.error);
					if (message.success) {
						updateStatus('Ready', 'success');
					}
					break;

				case 'showRestoreOption':
					showRestoreContainer(message.data);
					break;

				case 'restoreProgress':
					addMessage(' ' + message.data, 'system');
					break;

				case 'restoreSuccess':
					//hideRestoreContainer(message.data.commitSha);
					addMessage(' ' + message.data.message, 'system');
					break;

				case 'restoreError':
					addMessage(' ' + message.data, 'error');
					break;

				case 'workspaceFiles':
					filteredFiles = message.data;
					selectedFileIndex = -1;
					renderFileList();
					break;

				case 'imagePath':
					// Add the image path to the textarea
					const currentText = messageInput.value;
					const pathIndicator = `@${message.path} `;
					messageInput.value = currentText + pathIndicator;
					messageInput.focus();
					adjustTextareaHeight();
					break;

				case 'conversationList':
					displayConversationList(message.data);
					break;
				case 'clipboardText':
					handleClipboardText(message.data);
					break;
				case 'modelSelected':
					// Update the UI with the current model
					currentModel = message.model;
					selectModel(message.model, true);
					break;
				case 'terminalOpened':
					// Display notification about checking the terminal
					addMessage(message.data, 'system');
					break;
				case 'permissionRequest':
					addPermissionRequestMessage(message.data);
					break;
				case 'updatePermissionStatus':
					updatePermissionStatus(message.data.id, message.data.status);
					break;
				case 'expirePendingPermissions':
					expireAllPendingPermissions();
					break;
				case 'mcpServers':
					displayMCPServers(message.data);
					break;
				case 'mcpServerSaved':
					loadMCPServers(); // Reload the servers list
					addMessage(' MCP server "' + message.data.name + '" saved successfully', 'system');
					break;
				case 'mcpServerDeleted':
					loadMCPServers(); // Reload the servers list
					addMessage(' MCP server "' + message.data.name + '" deleted successfully', 'system');
					break;
				case 'mcpServerError':
					addMessage(' Error with MCP server: ' + message.data.error, 'error');
					break;
			}
		});

		// Permission request functions
		function addPermissionRequestMessage(data) {
			// Try to use toolApprovalArea first (command center layout), fallback to messages
			const toolApprovalArea = document.getElementById('toolApprovalArea');
			const targetDiv = toolApprovalArea || document.getElementById('messages');
			const shouldScroll = toolApprovalArea ? false : shouldAutoScroll(targetDiv);

			const messageDiv = document.createElement('div');
			messageDiv.className = 'message permission-request';
			messageDiv.id = `permission-${data.id}`;
			messageDiv.dataset.status = data.status || 'pending';

			const toolName = data.tool || 'Unknown Tool';
			const status = data.status || 'pending';

			// Create always allow button text with command styling for Bash
			let alwaysAllowText = `Always allow ${toolName}`;
			let alwaysAllowTooltip = '';
			if (toolName === 'Bash' && data.pattern) {
				const pattern = data.pattern;
				// Remove the asterisk for display - show "npm i" instead of "npm i *"
				const displayPattern = pattern.replace(' *', '');
				const truncatedPattern = displayPattern.length > 30 ? displayPattern.substring(0, 30) + '...' : displayPattern;
				alwaysAllowText = `Always allow <code>${truncatedPattern}</code>`;
				alwaysAllowTooltip = displayPattern.length > 30 ? `title="${displayPattern}"` : '';
			}

			// Show different content based on status
			let contentHtml = '';
			if (status === 'pending') {
				contentHtml = `
					<div class="permission-header">
						<span class="icon"></span>
						<span>Permission Required</span>
						<div class="permission-menu">
							<button class="permission-menu-btn" onclick="togglePermissionMenu('${data.id}')" title="More options"></button>
							<div class="permission-menu-dropdown" id="permissionMenu-${data.id}" style="display: none;">
								<button class="permission-menu-item" onclick="enableYoloMode('${data.id}')">
									<span class="menu-icon"></span>
									<div class="menu-content">
										<span class="menu-title">Enable YOLO Mode</span>
										<span class="menu-subtitle">Auto-allow all permissions</span>
									</div>
								</button>
							</div>
						</div>
					</div>
					<div class="permission-content">
						<p>Allow <strong>${toolName}</strong> to execute the tool call above?</p>
						<div class="permission-buttons">
							<button class="btn deny" onclick="respondToPermission('${data.id}', false)">Deny</button>
							<button class="btn always-allow" onclick="respondToPermission('${data.id}', true, true)" ${alwaysAllowTooltip}>${alwaysAllowText}</button>
							<button class="btn allow" onclick="respondToPermission('${data.id}', true)">Allow</button>
						</div>
					</div>
				`;
			} else if (status === 'approved') {
				contentHtml = `
					<div class="permission-header">
						<span class="icon"></span>
						<span>Permission Required</span>
					</div>
					<div class="permission-content">
						<p>Allow <strong>${toolName}</strong> to execute the tool call above?</p>
						<div class="permission-decision allowed"> You allowed this</div>
					</div>
				`;
				messageDiv.classList.add('permission-decided', 'allowed');
			} else if (status === 'denied') {
				contentHtml = `
					<div class="permission-header">
						<span class="icon"></span>
						<span>Permission Required</span>
					</div>
					<div class="permission-content">
						<p>Allow <strong>${toolName}</strong> to execute the tool call above?</p>
						<div class="permission-decision denied"> You denied this</div>
					</div>
				`;
				messageDiv.classList.add('permission-decided', 'denied');
			} else if (status === 'cancelled' || status === 'expired') {
				contentHtml = `
					<div class="permission-header">
						<span class="icon"></span>
						<span>Permission Required</span>
					</div>
					<div class="permission-content">
						<p>Allow <strong>${toolName}</strong> to execute the tool call above?</p>
						<div class="permission-decision expired"> This request expired</div>
					</div>
				`;
				messageDiv.classList.add('permission-decided', 'expired');
			}

			messageDiv.innerHTML = contentHtml;
			targetDiv.appendChild(messageDiv);
			// Only scroll if using fallback messages div
			if (!toolApprovalArea) {
				scrollToBottomIfNeeded(targetDiv, shouldScroll);
			}
		}

		function updatePermissionStatus(id, status) {
			const permissionMsg = document.getElementById(`permission-${id}`);
			if (!permissionMsg) return;

			permissionMsg.dataset.status = status;
			const permissionContent = permissionMsg.querySelector('.permission-content');
			const buttons = permissionMsg.querySelector('.permission-buttons');
			const menuDiv = permissionMsg.querySelector('.permission-menu');

			// Hide buttons and menu if present
			if (buttons) buttons.style.display = 'none';
			if (menuDiv) menuDiv.style.display = 'none';

			// Remove existing decision div if any
			const existingDecision = permissionContent.querySelector('.permission-decision');
			if (existingDecision) existingDecision.remove();

			// Add new decision div
			const decisionDiv = document.createElement('div');
			if (status === 'approved') {
				decisionDiv.className = 'permission-decision allowed';
				decisionDiv.innerHTML = ' You allowed this';
				permissionMsg.classList.add('permission-decided', 'allowed');
			} else if (status === 'denied') {
				decisionDiv.className = 'permission-decision denied';
				decisionDiv.innerHTML = ' You denied this';
				permissionMsg.classList.add('permission-decided', 'denied');
			} else if (status === 'cancelled' || status === 'expired') {
				decisionDiv.className = 'permission-decision expired';
				decisionDiv.innerHTML = ' This request expired';
				permissionMsg.classList.add('permission-decided', 'expired');
			}
			permissionContent.appendChild(decisionDiv);
		}

		function expireAllPendingPermissions() {
			document.querySelectorAll('.permission-request').forEach(permissionMsg => {
				if (permissionMsg.dataset.status === 'pending') {
					const id = permissionMsg.id.replace('permission-', '');
					updatePermissionStatus(id, 'expired');
				}
			});
		}

		function respondToPermission(id, approved, alwaysAllow = false) {
			// Send response back to extension
			vscode.postMessage({
				type: 'permissionResponse',
				id: id,
				approved: approved,
				alwaysAllow: alwaysAllow
			});

			// Update the UI to show the decision
			const permissionMsg = document.querySelector(`.permission-request:has([onclick*="${id}"])`);
			if (permissionMsg) {
				const buttons = permissionMsg.querySelector('.permission-buttons');
				const permissionContent = permissionMsg.querySelector('.permission-content');
				let decision = approved ? 'You allowed this' : 'You denied this';

				if (alwaysAllow && approved) {
					decision = 'You allowed this and set it to always allow';
				}

				const emoji = approved ? '' : '';
				const decisionClass = approved ? 'allowed' : 'denied';

				// Hide buttons
				buttons.style.display = 'none';

				// Add decision div to permission-content
				const decisionDiv = document.createElement('div');
				decisionDiv.className = `permission-decision ${decisionClass}`;
				decisionDiv.innerHTML = `${emoji} ${decision}`;
				permissionContent.appendChild(decisionDiv);

				permissionMsg.classList.add('permission-decided', decisionClass);
			}
		}

		function togglePermissionMenu(permissionId) {
			const menu = document.getElementById(`permissionMenu-${permissionId}`);
			const isVisible = menu.style.display !== 'none';

			// Close all other permission menus
			document.querySelectorAll('.permission-menu-dropdown').forEach(dropdown => {
				dropdown.style.display = 'none';
			});

			// Toggle this menu
			menu.style.display = isVisible ? 'none' : 'block';
		}

		function enableYoloMode(permissionId) {
			sendStats('YOLO mode enabled');

			// Hide the menu
			document.getElementById(`permissionMenu-${permissionId}`).style.display = 'none';

			// Send message to enable YOLO mode
			vscode.postMessage({
				type: 'enableYoloMode'
			});

			// Auto-approve this permission
			respondToPermission(permissionId, true);

			// Show notification
			addMessage(' YOLO Mode enabled! All future permissions will be automatically allowed.', 'system');
		}

		// Close permission menus when clicking outside
		document.addEventListener('click', function (event) {
			if (!event.target.closest('.permission-menu')) {
				document.querySelectorAll('.permission-menu-dropdown').forEach(dropdown => {
					dropdown.style.display = 'none';
				});
			}
		});

		// Session management functions
		function newSession() {
			sendStats('New chat');

			vscode.postMessage({
				type: 'newSession'
			});
		}

		function restoreToCommit(commitSha) {
			console.log('Restore button clicked for commit:', commitSha);
			vscode.postMessage({
				type: 'restoreCommit',
				commitSha: commitSha
			});
		}

		function showRestoreContainer(data) {
			const messagesDiv = document.getElementById('messages');
			const shouldScroll = shouldAutoScroll(messagesDiv);

			const restoreContainer = document.createElement('div');
			restoreContainer.className = 'restore-container';
			restoreContainer.id = `restore-${data.sha}`;

			const timeAgo = new Date(data.timestamp).toLocaleTimeString();
			const shortSha = data.sha ? data.sha.substring(0, 8) : 'unknown';

			restoreContainer.innerHTML = `
				<button class="restore-btn dark" onclick="restoreToCommit('${data.sha}')">
					Restore checkpoint
				</button>
				<span class="restore-date">${timeAgo}</span>
			`;

			messagesDiv.appendChild(restoreContainer);
			scrollToBottomIfNeeded(messagesDiv, shouldScroll);
		}

		function hideRestoreContainer(commitSha) {
			const container = document.getElementById(`restore-${commitSha}`);
			if (container) {
				container.remove();
			}
		}

		function showSessionInfo(sessionId) {
			// const sessionInfo = document.getElementById('sessionInfo');
			// const sessionIdSpan = document.getElementById('sessionId');
			const sessionStatus = document.getElementById('sessionStatus');
			const newSessionBtn = document.getElementById('newSessionBtn');
			const historyBtn = document.getElementById('historyBtn');

			if (sessionStatus && newSessionBtn) {
				// sessionIdSpan.textContent = sessionId.substring(0, 8);
				// sessionIdSpan.title = `Full session ID: ${sessionId} (click to copy)`;
				// sessionIdSpan.style.cursor = 'pointer';
				// sessionIdSpan.onclick = () => copySessionId(sessionId);
				// sessionInfo.style.display = 'flex';
				sessionStatus.style.display = 'none';
				newSessionBtn.style.display = 'block';
				if (historyBtn) historyBtn.style.display = 'block';
			}
		}

		function copySessionId(sessionId) {
			navigator.clipboard.writeText(sessionId).then(() => {
				// Show temporary feedback
				const sessionIdSpan = document.getElementById('sessionId');
				if (sessionIdSpan) {
					const originalText = sessionIdSpan.textContent;
					sessionIdSpan.textContent = 'Copied!';
					setTimeout(() => {
						sessionIdSpan.textContent = originalText;
					}, 1000);
				}
			}).catch(err => {
				console.error('Failed to copy session ID:', err);
			});
		}

		function hideSessionInfo() {
			// const sessionInfo = document.getElementById('sessionInfo');
			const sessionStatus = document.getElementById('sessionStatus');
			const newSessionBtn = document.getElementById('newSessionBtn');
			const historyBtn = document.getElementById('historyBtn');

			if (sessionStatus && newSessionBtn) {
				// sessionInfo.style.display = 'none';
				sessionStatus.style.display = 'none';

				// Always show new session
				newSessionBtn.style.display = 'block';
				// Keep history button visible - don't hide it
				if (historyBtn) historyBtn.style.display = 'block';
			}
		}

		updateStatus('Initializing...', 'disconnected');


		function parseSimpleMarkdown(markdown) {
			// First, handle code blocks before line-by-line processing
			let processedMarkdown = markdown;

			// Store code blocks temporarily to protect them from further processing
			const codeBlockPlaceholders = [];

			// Handle multi-line code blocks with triple backticks
			// Using RegExp constructor to avoid backtick conflicts in template literal
			const codeBlockRegex = new RegExp('\`\`\`(\\w*)\n([\\s\\S]*?)\`\`\`', 'g');
			processedMarkdown = processedMarkdown.replace(codeBlockRegex, function (match, lang, code) {
				const language = lang || 'plaintext';
				// Process code line by line to preserve formatting like diff implementation
				const codeLines = code.split('\n');
				let codeHtml = '';

				for (const line of codeLines) {
					const escapedLine = escapeHtml(line);
					codeHtml += '<div class="code-line">' + escapedLine + '</div>';
				}

				// Create unique ID for this code block
				const codeId = 'code_' + Math.random().toString(36).substr(2, 9);
				const escapedCode = escapeHtml(code);

				const codeBlockHtml = '<div class="code-block-container"><div class="code-block-header"><span class="code-block-language">' + language + '</span><button class="code-copy-btn" onclick="copyCodeBlock(\'' + codeId + '\')" title="Copy code"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div><pre class="code-block"><code class="language-' + language + '" id="' + codeId + '" data-raw-code="' + escapedCode.replace(/"/g, '&quot;') + '">' + codeHtml + '</code></pre></div>';

				// Store the code block and return a placeholder
				const placeholder = '__CODEBLOCK_' + codeBlockPlaceholders.length + '__';
				codeBlockPlaceholders.push(codeBlockHtml);
				return placeholder;
			});

			// Handle inline code with single backticks
			const inlineCodeRegex = new RegExp('\`([^\`]+)\`', 'g');
			processedMarkdown = processedMarkdown.replace(inlineCodeRegex, '<code>$1</code>');

			const lines = processedMarkdown.split('\n');
			let html = '';
			let inUnorderedList = false;
			let inOrderedList = false;

			for (let line of lines) {
				line = line.trim();

				// Check if this is a code block placeholder
				if (line.startsWith('__CODEBLOCK_') && line.endsWith('__')) {
					// This is a code block placeholder, don't process it
					html += line;
					continue;
				}

				// Bold
				line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

				// Italic - only apply when underscores are surrounded by whitespace or at beginning/end
				line = line.replace(/(?<!\*)\*(?!\*)(.*?)\*(?!\*)/g, '<em>$1</em>');
				line = line.replace(/(^|\s)_([^_\s][^_]*[^_\s]|[^_\s])_(?=\s|$)/g, '$1<em>$2</em>');

				// Headers
				if (/^####\s+/.test(line)) {
					html += '<h4>' + line.replace(/^####\s+/, '') + '</h4>';
					continue;
				} else if (/^###\s+/.test(line)) {
					html += '<h3>' + line.replace(/^###\s+/, '') + '</h3>';
					continue;
				} else if (/^##\s+/.test(line)) {
					html += '<h2>' + line.replace(/^##\s+/, '') + '</h2>';
					continue;
				} else if (/^#\s+/.test(line)) {
					html += '<h1>' + line.replace(/^#\s+/, '') + '</h1>';
					continue;
				}

				// Ordered list
				if (/^\d+\.\s+/.test(line)) {
					if (!inOrderedList) {
						html += '<ol>';
						inOrderedList = true;
					}
					const item = line.replace(/^\d+\.\s+/, '');
					html += '<li>' + item + '</li>';
					continue;
				}

				// Unordered list
				if (line.startsWith('- ')) {
					if (!inUnorderedList) {
						html += '<ul>';
						inUnorderedList = true;
					}
					html += '<li>' + line.slice(2) + '</li>';
					continue;
				}

				// Close lists
				if (inUnorderedList) {
					html += '</ul>';
					inUnorderedList = false;
				}
				if (inOrderedList) {
					html += '</ol>';
					inOrderedList = false;
				}

				// Paragraph or break
				if (line !== '') {
					html += '<p>' + line + '</p>';
				} else {
					html += '<br>';
				}
			}

			if (inUnorderedList) html += '</ul>';
			if (inOrderedList) html += '</ol>';

			// Restore code block placeholders
			for (let i = 0; i < codeBlockPlaceholders.length; i++) {
				const placeholder = '__CODEBLOCK_' + i + '__';
				html = html.replace(placeholder, codeBlockPlaceholders[i]);
			}

			return html;
		}

		// Conversation history functions
		function toggleConversationHistory() {
			const historyDiv = document.getElementById('conversationHistory');
			const chatContainer = document.getElementById('chatContainer');

			if (historyDiv.style.display === 'none') {
				sendStats('History opened');
				// Show conversation history
				requestConversationList();
				historyDiv.style.display = 'block';
				chatContainer.style.display = 'none';
			} else {
				// Hide conversation history
				historyDiv.style.display = 'none';
				chatContainer.style.display = 'flex';
			}
		}

		function requestConversationList() {
			vscode.postMessage({
				type: 'getConversationList'
			});
		}

		function loadConversation(filename) {
			vscode.postMessage({
				type: 'loadConversation',
				filename: filename
			});

			// Hide conversation history and show chat
			toggleConversationHistory();
		}

		// File picker functions
		function showFilePicker() {
			// Request initial file list from VS Code
			vscode.postMessage({
				type: 'getWorkspaceFiles',
				searchTerm: ''
			});

			// Show modal
			filePickerModal.style.display = 'flex';
			fileSearchInput.focus();
			selectedFileIndex = -1;
		}

		function hideFilePicker() {
			filePickerModal.style.display = 'none';
			fileSearchInput.value = '';
			selectedFileIndex = -1;
		}

		function getFileIcon(filename) {
			const ext = filename.split('.').pop()?.toLowerCase();
			switch (ext) {
				case 'js': case 'jsx': case 'ts': case 'tsx': return '';
				case 'html': case 'htm': return '';
				case 'css': case 'scss': case 'sass': return '';
				case 'json': return '';
				case 'md': return '';
				case 'py': return '';
				case 'java': return '';
				case 'cpp': case 'c': case 'h': return '';
				case 'png': case 'jpg': case 'jpeg': case 'gif': case 'svg': return '';
				case 'pdf': return '';
				case 'zip': case 'tar': case 'gz': return '';
				default: return '';
			}
		}

		function renderFileList() {
			fileList.innerHTML = '';

			filteredFiles.forEach((file, index) => {
				const fileItem = document.createElement('div');
				fileItem.className = 'file-item';
				if (index === selectedFileIndex) {
					fileItem.classList.add('selected');
				}

				fileItem.innerHTML = `
					<span class="file-icon">${getFileIcon(file.name)}</span>
					<div class="file-info">
						<div class="file-name">${file.name}</div>
						<div class="file-path">${file.path}</div>
					</div>
				`;

				fileItem.addEventListener('click', () => {
					selectFile(file);
				});

				fileList.appendChild(fileItem);
			});
		}

		function selectFile(file) {
			// Insert file path at cursor position
			const cursorPos = messageInput.selectionStart;
			const textBefore = messageInput.value.substring(0, cursorPos);
			const textAfter = messageInput.value.substring(cursorPos);

			// Replace the @ symbol with the file path
			const beforeAt = textBefore.substring(0, textBefore.lastIndexOf('@'));
			const newText = beforeAt + '@' + file.path + ' ' + textAfter;

			messageInput.value = newText;
			messageInput.focus();

			// Set cursor position after the inserted path
			const newCursorPos = beforeAt.length + file.path.length + 2;
			messageInput.setSelectionRange(newCursorPos, newCursorPos);

			hideFilePicker();
			adjustTextareaHeight();
		}

		function filterFiles(searchTerm) {
			// Send search request to backend instead of filtering locally
			vscode.postMessage({
				type: 'getWorkspaceFiles',
				searchTerm: searchTerm
			});
			selectedFileIndex = -1;
		}

		// Image handling functions
		function selectImage() {
			// Use VS Code's native file picker instead of browser file picker
			vscode.postMessage({
				type: 'selectImageFile'
			});
		}


		function showImageAddedFeedback(fileName) {
			// Create temporary feedback element
			const feedback = document.createElement('div');
			feedback.textContent = `Added: ${fileName}`;
			feedback.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				background: var(--vscode-notifications-background);
				color: var(--vscode-notifications-foreground);
				padding: 8px 12px;
				border-radius: 4px;
				font-size: 12px;
				z-index: 1000;
				opacity: 0;
				transition: opacity 0.3s ease;
			`;

			document.body.appendChild(feedback);

			// Animate in
			setTimeout(() => feedback.style.opacity = '1', 10);

			// Animate out and remove
			setTimeout(() => {
				feedback.style.opacity = '0';
				setTimeout(() => feedback.remove(), 300);
			}, 2000);
		}

		function displayConversationList(conversations) {
			const listDiv = document.getElementById('conversationList');
			listDiv.innerHTML = '';

			if (conversations.length === 0) {
				listDiv.innerHTML = '<p style="text-align: center; color: var(--vscode-descriptionForeground);">No conversations found</p>';
				return;
			}

			conversations.forEach(conv => {
				const item = document.createElement('div');
				item.className = 'conversation-item';
				item.onclick = () => loadConversation(conv.filename);

				const date = new Date(conv.startTime).toLocaleDateString();
				const time = new Date(conv.startTime).toLocaleTimeString();

				// Show plan type or cost based on subscription
				let usageStr;
				if (subscriptionType) {
					let planName = subscriptionType.replace(/^claude\s*/i, '').trim();
					planName = planName.charAt(0).toUpperCase() + planName.slice(1);
					usageStr = planName;
				} else {
					usageStr = `$${conv.totalCost.toFixed(3)}`;
				}

				item.innerHTML = `
					<div class="conversation-title">${conv.firstUserMessage.substring(0, 60)}${conv.firstUserMessage.length > 60 ? '...' : ''}</div>
					<div class="conversation-meta">${date} at ${time}  ${conv.messageCount} messages  ${usageStr}</div>
					<div class="conversation-preview">Last: ${conv.lastUserMessage.substring(0, 80)}${conv.lastUserMessage.length > 80 ? '...' : ''}</div>
				`;

				listDiv.appendChild(item);
			});
		}

		function handleClipboardText(text) {
			if (!text) return;

			// Insert text at cursor position
			const start = messageInput.selectionStart;
			const end = messageInput.selectionEnd;
			const currentValue = messageInput.value;

			const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
			messageInput.value = newValue;

			// Set cursor position after pasted text
			const newCursorPos = start + text.length;
			messageInput.setSelectionRange(newCursorPos, newCursorPos);

			// Trigger input event to adjust height
			messageInput.dispatchEvent(new Event('input', { bubbles: true }));
		}

		// Settings functions

		function toggleSettings() {
			const settingsModal = document.getElementById('settingsModal');
			if (settingsModal.style.display === 'none') {
				// Request current settings from VS Code
				vscode.postMessage({
					type: 'getSettings'
				});
				// Request current permissions
				vscode.postMessage({
					type: 'getPermissions'
				});
				settingsModal.style.display = 'flex';
			} else {
				hideSettingsModal();
			}
		}

		function hideSettingsModal() {
			document.getElementById('settingsModal').style.display = 'none';
		}

		function updateSettings() {
			// Note: thinking intensity is now handled separately in the thinking intensity modal

			const wslEnabled = document.getElementById('wsl-enabled').checked;
			const wslDistro = document.getElementById('wsl-distro').value;
			const wslNodePath = document.getElementById('wsl-node-path').value;
			const wslClaudePath = document.getElementById('wsl-claude-path').value;
			const yoloMode = document.getElementById('yolo-mode').checked;

			// Update WSL options visibility
			document.getElementById('wslOptions').style.display = wslEnabled ? 'block' : 'none';

			// Send settings to VS Code immediately
			vscode.postMessage({
				type: 'updateSettings',
				settings: {
					'wsl.enabled': wslEnabled,
					'wsl.distro': wslDistro || 'Ubuntu',
					'wsl.nodePath': wslNodePath || '/usr/bin/node',
					'wsl.claudePath': wslClaudePath || '/usr/local/bin/claude',
					'permissions.yoloMode': yoloMode
				}
			});
		}

		// Permissions management functions
		function renderPermissions(permissions) {
			const permissionsList = document.getElementById('permissionsList');

			if (!permissions || !permissions.alwaysAllow || Object.keys(permissions.alwaysAllow).length === 0) {
				permissionsList.innerHTML = `
					<div class="permissions-empty">
						No always-allow permissions set
					</div>
				`;
				return;
			}

			let html = '';

			for (const [toolName, permission] of Object.entries(permissions.alwaysAllow)) {
				if (permission === true) {
					// Tool is always allowed
					html += `
						<div class="permission-item">
							<div class="permission-info">
								<span class="permission-tool">${toolName}</span>
								<span class="permission-desc">All</span>
							</div>
							<button class="permission-remove-btn" onclick="removePermission('${toolName}', null)">Remove</button>
						</div>
					`;
				} else if (Array.isArray(permission)) {
					// Tool has specific commands/patterns
					for (const command of permission) {
						const displayCommand = command.replace(' *', ''); // Remove asterisk for display
						html += `
							<div class="permission-item">
								<div class="permission-info">
									<span class="permission-tool">${toolName}</span>
									<span class="permission-command"><code>${displayCommand}</code></span>
								</div>
								<button class="permission-remove-btn" onclick="removePermission('${toolName}', '${escapeHtml(command)}')">Remove</button>
							</div>
						`;
					}
				}
			}

			permissionsList.innerHTML = html;
		}

		function removePermission(toolName, command) {
			vscode.postMessage({
				type: 'removePermission',
				toolName: toolName,
				command: command
			});
		}

		function showAddPermissionForm() {
			document.getElementById('showAddPermissionBtn').style.display = 'none';
			document.getElementById('addPermissionForm').style.display = 'block';

			// Focus on the tool select dropdown
			setTimeout(() => {
				document.getElementById('addPermissionTool').focus();
			}, 100);
		}

		function hideAddPermissionForm() {
			document.getElementById('showAddPermissionBtn').style.display = 'flex';
			document.getElementById('addPermissionForm').style.display = 'none';

			// Clear form inputs
			document.getElementById('addPermissionTool').value = '';
			document.getElementById('addPermissionCommand').value = '';
			document.getElementById('addPermissionCommand').style.display = 'none';
		}

		function toggleCommandInput() {
			const toolSelect = document.getElementById('addPermissionTool');
			const commandInput = document.getElementById('addPermissionCommand');
			const hintDiv = document.getElementById('permissionsFormHint');

			if (toolSelect.value === 'Bash') {
				commandInput.style.display = 'block';
				hintDiv.textContent = 'Use patterns like "npm i *" or "git add *" for specific commands.';
			} else if (toolSelect.value === '') {
				commandInput.style.display = 'none';
				commandInput.value = '';
				hintDiv.textContent = 'Select a tool to add always-allow permission.';
			} else {
				commandInput.style.display = 'none';
				commandInput.value = '';
				hintDiv.textContent = 'This will allow all ' + toolSelect.value + ' commands without asking for permission.';
			}
		}

		function addPermission() {
			const toolSelect = document.getElementById('addPermissionTool');
			const commandInput = document.getElementById('addPermissionCommand');
			const addBtn = document.getElementById('addPermissionBtn');

			const toolName = toolSelect.value.trim();
			const command = commandInput.value.trim();

			if (!toolName) {
				return;
			}

			// Disable button during processing
			addBtn.disabled = true;
			addBtn.textContent = 'Adding...';

			vscode.postMessage({
				type: 'addPermission',
				toolName: toolName,
				command: command || null
			});

			// Clear form and hide it
			toolSelect.value = '';
			commandInput.value = '';
			hideAddPermissionForm();

			// Re-enable button
			setTimeout(() => {
				addBtn.disabled = false;
				addBtn.textContent = 'Add';
			}, 500);
		}

		// Close settings modal when clicking outside
		document.getElementById('settingsModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('settingsModal')) {
				hideSettingsModal();
			}
		});

		// Close thinking intensity modal when clicking outside
		document.getElementById('thinkingIntensityModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('thinkingIntensityModal')) {
				hideThinkingIntensityModal();
			}
		});

		// Close slash commands modal when clicking outside
		document.getElementById('slashCommandsModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('slashCommandsModal')) {
				hideSlashCommandsModal();
			}
		});

		// Request custom snippets from VS Code on page load
		vscode.postMessage({
			type: 'getCustomSnippets'
		});

		// ==========================================
		// INLINE SLASH COMMANDS IMPLEMENTATION
		// ==========================================

		const BUILTIN_COMMANDS = [
			// Commands that run in terminal
			{ name: 'add-dir', desc: 'Add additional working directories', type: 'command', icon: '' },
			{ name: 'clear', desc: 'Clear conversation history', type: 'command', icon: '' },
			{ name: 'compact', desc: 'Compact conversation with optional focus', type: 'command', icon: '' },
			{ name: 'config', desc: 'Open the Settings interface', type: 'command', icon: '' },
			{ name: 'cost', desc: 'Show token usage statistics', type: 'command', icon: '' },
			{ name: 'doctor', desc: 'Checks the health of your installation', type: 'command', icon: '' },
			{ name: 'help', desc: 'Get usage help', type: 'command', icon: '' },
			{ name: 'init', desc: 'Initialize project with CLAUDE.md guide', type: 'command', icon: '' },
			{ name: 'login', desc: 'Switch Anthropic accounts', type: 'command', icon: '' },
			{ name: 'logout', desc: 'Sign out from your Anthropic account', type: 'command', icon: '' },
			{ name: 'model', desc: 'Select or change the AI model', type: 'command', icon: '' },
			{ name: 'permissions', desc: 'View or update permissions', type: 'command', icon: '' },
			{ name: 'review', desc: 'Review changes', type: 'command', icon: '' },

			// Prompt Snippets
			{ name: 'performance-analysis', desc: 'Analyze code for performance issues', type: 'snippet', icon: '' },
			{ name: 'security-review', desc: 'Review code for security vulnerabilities', type: 'snippet', icon: '' },
			{ name: 'implementation-review', desc: 'Review the implementation', type: 'snippet', icon: '' },
			{ name: 'code-explanation', desc: 'Explain how this code works', type: 'snippet', icon: '' },
			{ name: 'bug-fix', desc: 'Help me fix this bug', type: 'snippet', icon: '' },
			{ name: 'refactor', desc: 'Refactor code for readability', type: 'snippet', icon: '' },
			{ name: 'test-generation', desc: 'Generate comprehensive tests', type: 'snippet', icon: '' },
			{ name: 'documentation', desc: 'Generate documentation', type: 'snippet', icon: '' },
		];

		let slashMenuSelectedIndex = 0;
		let slashMenuVisible = false;

		function getUnifiedCommands() {
			// Combine built-in and custom snippets
			const customcmds = Object.values(customSnippetsData || {}).map(s => ({
				name: s.name,
				desc: s.prompt,
				type: 'custom',
				icon: '',
				id: s.id
			}));

			return [...customcmds, ...BUILTIN_COMMANDS];
		}

		function renderSlashMenu(filter = '') {
			const menu = document.getElementById('slashCommandMenu');
			if (!menu) return;

			const term = filter.toLowerCase().replace(/^\//, '');

			const allCommands = getUnifiedCommands();
			const filtered = allCommands.filter(c =>
				c.name.toLowerCase().includes(term) ||
				c.desc.toLowerCase().includes(term)
			);

			if (filtered.length === 0) {
				menu.classList.remove('visible');
				slashMenuVisible = false;
				return;
			}

			// Clamp index
			if (slashMenuSelectedIndex >= filtered.length) {
				slashMenuSelectedIndex = filtered.length - 1;
			}
			if (slashMenuSelectedIndex < 0) slashMenuSelectedIndex = 0;

			let html = '';

			filtered.forEach((cmd, index) => {
				const isActive = index === slashMenuSelectedIndex ? 'active' : '';
				const nameArg = cmd.type === 'custom' ? cmd.id : cmd.name;
				html += `
					<div class="slash-menu-item ${isActive}" onclick="selectSlashCommand('${nameArg}', '${cmd.type}')">
						<div class="slash-menu-icon">${cmd.icon}</div>
						<div class="slash-menu-content">
							<div class="slash-menu-title">/${cmd.name}</div>
							<div class="slash-menu-desc">${cmd.desc}</div>
						</div>
						${cmd.type === 'custom' ? '<div class="slash-menu-type" style="font-size:9px; opacity:0.5; margin-left:8px;">CUSTOM</div>' : ''}
					</div>
				`;
			});

			menu.innerHTML = html;
			menu.classList.add('visible');
			slashMenuVisible = true;

			// Adjust scroll position to keep selected item in view
			const activeItem = menu.querySelector('.slash-menu-item.active');
			if (activeItem) {
				activeItem.scrollIntoView({ block: 'nearest' });
			}
		}

		function selectSlashCommand(nameOrId, type) {
			const menu = document.getElementById('slashCommandMenu');
			if (menu) menu.classList.remove('visible');
			slashMenuVisible = false;

			if (type === 'command') {
				executeSlashCommand(nameOrId);
			} else {
				usePromptSnippet(nameOrId);
			}
		}

		// Add event listeners for inline menu navigation
		messageInput.addEventListener('keydown', (e) => {
			if (!slashMenuVisible) return;

			if (e.key === 'ArrowUp') {
				e.preventDefault();
				slashMenuSelectedIndex--;
				renderSlashMenu(messageInput.value);
			} else if (e.key === 'ArrowDown') {
				e.preventDefault();
				slashMenuSelectedIndex++;
				renderSlashMenu(messageInput.value);
			} else if (e.key === 'Enter' || e.key === 'Tab') {
				e.preventDefault();
				const activeItem = document.getElementById('slashCommandMenu').querySelector('.slash-menu-item.active');
				if (activeItem) {
					activeItem.click();
				}
			} else if (e.key === 'Escape') {
				e.preventDefault();
				const menu = document.getElementById('slashCommandMenu');
				if (menu) menu.classList.remove('visible');
				slashMenuVisible = false;
			}
		});

		// Detect slash commands input and render menu
		messageInput.addEventListener('input', (e) => {
			const value = messageInput.value;
			if (value.startsWith('/')) {
				// If just typed /, reset index
				if (value === '/') slashMenuSelectedIndex = 0;
				renderSlashMenu(value);
			} else {
				const menu = document.getElementById('slashCommandMenu');
				if (menu) menu.classList.remove('visible');
				slashMenuVisible = false;
			}
		});

		// Hide when clicking outside
		document.addEventListener('click', (e) => {
			const menu = document.getElementById('slashCommandMenu');
			if (menu && slashMenuVisible && !e.target.closest('.slash-command-menu') && !e.target.closest('#messageInput')) {
				menu.classList.remove('visible');
				slashMenuVisible = false;
			}
		});

		// Add settings message handler to window message event
		const originalMessageHandler = window.onmessage;
		window.addEventListener('message', event => {
			const message = event.data;

			if (message.type === 'customSnippetsData') {
				// Update global custom snippets data
				customSnippetsData = message.data || {};
				// Refresh the snippets display
				loadCustomSnippets(customSnippetsData);
			} else if (message.type === 'customSnippetSaved') {
				// Refresh snippets after saving
				vscode.postMessage({
					type: 'getCustomSnippets'
				});
			} else if (message.type === 'customSnippetDeleted') {
				// Refresh snippets after deletion
				vscode.postMessage({
					type: 'getCustomSnippets'
				});
			} else if (message.type === 'settingsData') {
				// Update UI with current settings
				const thinkingIntensity = message.data['thinking.intensity'] || 'think';
				const intensityValues = ['think', 'think-hard', 'think-harder', 'ultrathink'];
				const sliderValue = intensityValues.indexOf(thinkingIntensity);

				// Update thinking intensity modal if it exists
				const thinkingIntensitySlider = document.getElementById('thinkingIntensitySlider');
				if (thinkingIntensitySlider) {
					thinkingIntensitySlider.value = sliderValue >= 0 ? sliderValue : 0;
					updateThinkingIntensityDisplay(thinkingIntensitySlider.value);
				} else {
					// Update toggle name even if modal isn't open
					updateThinkingModeToggleName(sliderValue >= 0 ? sliderValue : 0);
				}

				document.getElementById('wsl-enabled').checked = message.data['wsl.enabled'] || false;
				document.getElementById('wsl-distro').value = message.data['wsl.distro'] || 'Ubuntu';
				document.getElementById('wsl-node-path').value = message.data['wsl.nodePath'] || '/usr/bin/node';
				document.getElementById('wsl-claude-path').value = message.data['wsl.claudePath'] || '/usr/local/bin/claude';
				document.getElementById('yolo-mode').checked = message.data['permissions.yoloMode'] || false;

				// Update yolo warning visibility
				updateYoloWarning();

				// Show/hide WSL options
				document.getElementById('wslOptions').style.display = message.data['wsl.enabled'] ? 'block' : 'none';
			}

			if (message.type === 'platformInfo') {
				// Check if user is on Windows and show WSL alert if not dismissed and WSL not already enabled
				if (message.data.isWindows && !message.data.wslAlertDismissed && !message.data.wslEnabled) {
					// Small delay to ensure UI is ready
					setTimeout(() => {
						showWSLAlert();
					}, 1000);
				}
			}

			if (message.type === 'permissionsData') {
				// Update permissions UI
				renderPermissions(message.data);
			}
		});

		// Initialize command center UI elements
		updateAgentList([{ id: 'main', name: 'Agent 1', status: 'idle' }]);
		updateAgentHeader('Agent 1', 'idle');

	</script>

	<!--
	Analytics FAQ:

	1. Is Umami GDPR compliant?
	Yes, Umami does not collect any personally identifiable information and anonymizes all data collected. Users cannot be identified and are never tracked across websites.

	2. Do I need to display a cookie notice to users?
	No, Umami does not use any cookies in the tracking code.
	-->
	<!-- Umami analytics disabled due to VS Code telemetry settings -->
</body>

</html>